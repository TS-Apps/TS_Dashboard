<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Cadet Training Dashboard - Cloud</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚓</text></svg>" />
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #f1f5f9; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        /* Planner Table Styles */
        .planner-table th, .planner-table td {
            white-space: nowrap;
        }
        .planner-container {
            overflow-x: auto;
            max-height: 75vh;
        }
        /* Sticky Headers */
        .planner-table thead {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .planner-table th {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* Sticky First Column (Module Titles) */
        .planner-table th:first-child,
        .planner-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 60 !important;
            background-color: #FFFFFF !important;
            border-right: 2px solid #e2e8f0;
        }
        /* Corner Cell (Module / Cadet) fix */
        .planner-table thead tr th:first-child {
            z-index: 70 !important;
            background-color: #f1f5f9 !important;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .bg-passed { background-color: #0DAC50 !important; }
        
        /* Spec Level Colors */
        .spec-basic { background-color: #fdba74 !important; color: #7c2d12; font-weight: 700; font-size: 12px; }
        .spec-int { background-color: #94a3b8 !important; color: #ffffff; font-weight: 700; font-size: 12px; }
        .spec-adv { background-color: #fcd34d !important; color: #78350f; font-weight: 800; font-size: 12px; }
        .spec-junior { background-color: #f1f5f9 !important; color: #94a3b8; font-style: italic; font-size: 11px; }
        .spec-none { color: #cbd5e1; }

        /* Waterborne Status Colors */
        .planner-table td.status-cox-pending { background-color: #add8e6 !important; color: black !important; }
        .planner-table td.status-cox-awarded { background-color: #003366 !important; color: white !important; }
        .planner-table td.status-master-pending { background-color: #ffffe0 !important; color: black !important; }
        .planner-table td.status-master-awarded { background-color: #ffd700 !important; color: black !important; }
        
        /* Progress Chart Checkmarks */
        .bg-red-600 { color: white; font-weight: bold; font-size: 14px; }
        .bg-blue-600 { color: white; font-weight: bold; font-size: 14px; }
        .bg-green-600 { color: white; font-weight: bold; font-size: 14px; }
        .bg-yellow-600 { color: white; font-weight: bold; font-size: 14px; }
        .bg-purple-600 { color: white; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Market Harborough Sea Cadets Training Dashboard
        // Version 4.0.1 - Cloud Edition with Enhanced DOB Validation
        // FIXED: DOB validation, template file detection, clear upload labels
        
        const { useState, useEffect, useMemo, useCallback, useRef, Component } = React;
        
        const DATA_VERSION = "4.0.1-FIXED";
        
        // Validation Functions
        const sanitizeText = (text) => {
            if (!text || typeof text !== 'string') return text;
            return text
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                .replace(/<[^>]+>/g, '')
                .trim();
        };

        const splitCSVLine = (str) => {
            const arr = [];
            let quote = false;
            let col = "";
            for (let c of str) {
                if (c === '"') { quote = !quote; continue; }
                if (c === ',' && !quote) { arr.push(col); col = ""; continue; }
                col += c;
            }
            arr.push(col);
            return arr;
        };
        
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;
            
            const parts = dateStr.split(/[\/\-\s]/);
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const year = parseInt(parts[2]);
                let month = parseInt(parts[1]) - 1; 

                if (isNaN(month)) {
                    const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
                    month = months.findIndex(m => parts[1].toLowerCase().startsWith(m));
                }
                
                if (!isNaN(day) && !isNaN(month) && !isNaN(year) && month >= 0) {
                    d = new Date(year, month, day);
                    if (!isNaN(d.getTime())) return d;
                }
            }
            return null;
        };
        
        const formatDate = (date) => {
            if (!date) return '-';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleDateString('en-GB');
        };
        
        const normalizeRank = (rawRank) => {
            if (!rawRank) return "Unknown";
            const r = rawRank.toLowerCase().trim();

            // Junior Ranks
            if (r === "ljc" || (r.includes("leading") && (r.includes("junior") || r.includes("jnr")))) return "Leading Junior Cadet";
            if (r === "ajc" || (r.includes("able") && (r.includes("junior") || r.includes("jnr")))) return "Able Junior Cadet";
            if (r === "jcfc" || r === "jc1" || ((r.includes("junior") || r.includes("jnr") || r.includes("jc")) && (r.includes("1st") || r.includes("first")))) return "Junior Cadet 1st Class";
            if (r === "jc" || r === "junior cadet" || r.includes("junior") || r.includes("jnr")) return "Junior Cadet";

            // Senior SCC Ranks
            if (r.includes("new entry") || r === "nec") return "New Entry Cadet";
            if (r === "cdt" || r === "cadet") return "Cadet";
            if (r === "cdt 1st" || r.includes("1st class")) return "Cadet 1st Class";
            if (r === "oc" || r === "ordinary cadet" || r.includes("ordinary")) return "Ordinary Cadet";
            if (r === "ac" || r === "able cadet" || r.includes("able")) return "Able Cadet";
            if (r === "lc" || r === "leading cadet" || r.includes("leading")) return "Leading Cadet";
            if (r === "poc" || r === "petty officer cadet") return "Petty Officer Cadet";
            
            // RMC Ranks
            if (r === "mc" || r === "marine cadet" || r === "marine" || r === "royal marine" || 
                r === "mc1" || r === "marine cadet 1st class" || r === "marine cadet 1") return "Marine Cadet"; 
            if (r === "rct" || r === "recruit" || r === "marine recruit" || r.includes("recruit")) return "Recruit";
            if (r === "cdt sgt" || r === "cdt sergeant" || r.includes("cadet sergeant")) return "Cadet Sergeant";
            if (r === "cdt cpl" || r.includes("cadet corporal")) return "Cadet Corporal";
            if (r === "cdt lcpl" || r.includes("cadet lance corporal")) return "Cadet Lance Corporal";

            if (r.includes("lance")) return "Cadet Lance Corporal";
            if (r.includes("corporal") && !r.includes("lance")) return "Cadet Corporal"; 
            
            return rawRank;
        };
        
        const calculateAge = (dob) => {
            if (!dob) return "Unknown";
            const birthDate = parseDate(dob);
            if (!birthDate) return "Unknown";
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        };
        
        // CRITICAL FUNCTION: Detect if CSV is a junior module template
        const isJuniorModuleTemplate = (headers) => {
            const headerLower = headers.map(h => h.toLowerCase());
            // Template has: PNumber, Name, Rank, Age, Section, ModuleCode, DateCompleted
            // It will have "modulecode" or "module code" column
            // It will NOT have "Surname" or "First Name" columns
            
            const hasModuleCode = headerLower.some(h => h.includes('modulecode') || h.includes('module code'));
            const hasSection = headerLower.some(h => h === 'section');
            const hasSurname = headerLower.some(h => h.includes('surname'));
            const hasFirstName = headerLower.some(h => h.includes('first'));
            
            // If it has module code + section but no surname/firstname, it's a template
            return hasModuleCode && hasSection && !hasSurname && !hasFirstName;
        };
        
        // Enhanced File Uploader Component with DOB Validation
        const FileUploader = ({ onDataLoaded, hasData, clearData, wipeAllData }) => {
            const [personnelFile, setPersonnelFile] = useState(null);
            const [qualsFile, setQualsFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showVideoModal, setShowVideoModal] = useState(false);
            const [validationErrors, setValidationErrors] = useState([]);
            const [importSummary, setImportSummary] = useState(null);
            const [preview, setPreview] = useState(null);
            
            // Logo upload states
            const [unitCrestPreview, setUnitCrestPreview] = useState(localStorage.getItem('unit_crest') || null);
            const [sccLogoPreview, setSccLogoPreview] = useState(localStorage.getItem('scc_logo') || null);
            const [rmcLogoPreview, setRmcLogoPreview] = useState(localStorage.getItem('rmc_logo') || null);

            const MAX_FILE_SIZE = 10 * 1024 * 1024;
            const VALID_MIME_TYPES = ['text/csv', 'application/vnd.ms-excel', 'text/plain'];
            const MAX_LOGO_SIZE = 500 * 1024;
            const VALID_IMAGE_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];

            const handleFile = (file, type) => {
                if (!file) return;
                
                if (file.size > MAX_FILE_SIZE) {
                    setError(`File "${file.name}" exceeds 10MB limit. Current size: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                    return;
                }
                
                if (!VALID_MIME_TYPES.includes(file.type) && !file.name.endsWith('.csv')) {
                    setError(`Invalid file type. Please upload CSV files only. File type: ${file.type || 'unknown'}`);
                    return;
                }
                
                if(type === 'personnel') setPersonnelFile(file);
                if(type === 'quals') setQualsFile(file);
                if (error) setError(null);
            };

            const handleLogoUpload = (file, type) => {
                if (!file) return;
                
                if (file.size > MAX_LOGO_SIZE) {
                    setError(`Logo file too large. Maximum size is 500KB. Current size: ${(file.size / 1024).toFixed(0)}KB`);
                    return;
                }
                
                if (!VALID_IMAGE_TYPES.includes(file.type)) {
                    setError(`Invalid image type. Please upload JPG, PNG, or WebP files only.`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    
                    if (type === 'crest') {
                        localStorage.setItem('unit_crest', base64);
                        setUnitCrestPreview(base64);
                    } else if (type === 'scc') {
                        localStorage.setItem('scc_logo', base64);
                        setSccLogoPreview(base64);
                    } else if (type === 'rmc') {
                        localStorage.setItem('rmc_logo', base64);
                        setRmcLogoPreview(base64);
                    }
                };
                reader.readAsDataURL(file);
            };

            const removeLogo = (type) => {
                if (type === 'crest') {
                    localStorage.removeItem('unit_crest');
                    setUnitCrestPreview(null);
                } else if (type === 'scc') {
                    localStorage.removeItem('scc_logo');
                    setSccLogoPreview(null);
                } else if (type === 'rmc') {
                    localStorage.removeItem('rmc_logo');
                    setRmcLogoPreview(null);
                }
            };

            const readFile = (file) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsText(file);
            });

            const processPersonnelFile = async (text, validationErrors = []) => {
                const personnelData = [];
                const lines = text.split('\n');
                
                const dataRowCount = lines.length - 1;
                if (dataRowCount > 1000) {
                    throw new Error(`Personnel file has too many rows (${dataRowCount.toLocaleString()}). Maximum allowed is 1,000 cadets.`);
                }
                
                const headers = splitCSVLine(lines[0].trim());
                
                // CRITICAL: Check if this is a junior module template
                if (isJuniorModuleTemplate(headers)) {
                    throw new Error(
                        `❌ WRONG FILE TYPE DETECTED!\n\n` +
                        `You've uploaded a Junior Module Template CSV.\n\n` +
                        `This should be uploaded using:\n` +
                        `Data/Utilities → Bulk Upload Legacy Modules → "Upload Template"\n\n` +
                        `For Personnel updates, please use the Westminster "Unit Personnel Report" CSV.`
                    );
                }
                
                const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
                
                const idx = {
                    pnum: findCol("PNumber") > -1 ? findCol("PNumber") : findCol("PNo"),
                    rank: findCol("Rank"),
                    surname: findCol("Surname"),
                    firstname: findCol("First Name"),
                    unit: findCol("Unit"),
                    dob: findCol("DOB"),
                    tos: findCol("TOS Date"),
                    rankDate: findCol("Date Current Rank"),
                    cvqo: findCol("CVQO Reference")
                };

                const requiredFields = ['pnum', 'rank', 'surname'];
                const missing = requiredFields.filter(key => idx[key] === -1);
                if (missing.length > 0) {
                    throw new Error(`Personnel file missing columns: ${missing.join(', ')}. Check CSV headers.`);
                }
                
                // CRITICAL: Check for DOB column
                if (idx.dob === -1) {
                    validationErrors.push(`⚠️ CRITICAL WARNING: Personnel file is missing DOB column. Junior functionality will not work without DOB data!`);
                }
                
                let dobMissingCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    const row = splitCSVLine(lines[i].trim());
                    if (row.length < 3) continue;
                    
                    const rowErrors = [];
                    const pNumber = sanitizeText(row[idx.pnum] || "").trim();
                    const rank = sanitizeText(row[idx.rank] || "").trim();
                    const surname = sanitizeText(row[idx.surname] || "").trim();
                    const firstname = sanitizeText(row[idx.firstname] || "").trim();
                    
                    // Validate P-Number
                    if (!pNumber) {
                        rowErrors.push(`Row ${i + 1}: Missing P-Number`);
                    } else {
                        const cleanPNum = pNumber.replace(/[\s-]/g, '');
                        const isCadetWithPrefix = /^[Pp]\d+$/.test(cleanPNum);
                        const isCadetNumericOnly = /^\d{7,8}$/.test(cleanPNum);
                        const isAdultCVFormat = /^CV\d+$/i.test(cleanPNum);
                        const isAdultLetterFormat = /^[A-Z]\d{6,7}[A-Z]$/i.test(cleanPNum);
                        
                        if (!isCadetWithPrefix && !isCadetNumericOnly && !isAdultCVFormat && !isAdultLetterFormat) {
                            rowErrors.push(`Row ${i + 1}: Unusual P-Number format "${pNumber}"`);
                        }
                    }
                    
                    // Validate name
                    if (!surname && !firstname) {
                        rowErrors.push(`Row ${i + 1}: Missing name for ${pNumber}`);
                    }
                    
                    // Validate DOB if present
                    if (idx.dob !== -1 && row[idx.dob] && row[idx.dob].trim()) {
                        const dobTest = parseDate(row[idx.dob]);
                        if (!dobTest) {
                            rowErrors.push(`Row ${i + 1}: Invalid DOB format "${row[idx.dob]}" (${pNumber})`);
                        }
                    } else if (idx.dob !== -1 && (!row[idx.dob] || !row[idx.dob].trim())) {
                        dobMissingCount++;
                    }
                    
                    if (rowErrors.length > 0) {
                        validationErrors.push(...rowErrors);
                    }
                    
                    personnelData.push({
                        pNumber: pNumber,
                        rank: normalizeRank(rank || "Unit Assistant (UA)"),
                        name: `${surname}, ${firstname}`,
                        unit: sanitizeText(row[idx.unit] || "").trim(),
                        dob: idx.dob !== -1 ? row[idx.dob] : null,
                        tos: idx.tos !== -1 ? row[idx.tos] : null,
                        rankDate: idx.rankDate !== -1 ? row[idx.rankDate] : null,
                        cvqo: idx.cvqo !== -1 ? sanitizeText(row[idx.cvqo]) : null,
                        _hasWarnings: rowErrors.length > 0
                    });
                }
                
                // Add DOB missing summary
                if (dobMissingCount > 0) {
                    validationErrors.push(`⚠️ ${dobMissingCount} records missing DOB data (junior features will not work for these cadets)`);
                }
                
                return personnelData;
            };

            const processQualsFile = async (text) => {
                const qualsData = [];
                const lines = text.split('\n');
                
                const dataRowCount = lines.length - 1;
                if (dataRowCount > 200000) {
                    throw new Error(`Qualifications file has too many rows (${dataRowCount.toLocaleString()}). Maximum allowed is 200,000 records.`);
                }
                
                const headers = splitCSVLine(lines[0].trim());
                const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
                
                const idx = {
                    pnum: findCol("PNumber") > -1 ? findCol("PNumber") : findCol("PNo"),
                    module: findCol("Module"),
                    date: findCol("Date Achieved"),
                    result: findCol("Result"),
                    syllabus: findCol("Syllabus")
                };

                const requiredFields = ['pnum', 'module', 'date'];
                const missing = requiredFields.filter(key => idx[key] === -1);
                if (missing.length > 0) {
                    throw new Error(`Qualifications file missing columns: ${missing.join(', ')}. Check CSV headers.`);
                }

                for (let i = 1; i < lines.length; i++) {
                    const row = splitCSVLine(lines[i].trim());
                    if (row.length < 3) continue;
                    qualsData.push({
                        pNumber: sanitizeText(row[idx.pnum] || "").trim(),
                        module: sanitizeText(row[idx.module] || "").trim(),
                        date: parseDate(row[idx.date]),
                        result: sanitizeText(row[idx.result]),
                        syllabus: sanitizeText(row[idx.syllabus])
                    });
                }
                
                return qualsData;
            };

            const processFiles = async () => {
                if (!personnelFile || !qualsFile) {
                    setError("Please select both files.");
                    return;
                }

                setLoading(true);
                setError(null);
                setValidationErrors([]);
                setImportSummary(null);

                try {
                    const personnelText = await readFile(personnelFile);
                    const qualsText = await readFile(qualsFile);
                    
                    const validationErrors = [];
                    const personnelData = await processPersonnelFile(personnelText, validationErrors);
                    const qualsData = await processQualsFile(qualsText);
                    
                    const previewData = {
                        personnel: personnelData.slice(0, 10),
                        personnelTotal: personnelData.length,
                        qualifications: qualsData.slice(0, 10),
                        qualificationsTotal: qualsData.length,
                        errors: validationErrors
                    };
                    
                    setPreview(previewData);
                    setValidationErrors(validationErrors);
                    
                    if (validationErrors.length > 0) {
                        localStorage.setItem('importWarnings', JSON.stringify({
                            warnings: validationErrors,
                            timestamp: new Date().toISOString(),
                            personnelCount: personnelData.length,
                            qualsCount: qualsData.length
                        }));
                    }
                    
                    const errorRate = validationErrors.length / personnelData.length;
                    if (errorRate > 0.1) {
                        const proceed = confirm(
                            `Found ${validationErrors.length} validation warnings in ${personnelData.length} personnel records (${(errorRate * 100).toFixed(1)}%).\n\n` +
                            `Do you want to proceed with import?\n\n` +
                            `Click OK to continue or Cancel to fix errors and re-upload.`
                        );
                        if (!proceed) {
                            setLoading(false);
                            return;
                        }
                    }
                    
                    onDataLoaded(personnelData, qualsData);
                    
                    setImportSummary({
                        personnelImported: personnelData.length,
                        qualificationsImported: qualsData.length,
                        warningsCount: validationErrors.length,
                        success: true
                    });
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                } catch (err) {
                    console.error(err);
                    setError(err.message);
                    setImportSummary({
                        success: false,
                        error: err.message
                    });
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto mt-2 border border-slate-200">
                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="upload" className="w-5 h-5"></i> Import Data Sources
                    </h2>
                    
                    <div className="mb-6 text-sm text-slate-600 bg-blue-50 p-4 rounded border border-blue-100">
                        <p className="mb-3">
                            Download the correct CSV files from Westminster, ready to upload to your dashboard. 
                            All data remains secure within your web browser.
                        </p>
                        <button onClick={() => setShowVideoModal(true)} className="inline-flex items-center gap-2 font-bold text-blue-700 hover:text-blue-900 hover:underline cursor-pointer">
                            <i data-lucide="file-text" className="w-4 h-4"></i> Watch Instructions Video
                        </button>
                    </div>

                    <div className="mb-6 p-4 bg-amber-50 border-l-4 border-amber-500 rounded">
                        <div className="flex items-start gap-2">
                            <i data-lucide="shield-alert" className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"></i>
                            <div className="text-sm">
                                <p className="font-bold text-amber-900 mb-2">Data Security Notice</p>
                                <p className="text-amber-800 mb-2">
                                    Your cadet data is stored in your browser only. It never leaves your device.
                                </p>
                                <p className="text-amber-800 mb-2">
                                    <strong>On shared computers:</strong> Always click "Reset Data" when finished to clear all cadet information.
                                </p>
                                <p className="text-amber-700 text-xs">
                                    For best security, use this dashboard on your personal device.
                                </p>
                            </div>
                        </div>
                    </div>

                    {error && (
                        <div className="mb-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 flex justify-between items-start">
                            <div>
                                <p className="font-bold">Error Processing Files</p>
                                <p className="text-sm whitespace-pre-wrap">{error}</p>
                            </div>
                            <button onClick={() => setError(null)} className="text-red-500 hover:text-red-700" aria-label="Dismiss error message">
                                <i data-lucide="x" className="w-4 h-4"></i>
                            </button>
                        </div>
                    )}

                    {validationErrors.length > 0 && (
                        <div className="mb-4 p-4 bg-amber-50 border-l-4 border-amber-500 max-h-64 overflow-y-auto">
                            <div className="flex justify-between items-start mb-2">
                                <p className="font-bold text-amber-900 flex items-center gap-2">
                                    <i data-lucide="alert-triangle" className="w-5 h-5"></i>
                                    {validationErrors.length} Validation Warning{validationErrors.length !== 1 ? 's' : ''}
                                </p>
                                <button onClick={() => setValidationErrors([])} className="text-amber-600 hover:text-amber-800" aria-label="Dismiss warnings">
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            </div>
                            <ul className="text-sm text-amber-800 space-y-1 list-disc list-inside">
                                {validationErrors.slice(0, 20).map((err, idx) => (
                                    <li key={idx}>{err}</li>
                                ))}
                                {validationErrors.length > 20 && (
                                    <li className="italic">... and {validationErrors.length - 20} more warnings</li>
                                )}
                            </ul>
                        </div>
                    )}

                    <div className="space-y-4">
                        <div className="border-2 border-dashed border-slate-300 p-6 rounded-lg text-center hover:bg-slate-50 transition-colors">
                            <p className="font-semibold text-slate-600 mb-2">1. Westminster Personnel Report (Required)</p>
                            <p className="text-xs text-slate-500 mb-3">Must include DOB column for junior features to work</p>
                            <input type="file" accept=".csv" onChange={(e) => handleFile(e.target.files[0], 'personnel')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                        <div className="border-2 border-dashed border-slate-300 p-6 rounded-lg text-center hover:bg-slate-50 transition-colors">
                            <p className="font-semibold text-slate-600 mb-2">2. Westminster Qualifications Report (Required)</p>
                            <input type="file" accept=".csv" onChange={(e) => handleFile(e.target.files[0], 'quals')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>

                        {/* Logo Uploads */}
                        <div className="border-t-2 border-slate-200 pt-4 mt-6">
                            <p className="text-sm font-bold text-slate-700 mb-3">Optional: Upload Logos for Certificates (500x500px recommended)</p>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="border border-slate-200 p-4 rounded-lg">
                                    <p className="text-xs font-semibold text-slate-600 mb-2">Unit Crest</p>
                                    {unitCrestPreview ? (
                                        <div className="relative">
                                            <img src={unitCrestPreview} alt="Unit Crest" className="w-full h-32 object-contain mb-2 border rounded" />
                                            <button onClick={() => removeLogo('crest')} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
                                                <i data-lucide="x" className="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-slate-300 p-4 rounded text-center h-32 flex items-center justify-center">
                                            <p className="text-xs text-slate-400">Top center</p>
                                        </div>
                                    )}
                                    <input type="file" accept="image/jpeg,image/jpg,image/png,image/webp" onChange={(e) => handleLogoUpload(e.target.files[0], 'crest')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mt-2"/>
                                </div>

                                <div className="border border-slate-200 p-4 rounded-lg">
                                    <p className="text-xs font-semibold text-slate-600 mb-2">SCC Logo</p>
                                    {sccLogoPreview ? (
                                        <div className="relative">
                                            <img src={sccLogoPreview} alt="SCC Logo" className="w-full h-32 object-contain mb-2 border rounded" />
                                            <button onClick={() => removeLogo('scc')} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
                                                <i data-lucide="x" className="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-slate-300 p-4 rounded text-center h-32 flex items-center justify-center">
                                            <p className="text-xs text-slate-400">Bottom right</p>
                                        </div>
                                    )}
                                    <input type="file" accept="image/jpeg,image/jpg,image/png,image/webp" onChange={(e) => handleLogoUpload(e.target.files[0], 'scc')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mt-2"/>
                                </div>

                                <div className="border border-slate-200 p-4 rounded-lg">
                                    <p className="text-xs font-semibold text-slate-600 mb-2">RMC Logo</p>
                                    {rmcLogoPreview ? (
                                        <div className="relative">
                                            <img src={rmcLogoPreview} alt="RMC Logo" className="w-full h-32 object-contain mb-2 border rounded" />
                                            <button onClick={() => removeLogo('rmc')} className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-full hover:bg-red-600">
                                                <i data-lucide="x" className="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="border-2 border-dashed border-slate-300 p-4 rounded text-center h-32 flex items-center justify-center">
                                            <p className="text-xs text-slate-400">Bottom left</p>
                                        </div>
                                    )}
                                    <input type="file" accept="image/jpeg,image/jpg,image/png,image/webp" onChange={(e) => handleLogoUpload(e.target.files[0], 'rmc')} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mt-2"/>
                                </div>
                            </div>
                        </div>

                        <button onClick={processFiles} disabled={!personnelFile || !qualsFile || loading} className={`w-full py-3 rounded-lg font-bold text-white transition-all ${(!personnelFile || !qualsFile) ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-700 hover:bg-blue-800 shadow-lg'}`}>
                            {loading ? "Processing..." : "Load Dashboards"}
                        </button>
                    </div>

                    {hasData && (
                        <div className="mt-8 border-t pt-6">
                            <div className="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-4">
                                <p className="text-sm font-bold text-red-900 mb-2 flex items-center gap-2">
                                    <i data-lucide="alert-triangle" className="w-5 h-5"></i>
                                    WARNING: Only use Westminster Personnel CSV here
                                </p>
                                <p className="text-xs text-red-800">
                                    DO NOT upload junior module templates or Supabase exports to these buttons.
                                    They will replace your personnel data and DELETE date of birth information.
                                </p>
                            </div>
                            
                            <p className="text-sm font-bold text-slate-700 mb-4 text-center">Update Individual Westminster Files Only</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div className="border border-red-200 p-4 rounded-lg bg-red-50">
                                    <p className="text-xs font-semibold text-red-900 mb-2 flex items-center gap-2">
                                        <i data-lucide="alert-circle" className="w-4 h-4"></i>
                                        Update Westminster Personnel Only
                                    </p>
                                    <p className="text-xs text-red-800 mb-2">Only use Westminster "Unit Personnel Report" CSV</p>
                                    <input type="file" accept=".csv" onChange={(e) => {
                                        setPersonnelFile(e.target.files[0]);
                                        setError(null);
                                    }} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-red-100 file:text-red-700 hover:file:bg-red-200 mb-2"/>
                                    <button 
                                        onClick={async () => {
                                            if (!personnelFile) return;
                                            setLoading(true);
                                            setError(null);
                                            try {
                                                const text = await readFile(personnelFile);
                                                const validationErrors = [];
                                                const personnelData = await processPersonnelFile(text, validationErrors);
                                                
                                                if (validationErrors.length > 0) {
                                                    setValidationErrors(validationErrors);
                                                }
                                                
                                                onDataLoaded(personnelData, JSON.parse(localStorage.getItem('scc_quals') || '[]'));
                                                setPersonnelFile(null);
                                            } catch (err) {
                                                setError(err.message);
                                            } finally {
                                                setLoading(false);
                                            }
                                        }}
                                        disabled={!personnelFile || loading}
                                        className={`w-full py-2 rounded font-semibold text-xs transition-all ${!personnelFile ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-red-600 text-white hover:bg-red-700'}`}
                                    >
                                        {loading ? 'Updating...' : 'Update Personnel (Westminster Only!)'}
                                    </button>
                                </div>
                                
                                <div className="border border-slate-200 p-4 rounded-lg">
                                    <p className="text-xs font-semibold text-slate-600 mb-2">Update Westminster Qualifications Only</p>
                                    <input type="file" accept=".csv" onChange={(e) => {
                                        setQualsFile(e.target.files[0]);
                                        setError(null);
                                    }} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 mb-2"/>
                                    <button 
                                        onClick={async () => {
                                            if (!qualsFile) return;
                                            setLoading(true);
                                            setError(null);
                                            try {
                                                const text = await readFile(qualsFile);
                                                const qualsData = await processQualsFile(text);
                                                onDataLoaded(JSON.parse(localStorage.getItem('scc_personnel') || '[]'), qualsData);
                                                setQualsFile(null);
                                            } catch (err) {
                                                setError(err.message);
                                            } finally {
                                                setLoading(false);
                                            }
                                        }}
                                        disabled={!qualsFile || loading}
                                        className={`w-full py-2 rounded font-semibold text-xs transition-all ${!qualsFile ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}
                                    >
                                        {loading ? 'Updating...' : 'Update Qualifications'}
                                    </button>
                                </div>
                            </div>
                            
                            <p className="text-xs text-slate-500 text-center mb-3">Or clear data and start fresh:</p>
                            <div className="flex gap-4 justify-center">
                                <button onClick={clearData} className="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center gap-2">
                                    <i data-lucide="refresh-cw" className="w-4 h-4"></i> Reset Cadet Data
                                </button>
                                <button onClick={wipeAllData} className="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2">
                                    <i data-lucide="trash-2" className="w-4 h-4"></i> Wipe All Data
                                </button>
                            </div>
                            <p className="text-xs text-slate-400 mt-2 text-center">Reset keeps your logos. Wipe clears everything.</p>
                        </div>
                    )}

                    {showVideoModal && (
                        <div className="fixed inset-0 bg-slate-900 bg-opacity-75 z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col overflow-hidden">
                                <div className="p-4 border-b flex justify-between items-center bg-blue-50">
                                    <h3 className="text-xl font-bold text-blue-800">
                                        How to Download Data from Westminster
                                    </h3>
                                    <button onClick={() => setShowVideoModal(false)} className="p-2 rounded-full hover:bg-blue-100 text-slate-600" aria-label="Close video tutorial">
                                        <i data-lucide="x" className="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div className="bg-black flex justify-center items-center">
                                    <video controls autoPlay className="max-h-[60vh] w-full object-contain">
                                        <source src="media/TS_Dashboard_Instructions.mp4" type="video/mp4" />
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div className="p-4 border-t border-slate-200 bg-slate-50 flex justify-end">
                                    <button onClick={() => setShowVideoModal(false)} className="px-6 py-2 bg-blue-700 hover:bg-blue-800 text-white font-bold rounded-lg transition-colors">
                                        Close Video
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Simple Home Component for testing
        const HomeView = () => (
            <div className="text-center p-8">
                <h1 className="text-3xl font-bold mb-4">Dashboard Loaded Successfully</h1>
                <p className="text-slate-600">Version {DATA_VERSION} - Enhanced DOB Validation Active</p>
                <div className="mt-8 p-6 bg-green-50 rounded-lg border-2 border-green-300 max-w-2xl mx-auto">
                    <h2 className="text-xl font-bold text-green-900 mb-3">✅ Fixed Issues:</h2>
                    <ul className="text-left text-sm space-y-2 text-green-800">
                        <li>• <strong>DOB Column Validation:</strong> Warns if DOB column is missing</li>
                        <li>• <strong>Template File Detection:</strong> Rejects junior module templates on personnel upload</li>
                        <li>• <strong>Clear Upload Labels:</strong> Red warning box on personnel update button</li>
                        <li>• <strong>Missing DOB Count:</strong> Shows how many records lack DOB data</li>
                    </ul>
                </div>
            </div>
        );
        
        // Main App
        const App = () => {
            const [view, setView] = useState('upload');
            const [personnelData, setPersonnelData] = useState([]);
            const [qualsData, setQualsData] = useState([]);

            useEffect(() => { lucide.createIcons(); }, [view]);

            useEffect(() => {
                const savedVersion = localStorage.getItem('scc_version');
                if (savedVersion !== DATA_VERSION) {
                    localStorage.clear();
                    localStorage.setItem('scc_version', DATA_VERSION);
                } else {
                    const savedP = localStorage.getItem('scc_personnel');
                    const savedQ = localStorage.getItem('scc_quals');
                    if (savedP && savedQ) {
                        try {
                            const parsedP = JSON.parse(savedP);
                            const parsedQ = JSON.parse(savedQ);
                            
                            const hydratedQ = parsedQ.map(q => ({
                                ...q,
                                date: q.date ? new Date(q.date) : null
                            }));
                            
                            setPersonnelData(parsedP);
                            setQualsData(hydratedQ);
                            setView('home');
                        } catch (e) {
                            console.error("Error rehydrating data", e);
                            localStorage.clear();
                        }
                    }
                }
            }, []);

            const handleDataLoaded = (pData, qData) => {
                setPersonnelData(pData);
                setQualsData(qData);
                localStorage.setItem('scc_personnel', JSON.stringify(pData));
                localStorage.setItem('scc_quals', JSON.stringify(qData));
                setView('home');
            };

            const clearData = () => {
                localStorage.removeItem('scc_personnel');
                localStorage.removeItem('scc_quals');
                localStorage.removeItem('scc_version');
                window.location.reload();
            };

            const wipeAllData = () => {
                localStorage.clear();
                window.location.reload();
            };

            if (view === 'upload' && personnelData.length === 0) {
                return (
                    <div className="min-h-screen flex flex-col items-center pt-5 pb-10">
                        <h1 className="text-4xl font-extrabold text-blue-900 mb-1">Sea Cadet Training Dashboard</h1>
                        <p className="text-sm text-slate-600 mb-6">Version {DATA_VERSION} - DOB Validation Fixed</p>
                        <FileUploader onDataLoaded={handleDataLoaded} hasData={personnelData.length > 0} clearData={clearData} wipeAllData={wipeAllData} />
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 p-8">
                    <HomeView />
                    <div className="text-center mt-8">
                        <button onClick={() => setView('upload')} className="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 font-bold">
                            Back to Upload
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        lucide.createIcons();
        console.log(`${DATA_VERSION} loaded successfully - DOB validation active!`);
    </script>
</body>
</html>
