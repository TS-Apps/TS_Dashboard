<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Cadet Deck Log</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { 
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(30, 58, 138, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(30, 41, 59, 0.4) 0px, transparent 50%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .badge-aboard {
            background-color: #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }
        
        .badge-ashore {
            background-color: #64748b;
        }
        
        .touch-target {
            min-height: 56px;
            min-width: 56px;
        }
        
        .emergency-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .7;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .stat-card {
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const APP_VERSION = "1.2.0";
        const STORAGE_KEY = "deck_log_sessions";
        const PERSONNEL_KEY = "deck_log_personnel";
        const DIVISIONS_KEY = "deck_log_divisions";
        
        // Valid ranks for Officer of the Day
        const OOD_RANKS = [
            'PPO (SCC)', 'PO (SCC)', 'CPO (SCC)',
            'Sgt (SCC)', 'PSgt (SCC)', 'CSgt (SCC)',
            'SLt (SCC)', 'Lt (SCC)', 'Lt Cdr (SCC)'
        ];
        
        // Parse CSV helper
        const parseCSV = (text) => {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, idx) => {
                        row[header.trim()] = values[idx].trim();
                    });
                    data.push(row);
                }
            }
            return data;
        };
        
        // Process personnel from CSV
        const processPersonnel = (csvData) => {
            const adultsMap = new Map();
            const cadetsMap = new Map();
            
            csvData.forEach(row => {
                const pNumber = row.PNumber?.trim();
                if (!pNumber) return;
                
                if (row.Type === 'Adult') {
                    // Only store first occurrence of each PNumber
                    if (!adultsMap.has(pNumber)) {
                        let rank = row.Rank?.trim() || '';
                        const firstName = row['First Name']?.trim() || '';
                        const surname = row.Surname?.trim() || '';
                        
                        // Handle RNR/RMR ranks - remove from rank and add as suffix
                        let suffix = '';
                        if (rank.includes('RNR')) {
                            rank = rank.replace(/\s*RNR\s*/, '').trim();
                            suffix = ' RNR';
                        } else if (rank.includes('RMR')) {
                            rank = rank.replace(/\s*RMR\s*/, '').trim();
                            suffix = ' RMR';
                        }
                        
                        // Format: Rank FirstName SURNAME [RNR/RMR]
                        const displayName = `${rank} ${firstName} ${surname.toUpperCase()}${suffix}`.trim();
                        
                        // Determine force type from unit or rank
                        let forceType = 'SCC';
                        const unit = row.Unit || '';
                        if (unit.includes('JUNIOR')) {
                            forceType = 'Juniors';
                        } else if (unit.includes('RMCD') || rank.includes('Sgt') || rank.includes('CSgt')) {
                            forceType = 'RMC';
                        }
                        
                        adultsMap.set(pNumber, {
                            pNumber: pNumber,
                            rank: rank,
                            surname: surname,
                            initials: row.Initials?.trim() || '',
                            firstName: firstName,
                            displayName: displayName,
                            forceType: forceType,
                            division: ''
                        });
                    }
                } else if (row.Type === 'Cadet') {
                    // Only store first occurrence of each PNumber
                    if (!cadetsMap.has(pNumber)) {
                        const firstName = row['First Name']?.trim() || '';
                        const surname = row.Surname?.trim() || '';
                        const rank = row.Rank?.trim() || '';
                        const unit = row.Unit || '';
                        
                        // Determine force type based on unit
                        let forceType = 'SCC';
                        if (unit.includes('JUNIOR')) {
                            forceType = 'Juniors';
                        } else if (unit.includes('RMCD')) {
                            forceType = 'RMC';
                        }
                        
                        // Format: Rank FirstName SURNAME
                        const displayName = `${rank} ${firstName} ${surname.toUpperCase()}`.trim();
                        
                        cadetsMap.set(pNumber, {
                            pNumber: pNumber,
                            rank: rank,
                            surname: surname,
                            firstName: firstName,
                            name: displayName,
                            forceType: forceType,
                            division: ''
                        });
                    }
                }
            });
            
            return { 
                adults: Array.from(adultsMap.values()), 
                cadets: Array.from(cadetsMap.values()) 
            };
        };
        
        const DUTY_ROLES = [
            { key: "dutyDivision", label: "Duty Division", type: "division" },
            { key: "dutySeniorCadet", label: "Duty Senior Cadet", type: "cadet" },
            { key: "quartermaster", label: "Quartermaster", type: "cadet" },
            { key: "officerOfDay", label: "Officer of the Day", type: "adult" },
        ];
        
        const SIGNAL_PARTY = [
            { key: "preparativeFlag", label: "Preparative Flag", type: "cadet" },
            { key: "seaCadetEnsign", label: "Sea Cadet Ensign", type: "cadet" },
            { key: "rmcColour", label: "RMC Colour", type: "cadet" },
            { key: "piper", label: "Piper", type: "cadet" },
        ];
        
        // Icon Component
        const Icon = ({ name, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            });
            return <i data-lucide={name} className={className}></i>;
        };
        
        // Initialize or get current session
        const initSession = () => {
            const today = new Date().toISOString().split('T')[0];
            const stored = localStorage.getItem(STORAGE_KEY);
            const personnelStored = localStorage.getItem(PERSONNEL_KEY);
            const divisionsStored = localStorage.getItem(DIVISIONS_KEY);
            
            let personnel = { adults: [], cadets: [] };
            if (personnelStored) {
                personnel = JSON.parse(personnelStored);
            }
            
            let divisions = [];
            if (divisionsStored) {
                divisions = JSON.parse(divisionsStored);
            }
            
            let sessions = stored ? JSON.parse(stored) : {};
            
            if (!sessions[today]) {
                sessions[today] = {
                    date: today,
                    cadets: personnel.cadets.map(c => ({
                        ...c,
                        status: 'ashore',
                        timeIn: null,
                        timeOut: null
                    })),
                    adults: personnel.adults.map(a => ({
                        ...a,
                        status: 'ashore',
                        timeIn: null,
                        timeOut: null
                    })),
                    visitors: [],
                    duties: {},
                    signalParty: {},
                    secured: null
                };
            }
            
            return { sessions, currentDate: today, personnel, divisions };
        };
        
        const saveSession = (sessions) => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
        };
        
        // Confirmation Dialog Component
        const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, person }) => {
            if (!isOpen) return null;
            
            const displayName = person.displayName || person.name || `${person.rank} ${person.surname}`;
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700 shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                        <p className="text-slate-300 mb-4">{message}</p>
                        {person && (
                            <div className="bg-slate-700 rounded-lg p-3 mb-4">
                                <p className="text-white font-bold">{displayName}</p>
                                {person.pNumber && <p className="text-slate-400 text-sm">{person.pNumber}</p>}
                            </div>
                        )}
                        <div className="flex gap-3">
                            <button
                                onClick={onConfirm}
                                className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all"
                            >
                                Confirm
                            </button>
                            <button
                                onClick={onClose}
                                className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // CSV Upload Component
        const CSVUpload = ({ onDataLoaded, onCancel }) => {
            const [dragActive, setDragActive] = useState(false);
            
            const handleFile = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvData = parseCSV(e.target.result);
                        const personnel = processPersonnel(csvData);
                        localStorage.setItem(PERSONNEL_KEY, JSON.stringify(personnel));
                        onDataLoaded(personnel);
                    } catch (error) {
                        alert('Error parsing CSV file. Please check the format.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            };
            
            const handleChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFile(e.target.files[0]);
                }
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center p-8">
                    <div className="max-w-2xl w-full">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icon name="Ship" className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-4xl font-bold text-white mb-2">Deck Log</h1>
                            <p className="text-slate-400">Import personnel data to begin</p>
                        </div>
                        
                        <div
                            className={`border-2 border-dashed rounded-xl p-12 text-center transition-all ${
                                dragActive ? 'border-blue-500 bg-blue-900 bg-opacity-20' : 'border-slate-700 bg-slate-800'
                            }`}
                            onDragOver={(e) => { e.preventDefault(); setDragActive(true); }}
                            onDragLeave={() => setDragActive(false)}
                            onDrop={handleDrop}
                        >
                            <Icon name="Upload" className="w-16 h-16 text-slate-400 mx-auto mb-4" />
                            <h3 className="text-xl font-bold text-white mb-2">Upload Personnel Report</h3>
                            <p className="text-slate-400 mb-6">Drag and drop your CSV file here, or click to browse</p>
                            <input
                                type="file"
                                accept=".csv"
                                onChange={handleChange}
                                className="hidden"
                                id="csv-upload"
                            />
                            <label
                                htmlFor="csv-upload"
                                className="inline-block px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold cursor-pointer transition-all"
                            >
                                Choose File
                            </label>
                        </div>
                        
                        {onCancel && (
                            <button
                                onClick={onCancel}
                                className="w-full mt-4 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all"
                            >
                                Cancel
                            </button>
                        )}
                        
                        <div className="mt-8 text-center text-xs text-slate-500">
                            <p>Expected format: FULL_Unit_Personnel_Report.csv from Westminster</p>
                            <p className="mt-2">v{APP_VERSION}</p>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Main App Component
        const App = () => {
            const [view, setView] = useState('dashboard');
            const [sessionData, setSessionData] = useState(() => initSession());
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false });
            
            const currentSession = sessionData.sessions[sessionData.currentDate];
            const hasPersonnel = sessionData.personnel.adults.length > 0 || sessionData.personnel.cadets.length > 0;
            
            const updateSession = (updates) => {
                const newSessions = {
                    ...sessionData.sessions,
                    [sessionData.currentDate]: {
                        ...currentSession,
                        ...updates
                    }
                };
                setSessionData({ ...sessionData, sessions: newSessions });
                saveSession(newSessions);
            };
            
            const updateDivision = (type, pNumber, division) => {
                const list = currentSession[type];
                const person = list.find(p => p.pNumber === pNumber);
                if (person) {
                    person.division = division;
                    
                    // Also update in personnel data
                    const personnelList = sessionData.personnel[type];
                    const personnelPerson = personnelList.find(p => p.pNumber === pNumber);
                    if (personnelPerson) {
                        personnelPerson.division = division;
                        localStorage.setItem(PERSONNEL_KEY, JSON.stringify(sessionData.personnel));
                    }
                    
                    updateSession({ [type]: [...list] });
                }
            };
            
            const toggleAttendance = (type, pNumber) => {
                const list = currentSession[type];
                const person = list.find(p => p.pNumber === pNumber);
                
                setConfirmDialog({
                    isOpen: true,
                    person: person,
                    title: person.status === 'ashore' ? 'Mark as Aboard?' : 'Mark as Ashore?',
                    message: person.status === 'ashore' 
                        ? 'Confirm this person has arrived and is now aboard.'
                        : 'Confirm this person has departed and is now ashore.',
                    onConfirm: () => {
                        const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                        
                        if (person.status === 'ashore') {
                            person.status = 'aboard';
                            person.timeIn = now;
                            person.timeOut = null;
                        } else {
                            person.status = 'ashore';
                            person.timeOut = now;
                        }
                        
                        updateSession({ [type]: [...list] });
                        setConfirmDialog({ isOpen: false });
                    }
                });
            };
            
            const handlePersonnelLoaded = (personnel) => {
                const newSessionData = initSession();
                setSessionData(newSessionData);
                setView('dashboard');
            };
            
            const handleDivisionsUpdated = (newDivisions) => {
                localStorage.setItem(DIVISIONS_KEY, JSON.stringify(newDivisions));
                setSessionData({ ...sessionData, divisions: newDivisions });
            };
            
            const handleBulkToggle = (pNumbers, targetStatus) => {
                const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                
                // Update cadets
                const updatedCadets = currentSession.cadets.map(cadet => {
                    if (pNumbers.includes(cadet.pNumber)) {
                        if (targetStatus === 'aboard' && cadet.status === 'ashore') {
                            return { ...cadet, status: 'aboard', timeIn: now, timeOut: null };
                        } else if (targetStatus === 'ashore' && cadet.status === 'aboard') {
                            return { ...cadet, status: 'ashore', timeOut: now };
                        }
                    }
                    return cadet;
                });
                
                // Update adults
                const updatedAdults = currentSession.adults.map(adult => {
                    if (pNumbers.includes(adult.pNumber)) {
                        if (targetStatus === 'aboard' && adult.status === 'ashore') {
                            return { ...adult, status: 'aboard', timeIn: now, timeOut: null };
                        } else if (targetStatus === 'ashore' && adult.status === 'aboard') {
                            return { ...adult, status: 'ashore', timeOut: now };
                        }
                    }
                    return adult;
                });
                
                updateSession({ cadets: updatedCadets, adults: updatedAdults });
            };
            
            const addVisitor = (visitor) => {
                const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                updateSession({
                    visitors: [...currentSession.visitors, {
                        ...visitor,
                        timeIn: now,
                        timeOut: null,
                        id: Date.now()
                    }]
                });
            };
            
            const removeVisitor = (id) => {
                const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const visitors = currentSession.visitors.map(v => 
                    v.id === id ? { ...v, timeOut: now } : v
                );
                updateSession({ visitors });
            };
            
            const stats = {
                cadetsAboard: currentSession.cadets.filter(c => c.status === 'aboard').length,
                adultsAboard: currentSession.adults.filter(a => a.status === 'aboard').length,
                visitorsAboard: currentSession.visitors.filter(v => !v.timeOut).length,
                totalAboard: currentSession.cadets.filter(c => c.status === 'aboard').length +
                           currentSession.adults.filter(a => a.status === 'aboard').length +
                           currentSession.visitors.filter(v => !v.timeOut).length
            };
            
            const NavItem = ({ id, icon, label, count }) => (
                <button 
                    onClick={() => setView(id)} 
                    className={`flex items-center justify-between w-full p-3 rounded-lg transition-all touch-target ${
                        view === id 
                            ? 'bg-blue-600 text-white shadow-lg' 
                            : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                    }`}
                >
                    <div className="flex items-center gap-3">
                        <Icon name={icon} className="w-5 h-5" />
                        <span className="text-sm font-medium">{label}</span>
                    </div>
                    {count !== undefined && count > 0 && (
                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                            view === id ? 'bg-blue-500' : 'bg-slate-700'
                        }`}>
                            {count}
                        </span>
                    )}
                </button>
            );
            
            return (
                <div className="min-h-screen flex">
                    {/* Sidebar */}
                    <aside className="w-80 bg-slate-900 border-r border-slate-800 flex flex-col shadow-2xl">
                        <div className="p-6 border-b border-slate-800">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                                    <Icon name="Ship" className="w-7 h-7 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-white">Deck Log</h1>
                                    <p className="text-xs text-slate-400">Market Harborough</p>
                                </div>
                            </div>
                            <div className="bg-slate-800 rounded-lg p-3">
                                <p className="text-xs text-slate-400 mb-1">Parade Night</p>
                                <p className="text-lg font-bold text-white">
                                    {new Date(sessionData.currentDate).toLocaleDateString('en-GB', { 
                                        weekday: 'long', 
                                        day: 'numeric', 
                                        month: 'long', 
                                        year: 'numeric' 
                                    })}
                                </p>
                            </div>
                        </div>
                        
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                            <NavItem id="dashboard" icon="LayoutDashboard" label="Dashboard" />
                            <NavItem id="quick-entry" icon="Zap" label="Quick Entry" />
                            <NavItem id="cadets" icon="Users" label="Cadets" count={stats.cadetsAboard} />
                            <NavItem id="adults" icon="UserCheck" label="Adults" count={stats.adultsAboard} />
                            <NavItem id="visitors" icon="UserPlus" label="Visitors" count={stats.visitorsAboard} />
                            <NavItem id="duties" icon="ClipboardList" label="Duties" />
                            <NavItem id="emergency" icon="AlertCircle" label="Emergency Roll" />
                            <NavItem id="data" icon="Database" label="Data & Reports" />
                        </nav>
                        
                        <div className="p-4 border-t border-slate-800">
                            <button
                                onClick={() => setView('secure')}
                                className="w-full p-3 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-all flex items-center justify-center gap-2 touch-target"
                            >
                                <Icon name="Lock" className="w-5 h-5" />
                                <span className="font-semibold">Secure Ship</span>
                            </button>
                            <p className="text-xs text-slate-500 text-center mt-2">v{APP_VERSION}</p>
                        </div>
                    </aside>
                    
                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto">
                        {view === 'dashboard' && <DashboardView 
                            stats={stats} 
                            session={currentSession} 
                            hasPersonnel={hasPersonnel} 
                            onNavigate={setView}
                            cadets={currentSession.cadets}
                            adults={currentSession.adults}
                        />}
                        {view === 'quick-entry' && <QuickEntryView 
                            cadets={currentSession.cadets}
                            adults={currentSession.adults}
                            onBulkToggle={handleBulkToggle}
                        />}
                        {view === 'cadets' && <CadetsView 
                            cadets={currentSession.cadets} 
                            onToggle={(pNumber) => toggleAttendance('cadets', pNumber)} 
                            divisions={sessionData.divisions}
                            onUpdateDivision={(pNumber, division) => updateDivision('cadets', pNumber, division)}
                        />}
                        {view === 'adults' && <AdultsView 
                            adults={currentSession.adults} 
                            onToggle={(pNumber) => toggleAttendance('adults', pNumber)}
                            divisions={sessionData.divisions}
                            onUpdateDivision={(pNumber, division) => updateDivision('adults', pNumber, division)}
                        />}
                        {view === 'visitors' && <VisitorsView visitors={currentSession.visitors} adults={currentSession.adults} onAdd={addVisitor} onRemove={removeVisitor} />}
                        {view === 'duties' && <DutiesView 
                            session={currentSession} 
                            onUpdate={updateSession} 
                            cadets={currentSession.cadets} 
                            adults={currentSession.adults}
                            divisions={sessionData.divisions}
                        />}
                        {view === 'emergency' && <EmergencyView session={currentSession} onAdd={(person) => {
                            const updatedCadets = [...currentSession.cadets, {
                                pNumber: `TEMP_${Date.now()}`,
                                rank: '',
                                name: person,
                                division: 'Unknown',
                                forceType: 'SCC',
                                status: 'aboard',
                                timeIn: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                                timeOut: null
                            }];
                            updateSession({ cadets: updatedCadets });
                        }} />}
                        {view === 'data' && <DataUtilitiesView 
                            sessionData={sessionData} 
                            setSessionData={setSessionData} 
                            setView={setView}
                            divisions={sessionData.divisions}
                            onDivisionsUpdated={handleDivisionsUpdated}
                        />}
                        {view === 'secure' && <SecureView session={currentSession} onSecure={(signature) => {
                            updateSession({
                                secured: {
                                    time: new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }),
                                    signature
                                }
                            });
                            setView('dashboard');
                        }} />}
                    </main>
                    
                    <ConfirmDialog 
                        isOpen={confirmDialog.isOpen}
                        onClose={() => setConfirmDialog({ isOpen: false })}
                        onConfirm={confirmDialog.onConfirm}
                        title={confirmDialog.title}
                        message={confirmDialog.message}
                        person={confirmDialog.person}
                    />
                </div>
            );
        };
        
        // Dashboard View
        const DashboardView = ({ stats, session, hasPersonnel, onNavigate, cadets, adults }) => {
            // Helper to get status of a person by name
            const getPersonStatus = (name) => {
                const cadet = cadets?.find(c => c.name === name);
                const adult = adults?.find(a => a.displayName === name);
                if (cadet) return cadet.status;
                if (adult) return adult.status;
                return 'unknown';
            };
            
            return (
                <div className="p-8 space-y-6">
                    <div>
                        <h2 className="text-3xl font-bold text-white mb-2">Dashboard</h2>
                        <p className="text-slate-400">Current parade night status</p>
                    </div>
                    
                    {!hasPersonnel && (
                        <div className="bg-amber-900 bg-opacity-30 border border-amber-600 rounded-xl p-6">
                            <div className="flex items-center gap-3 mb-3">
                                <Icon name="AlertCircle" className="w-6 h-6 text-amber-400" />
                                <h3 className="text-xl font-bold text-amber-400">No Personnel Data</h3>
                            </div>
                            <p className="text-amber-200 mb-4">
                                You need to import your personnel CSV file before you can track attendance.
                            </p>
                            <button
                                onClick={() => onNavigate('data')}
                                className="px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2"
                            >
                                <Icon name="Upload" className="w-5 h-5" />
                                Go to Data & Reports to Import
                            </button>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className="stat-card bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-6 border border-blue-500 shadow-xl">
                            <div className="flex items-center justify-between mb-2">
                                <Icon name="Users" className="w-8 h-8 text-blue-200" />
                                <div className="text-4xl font-bold text-white">{stats.totalAboard}</div>
                            </div>
                            <p className="text-blue-100 font-medium">Total Aboard</p>
                        </div>
                        
                        <div className="stat-card bg-gradient-to-br from-emerald-600 to-emerald-700 rounded-xl p-6 border border-emerald-500 shadow-xl">
                            <div className="flex items-center justify-between mb-2">
                                <Icon name="Users" className="w-8 h-8 text-emerald-200" />
                                <div className="text-4xl font-bold text-white">{stats.cadetsAboard}</div>
                            </div>
                            <p className="text-emerald-100 font-medium">Cadets</p>
                        </div>
                        
                        <div className="stat-card bg-gradient-to-br from-amber-600 to-amber-700 rounded-xl p-6 border border-amber-500 shadow-xl">
                            <div className="flex items-center justify-between mb-2">
                                <Icon name="UserCheck" className="w-8 h-8 text-amber-200" />
                                <div className="text-4xl font-bold text-white">{stats.adultsAboard}</div>
                            </div>
                            <p className="text-amber-100 font-medium">Adults</p>
                        </div>
                        
                        <div className="stat-card bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl p-6 border border-purple-500 shadow-xl">
                            <div className="flex items-center justify-between mb-2">
                                <Icon name="UserPlus" className="w-8 h-8 text-purple-200" />
                                <div className="text-4xl font-bold text-white">{stats.visitorsAboard}</div>
                            </div>
                            <p className="text-purple-100 font-medium">Visitors</p>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="ClipboardList" className="w-5 h-5 text-blue-400" />
                                Duty Assignments
                            </h3>
                            <div className="space-y-2">
                                {Object.keys(session.duties).length === 0 ? (
                                    <p className="text-slate-400 italic">No duties assigned yet</p>
                                ) : (
                                    Object.entries(session.duties).map(([key, value]) => {
                                        const status = getPersonStatus(value);
                                        return (
                                            <div key={key} className="flex justify-between items-center p-3 bg-slate-700 rounded-lg">
                                                <span className="text-slate-300 text-sm">{DUTY_ROLES.find(r => r.key === key)?.label || key}</span>
                                                <div className="flex items-center gap-2">
                                                    {status !== 'unknown' && (
                                                        <span className={`w-2.5 h-2.5 rounded-full ${
                                                            status === 'aboard' ? 'bg-green-500' : 'bg-slate-500'
                                                        }`}></span>
                                                    )}
                                                    <span className="text-white font-medium">{value}</span>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                        
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="Flag" className="w-5 h-5 text-emerald-400" />
                                Signal Party
                            </h3>
                            <div className="space-y-2">
                                {Object.keys(session.signalParty).length === 0 ? (
                                    <p className="text-slate-400 italic">No signal party assigned yet</p>
                                ) : (
                                    Object.entries(session.signalParty).map(([key, value]) => {
                                        const status = getPersonStatus(value);
                                        return (
                                            <div key={key} className="flex justify-between items-center p-3 bg-slate-700 rounded-lg">
                                                <span className="text-slate-300 text-sm">{SIGNAL_PARTY.find(r => r.key === key)?.label || key}</span>
                                                <div className="flex items-center gap-2">
                                                    {status !== 'unknown' && (
                                                        <span className={`w-2.5 h-2.5 rounded-full ${
                                                            status === 'aboard' ? 'bg-green-500' : 'bg-slate-500'
                                                        }`}></span>
                                                    )}
                                                    <span className="text-white font-medium">{value}</span>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {session.secured && (
                        <div className="bg-green-900 border border-green-700 rounded-xl p-6">
                            <div className="flex items-center gap-3 mb-2">
                                <Icon name="Lock" className="w-6 h-6 text-green-400" />
                                <h3 className="text-xl font-bold text-white">Ship Secured</h3>
                            </div>
                            <p className="text-green-200">Secured at {session.secured.time} by {session.secured.signature}</p>
                        </div>
                    )}
                </div>
            );
        };
        
        // Quick Entry View
        const QuickEntryView = ({ cadets, adults, onBulkToggle }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPeople, setSelectedPeople] = useState(new Set());
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false });
            
            // Combine and search all personnel
            const allPeople = [
                ...cadets.map(c => ({ ...c, type: 'cadet', displayName: c.name })),
                ...adults.map(a => ({ ...a, type: 'adult' }))
            ];
            
            const filteredPeople = searchTerm.trim() === '' ? [] : allPeople.filter(person => {
                const search = searchTerm.toLowerCase();
                const name = person.displayName.toLowerCase();
                const pNumber = person.pNumber.toLowerCase();
                return name.includes(search) || pNumber.includes(search);
            });
            
            const toggleSelection = (pNumber) => {
                const newSelected = new Set(selectedPeople);
                if (newSelected.has(pNumber)) {
                    newSelected.delete(pNumber);
                } else {
                    newSelected.add(pNumber);
                }
                setSelectedPeople(newSelected);
            };
            
            const selectAll = () => {
                setSelectedPeople(new Set(filteredPeople.map(p => p.pNumber)));
            };
            
            const clearSelection = () => {
                setSelectedPeople(new Set());
            };
            
            const handleMarkAboard = () => {
                const selectedPersonnel = allPeople.filter(p => selectedPeople.has(p.pNumber));
                const ashore = selectedPersonnel.filter(p => p.status === 'ashore');
                
                if (ashore.length === 0) {
                    alert('All selected personnel are already aboard.');
                    return;
                }
                
                setConfirmDialog({
                    isOpen: true,
                    title: `Mark ${ashore.length} ${ashore.length === 1 ? 'Person' : 'People'} as Aboard?`,
                    message: 'Confirm that the following personnel have arrived:',
                    people: ashore,
                    action: 'aboard',
                    onConfirm: () => {
                        onBulkToggle(Array.from(selectedPeople), 'aboard');
                        setSelectedPeople(new Set());
                        setConfirmDialog({ isOpen: false });
                    }
                });
            };
            
            const handleMarkAshore = () => {
                const selectedPersonnel = allPeople.filter(p => selectedPeople.has(p.pNumber));
                const aboard = selectedPersonnel.filter(p => p.status === 'aboard');
                
                if (aboard.length === 0) {
                    alert('All selected personnel are already ashore.');
                    return;
                }
                
                setConfirmDialog({
                    isOpen: true,
                    title: `Mark ${aboard.length} ${aboard.length === 1 ? 'Person' : 'People'} as Ashore?`,
                    message: 'Confirm that the following personnel have departed:',
                    people: aboard,
                    action: 'ashore',
                    onConfirm: () => {
                        onBulkToggle(Array.from(selectedPeople), 'ashore');
                        setSelectedPeople(new Set());
                        setConfirmDialog({ isOpen: false });
                    }
                });
            };
            
            const BulkConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, people }) => {
                if (!isOpen) return null;
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-slate-800 rounded-xl p-6 max-w-2xl w-full mx-4 border border-slate-700 shadow-2xl max-h-[80vh] overflow-y-auto">
                            <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                            <p className="text-slate-300 mb-4">{message}</p>
                            <div className="bg-slate-700 rounded-lg p-4 mb-4 max-h-64 overflow-y-auto">
                                {people.map(person => (
                                    <div key={person.pNumber} className="flex items-center justify-between py-2 border-b border-slate-600 last:border-0">
                                        <span className="text-white font-medium">{person.displayName}</span>
                                        <span className={`px-2 py-1 rounded text-xs font-bold ${
                                            person.type === 'cadet' ? 'bg-emerald-900 text-emerald-200' : 'bg-amber-900 text-amber-200'
                                        }`}>
                                            {person.type === 'cadet' ? 'Cadet' : 'Adult'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={onConfirm}
                                    className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all"
                                >
                                    Confirm
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white mb-2">Quick Entry</h2>
                        <p className="text-slate-400">Search and mark multiple people aboard or ashore</p>
                    </div>
                    
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 mb-6">
                        <div className="flex gap-3 mb-4">
                            <div className="flex-1">
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="Type a name or P Number to search..."
                                    className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    autoFocus
                                />
                            </div>
                            {searchTerm && (
                                <button
                                    onClick={() => {
                                        setSearchTerm('');
                                        setSelectedPeople(new Set());
                                    }}
                                    className="px-4 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-all"
                                    title="Clear search"
                                >
                                    <Icon name="X" className="w-5 h-5" />
                                </button>
                            )}
                        </div>
                        
                        {searchTerm && filteredPeople.length > 0 && (
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={selectAll}
                                    className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-semibold transition-all"
                                >
                                    Select All ({filteredPeople.length})
                                </button>
                                <button
                                    onClick={clearSelection}
                                    className="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 text-white rounded text-sm font-semibold transition-all"
                                >
                                    Clear Selection
                                </button>
                            </div>
                        )}
                    </div>
                    
                    {!searchTerm && (
                        <div className="bg-slate-800 rounded-xl p-12 border border-slate-700 text-center">
                            <Icon name="Search" className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                            <h3 className="text-xl font-bold text-slate-400 mb-2">Start Typing to Search</h3>
                            <p className="text-slate-500">Enter a surname, first name, or P Number to find personnel</p>
                        </div>
                    )}
                    
                    {searchTerm && filteredPeople.length === 0 && (
                        <div className="bg-slate-800 rounded-xl p-12 border border-slate-700 text-center">
                            <Icon name="SearchX" className="w-16 h-16 text-slate-600 mx-auto mb-4" />
                            <h3 className="text-xl font-bold text-slate-400 mb-2">No Results Found</h3>
                            <p className="text-slate-500">No personnel match "{searchTerm}"</p>
                        </div>
                    )}
                    
                    {searchTerm && filteredPeople.length > 0 && (
                        <>
                            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 mb-6">
                                <h3 className="text-lg font-bold text-white mb-4">
                                    Search Results ({filteredPeople.length})
                                </h3>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {filteredPeople.map(person => (
                                        <label
                                            key={person.pNumber}
                                            className={`flex items-center gap-3 p-4 rounded-lg border cursor-pointer transition-all ${
                                                selectedPeople.has(person.pNumber)
                                                    ? 'bg-blue-900 border-blue-600'
                                                    : person.status === 'aboard'
                                                    ? 'bg-emerald-900 bg-opacity-30 border-emerald-700'
                                                    : 'bg-slate-700 border-slate-600 hover:border-slate-500'
                                            }`}
                                        >
                                            <input
                                                type="checkbox"
                                                checked={selectedPeople.has(person.pNumber)}
                                                onChange={() => toggleSelection(person.pNumber)}
                                                className="w-5 h-5 rounded"
                                            />
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span className={`w-3 h-3 rounded-full ${
                                                        person.status === 'aboard' ? 'badge-aboard' : 'badge-ashore'
                                                    }`}></span>
                                                    <span className="text-white font-bold">{person.displayName}</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-slate-400 text-xs">{person.pNumber}</span>
                                                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                        person.type === 'cadet' ? 'bg-emerald-900 text-emerald-200' : 'bg-amber-900 text-amber-200'
                                                    }`}>
                                                        {person.type === 'cadet' ? 'Cadet' : 'Adult'}  {person.forceType}
                                                    </span>
                                                    {person.status === 'aboard' && person.timeIn && (
                                                        <span className="text-slate-400 text-xs">Aboard since {person.timeIn}</span>
                                                    )}
                                                </div>
                                            </div>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            {selectedPeople.size > 0 && (
                                <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                                    <h3 className="text-lg font-bold text-white mb-4">
                                        Actions ({selectedPeople.size} selected)
                                    </h3>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleMarkAboard}
                                            className="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                        >
                                            <Icon name="CheckCircle" className="w-5 h-5" />
                                            Mark Aboard
                                        </button>
                                        <button
                                            onClick={handleMarkAshore}
                                            className="flex-1 px-6 py-3 bg-slate-600 hover:bg-slate-500 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                        >
                                            <Icon name="XCircle" className="w-5 h-5" />
                                            Mark Ashore
                                        </button>
                                    </div>
                                </div>
                            )}
                        </>
                    )}
                    
                    <BulkConfirmDialog
                        isOpen={confirmDialog.isOpen}
                        onClose={() => setConfirmDialog({ isOpen: false })}
                        onConfirm={confirmDialog.onConfirm}
                        title={confirmDialog.title}
                        message={confirmDialog.message}
                        people={confirmDialog.people || []}
                    />
                </div>
            );
        };
        
        // Cadets View
        const CadetsView = ({ cadets, onToggle, divisions, onUpdateDivision }) => {
            const [showDivisionDialog, setShowDivisionDialog] = useState(null);
            
            // Group by force type and sort alphabetically
            const groupedCadets = {
                'Juniors': cadets.filter(c => c.forceType === 'Juniors').sort((a, b) => {
                    const surnameCompare = a.surname.localeCompare(b.surname);
                    if (surnameCompare !== 0) return surnameCompare;
                    return a.firstName.localeCompare(b.firstName);
                }),
                'SCC': cadets.filter(c => c.forceType === 'SCC').sort((a, b) => {
                    const surnameCompare = a.surname.localeCompare(b.surname);
                    if (surnameCompare !== 0) return surnameCompare;
                    return a.firstName.localeCompare(b.firstName);
                }),
                'RMC': cadets.filter(c => c.forceType === 'RMC').sort((a, b) => {
                    const surnameCompare = a.surname.localeCompare(b.surname);
                    if (surnameCompare !== 0) return surnameCompare;
                    return a.firstName.localeCompare(b.firstName);
                })
            };
            
            const DivisionDialog = ({ cadet }) => {
                const [selectedDivision, setSelectedDivision] = useState(cadet.division || '');
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700 shadow-2xl">
                            <h3 className="text-xl font-bold text-white mb-2">Assign Division</h3>
                            <p className="text-slate-300 mb-4">{cadet.name}</p>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-300 mb-2">Division</label>
                                <select
                                    value={selectedDivision}
                                    onChange={(e) => setSelectedDivision(e.target.value)}
                                    className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">No Division</option>
                                    {divisions.map(div => (
                                        <option key={div} value={div}>{div}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        onUpdateDivision(cadet.pNumber, selectedDivision);
                                        setShowDivisionDialog(null);
                                    }}
                                    className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all"
                                >
                                    Save
                                </button>
                                <button
                                    onClick={() => setShowDivisionDialog(null)}
                                    className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white mb-2">Cadets</h2>
                        <p className="text-slate-400">{cadets.filter(c => c.status === 'aboard').length} of {cadets.length} aboard</p>
                    </div>
                    
                    {Object.entries(groupedCadets).map(([forceType, cadetsInGroup]) => {
                        if (cadetsInGroup.length === 0) return null;
                        
                        return (
                            <div key={forceType} className="mb-6">
                                <h3 className="text-xl font-bold text-blue-400 mb-3 flex items-center gap-2">
                                    <Icon name="Shield" className="w-5 h-5" />
                                    {forceType} ({cadetsInGroup.length})
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {cadetsInGroup.map(cadet => (
                                        <div
                                            key={cadet.pNumber}
                                            className={`p-4 rounded-xl border transition-all ${
                                                cadet.status === 'aboard'
                                                    ? 'bg-emerald-900 border-emerald-600'
                                                    : 'bg-slate-800 border-slate-700'
                                            }`}
                                        >
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`w-3 h-3 rounded-full ${
                                                            cadet.status === 'aboard' ? 'badge-aboard' : 'badge-ashore'
                                                        }`}></span>
                                                        <span className="text-white font-bold">{cadet.name}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <p className="text-slate-400 text-xs">{cadet.pNumber}</p>
                                                        {cadet.division && (
                                                            <span className="px-2 py-0.5 bg-blue-900 text-blue-200 text-xs rounded">
                                                                {cadet.division}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            {cadet.timeIn && (
                                                <div className="text-xs text-slate-400 mb-2">
                                                    In: {cadet.timeIn}
                                                    {cadet.timeOut && ` | Out: ${cadet.timeOut}`}
                                                </div>
                                            )}
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => onToggle(cadet.pNumber)}
                                                    className="flex-1 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold transition-all"
                                                >
                                                    {cadet.status === 'aboard' ? 'Mark Ashore' : 'Mark Aboard'}
                                                </button>
                                                <button
                                                    onClick={() => setShowDivisionDialog(cadet)}
                                                    className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs font-semibold transition-all"
                                                    title="Assign Division"
                                                >
                                                    <Icon name="Tag" className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                    
                    {showDivisionDialog && <DivisionDialog cadet={showDivisionDialog} />}
                </div>
            );
        };
        
        // Adults View
        const AdultsView = ({ adults, onToggle, divisions, onUpdateDivision }) => {
            const [showDivisionDialog, setShowDivisionDialog] = useState(null);
            
            // Group by force type and sort alphabetically
            const groupedAdults = {
                'Juniors': adults.filter(a => a.forceType === 'Juniors').sort((a, b) => {
                    const surnameCompare = a.surname.localeCompare(b.surname);
                    if (surnameCompare !== 0) return surnameCompare;
                    return a.firstName.localeCompare(b.firstName);
                }),
                'SCC': adults.filter(a => a.forceType === 'SCC').sort((a, b) => {
                    const surnameCompare = a.surname.localeCompare(b.surname);
                    if (surnameCompare !== 0) return surnameCompare;
                    return a.firstName.localeCompare(b.firstName);
                }),
                'RMC': adults.filter(a => a.forceType === 'RMC').sort((a, b) => {
                    const surnameCompare = a.surname.localeCompare(b.surname);
                    if (surnameCompare !== 0) return surnameCompare;
                    return a.firstName.localeCompare(b.firstName);
                })
            };
            
            const DivisionDialog = ({ adult }) => {
                const [selectedDivision, setSelectedDivision] = useState(adult.division || '');
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700 shadow-2xl">
                            <h3 className="text-xl font-bold text-white mb-2">Assign Division</h3>
                            <p className="text-slate-300 mb-4">{adult.displayName}</p>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-300 mb-2">Division</label>
                                <select
                                    value={selectedDivision}
                                    onChange={(e) => setSelectedDivision(e.target.value)}
                                    className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">No Division</option>
                                    {divisions.map(div => (
                                        <option key={div} value={div}>{div}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => {
                                        onUpdateDivision(adult.pNumber, selectedDivision);
                                        setShowDivisionDialog(null);
                                    }}
                                    className="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all"
                                >
                                    Save
                                </button>
                                <button
                                    onClick={() => setShowDivisionDialog(null)}
                                    className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white mb-2">Adult Volunteers</h2>
                        <p className="text-slate-400">{adults.filter(a => a.status === 'aboard').length} of {adults.length} aboard</p>
                    </div>
                    
                    {Object.entries(groupedAdults).map(([forceType, adultsInGroup]) => {
                        if (adultsInGroup.length === 0) return null;
                        
                        return (
                            <div key={forceType} className="mb-6">
                                <h3 className="text-xl font-bold text-amber-400 mb-3 flex items-center gap-2">
                                    <Icon name="UserCheck" className="w-5 h-5" />
                                    {forceType} ({adultsInGroup.length})
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {adultsInGroup.map(adult => (
                                        <div
                                            key={adult.pNumber}
                                            className={`p-4 rounded-xl border transition-all ${
                                                adult.status === 'aboard'
                                                    ? 'bg-amber-900 border-amber-600'
                                                    : 'bg-slate-800 border-slate-700'
                                            }`}
                                        >
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`w-3 h-3 rounded-full ${
                                                            adult.status === 'aboard' ? 'badge-aboard' : 'badge-ashore'
                                                        }`}></span>
                                                        <span className="text-white font-bold">{adult.displayName}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <p className="text-slate-400 text-xs">{adult.pNumber}</p>
                                                        {adult.division && (
                                                            <span className="px-2 py-0.5 bg-amber-900 text-amber-200 text-xs rounded">
                                                                {adult.division}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            {adult.timeIn && (
                                                <div className="text-xs text-slate-400 mb-2">
                                                    In: {adult.timeIn}
                                                    {adult.timeOut && ` | Out: ${adult.timeOut}`}
                                                </div>
                                            )}
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => onToggle(adult.pNumber)}
                                                    className="flex-1 px-3 py-1.5 bg-amber-600 hover:bg-amber-700 text-white rounded text-xs font-semibold transition-all"
                                                >
                                                    {adult.status === 'aboard' ? 'Mark Ashore' : 'Mark Aboard'}
                                                </button>
                                                <button
                                                    onClick={() => setShowDivisionDialog(adult)}
                                                    className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs font-semibold transition-all"
                                                    title="Assign Division"
                                                >
                                                    <Icon name="Tag" className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                    
                    {showDivisionDialog && <DivisionDialog adult={showDivisionDialog} />}
                </div>
            );
        };
        
        // Visitors View
        const VisitorsView = ({ visitors, adults, onAdd, onRemove }) => {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                toSee: '',
                safetyBriefingBy: '',
                signature: ''
            });
            
            const activeVisitors = visitors.filter(v => !v.timeOut);
            const departedVisitors = visitors.filter(v => v.timeOut);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd(formData);
                setFormData({ name: '', toSee: '', safetyBriefingBy: '', signature: '' });
                setShowForm(false);
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6 flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold text-white mb-2">Visitors</h2>
                            <p className="text-slate-400">{activeVisitors.length} currently aboard</p>
                        </div>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold flex items-center gap-2 touch-target transition-all"
                        >
                            <Icon name="UserPlus" className="w-5 h-5" />
                            Add Visitor
                        </button>
                    </div>
                    
                    {showForm && (
                        <div className="mb-6 bg-slate-800 rounded-xl p-6 border border-slate-700 slide-in">
                            <h3 className="text-xl font-bold text-white mb-4">New Visitor</h3>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Name</label>
                                        <input
                                            type="text"
                                            value={formData.name}
                                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                                            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">To See</label>
                                        <input
                                            type="text"
                                            value={formData.toSee}
                                            onChange={(e) => setFormData({...formData, toSee: e.target.value})}
                                            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Safety Briefing By</label>
                                        <select
                                            value={formData.safetyBriefingBy}
                                            onChange={(e) => setFormData({...formData, safetyBriefingBy: e.target.value})}
                                            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            required
                                        >
                                            <option value="">Select adult</option>
                                            {adults.filter(a => a.status === 'aboard').map(adult => (
                                                <option key={adult.pNumber} value={adult.displayName}>
                                                    {adult.displayName}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">Signature</label>
                                        <input
                                            type="text"
                                            value={formData.signature}
                                            onChange={(e) => setFormData({...formData, signature: e.target.value})}
                                            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            required
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button type="submit" className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all">
                                        Add Visitor
                                    </button>
                                    <button type="button" onClick={() => setShowForm(false)} className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                    
                    {activeVisitors.length > 0 && (
                        <div className="mb-6">
                            <h3 className="text-xl font-bold text-white mb-3">Currently Aboard</h3>
                            <div className="space-y-3">
                                {activeVisitors.map(visitor => (
                                    <div key={visitor.id} className="bg-purple-900 border border-purple-600 rounded-xl p-4">
                                        <div className="flex items-start justify-between">
                                            <div className="flex-1">
                                                <h4 className="text-white font-bold text-lg mb-1">{visitor.name}</h4>
                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                    <p className="text-purple-200">To see: {visitor.toSee}</p>
                                                    <p className="text-purple-200">Time in: {visitor.timeIn}</p>
                                                    <p className="text-purple-200">Briefed by: {visitor.safetyBriefingBy}</p>
                                                    <p className="text-purple-200">Signature: {visitor.signature}</p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => onRemove(visitor.id)}
                                                className="ml-4 px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white rounded-lg font-semibold transition-all touch-target"
                                            >
                                                Sign Out
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {departedVisitors.length > 0 && (
                        <div>
                            <h3 className="text-xl font-bold text-white mb-3">Departed</h3>
                            <div className="space-y-2">
                                {departedVisitors.map(visitor => (
                                    <div key={visitor.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4">
                                        <h4 className="text-slate-300 font-bold mb-1">{visitor.name}</h4>
                                        <div className="grid grid-cols-3 gap-2 text-sm text-slate-400">
                                            <p>In: {visitor.timeIn}</p>
                                            <p>Out: {visitor.timeOut}</p>
                                            <p>Saw: {visitor.toSee}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Duties View
        const DutiesView = ({ session, onUpdate, cadets, adults, divisions }) => {
            const [duties, setDuties] = useState(session.duties || {});
            const [signalParty, setSignalParty] = useState(session.signalParty || {});
            
            // All cadets sorted alphabetically (not just aboard)
            const allCadets = [...cadets].sort((a, b) => {
                const surnameCompare = a.surname.localeCompare(b.surname);
                if (surnameCompare !== 0) return surnameCompare;
                return a.firstName.localeCompare(b.firstName);
            });
            
            // Filter adults for OOD - only those with valid ranks
            const oodEligibleAdults = adults.filter(a => {
                const rank = a.rank.trim();
                // Check if rank matches OOD_RANKS or contains RNR/RMR variants
                return OOD_RANKS.some(validRank => {
                    if (rank === validRank) return true;
                    // Handle RNR/RMR variants
                    if (validRank.includes('(SCC)')) {
                        const baseRank = validRank.replace(' (SCC)', '');
                        return rank === `${baseRank} (SCC) RNR` || rank === `${baseRank} (SCC) RMR`;
                    }
                    return false;
                });
            }).sort((a, b) => {
                const surnameCompare = a.surname.localeCompare(b.surname);
                if (surnameCompare !== 0) return surnameCompare;
                return a.firstName.localeCompare(b.firstName);
            });
            
            const handleDutyChange = (key, value) => {
                const newDuties = { ...duties, [key]: value };
                setDuties(newDuties);
                onUpdate({ duties: newDuties });
            };
            
            const handleSignalChange = (key, value) => {
                const newSignalParty = { ...signalParty, [key]: value };
                setSignalParty(newSignalParty);
                onUpdate({ signalParty: newSignalParty });
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white mb-2">Duty Assignments</h2>
                        <p className="text-slate-400">Assign roles for tonight's parade</p>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="ClipboardList" className="w-5 h-5 text-blue-400" />
                                Duty Watch
                            </h3>
                            <div className="space-y-4">
                                {DUTY_ROLES.map(role => (
                                    <div key={role.key}>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">{role.label}</label>
                                        <select
                                            value={duties[role.key] || ''}
                                            onChange={(e) => handleDutyChange(role.key, e.target.value)}
                                            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 touch-target"
                                        >
                                            <option value="">Select {role.label}</option>
                                            {role.type === 'division' && divisions.map(div => (
                                                <option key={div} value={div}>{div}</option>
                                            ))}
                                            {role.type === 'cadet' && allCadets.map(cadet => (
                                                <option key={cadet.pNumber} value={cadet.name}>
                                                    {cadet.status === 'aboard' ? '' : ''} {cadet.name}
                                                </option>
                                            ))}
                                            {role.type === 'adult' && oodEligibleAdults.map(adult => (
                                                <option key={adult.pNumber} value={adult.displayName}>
                                                    {adult.status === 'aboard' ? '' : ''} {adult.displayName}
                                                </option>
                                            ))}
                                        </select>
                                        {role.type === 'division' && divisions.length === 0 && (
                                            <p className="text-xs text-amber-400 mt-1">
                                                No divisions defined. Add divisions in Data & Reports.
                                            </p>
                                        )}
                                        {role.type === 'adult' && oodEligibleAdults.length === 0 && (
                                            <p className="text-xs text-amber-400 mt-1">
                                                No eligible adults (requires rank: PO, PPO, CPO, Sgt, PSgt, CSgt, SLt, Lt, or Lt Cdr)
                                            </p>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="Flag" className="w-5 h-5 text-emerald-400" />
                                Signal Party
                            </h3>
                            <div className="space-y-4">
                                {SIGNAL_PARTY.map(role => (
                                    <div key={role.key}>
                                        <label className="block text-sm font-medium text-slate-300 mb-2">{role.label}</label>
                                        <select
                                            value={signalParty[role.key] || ''}
                                            onChange={(e) => handleSignalChange(role.key, e.target.value)}
                                            className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500 touch-target"
                                        >
                                            <option value="">Select cadet</option>
                                            {allCadets.map(cadet => (
                                                <option key={cadet.pNumber} value={cadet.name}>
                                                    {cadet.status === 'aboard' ? '' : ''} {cadet.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Emergency View
        const EmergencyView = ({ session, onAdd }) => {
            const [newPerson, setNewPerson] = useState('');
            const allAboard = [
                ...session.cadets.filter(c => c.status === 'aboard').map(c => ({ ...c, type: 'Cadet', displayName: c.name })),
                ...session.adults.filter(a => a.status === 'aboard').map(a => ({ ...a, type: 'Adult' })),
                ...session.visitors.filter(v => !v.timeOut).map(v => ({ ...v, type: 'Visitor', displayName: v.name }))
            ];
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <div className="flex items-center gap-4 mb-4">
                            <div className="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center emergency-pulse">
                                <Icon name="AlertCircle" className="w-8 h-8 text-white" />
                            </div>
                            <div>
                                <h2 className="text-3xl font-bold text-white">Emergency Roll Call</h2>
                                <p className="text-slate-400">Total personnel: {allAboard.length}</p>
                            </div>
                        </div>
                        <div className="bg-red-900 border border-red-700 rounded-xl p-4">
                            <p className="text-red-200 text-sm">
                                This list shows everyone marked as aboard. If someone is present but not on the list, add them below.
                            </p>
                        </div>
                    </div>
                    
                    <div className="mb-6 bg-slate-800 rounded-xl p-6 border border-slate-700">
                        <h3 className="text-xl font-bold text-white mb-4">Add Missing Person</h3>
                        <div className="flex gap-3">
                            <input
                                type="text"
                                value={newPerson}
                                onChange={(e) => setNewPerson(e.target.value)}
                                placeholder="Enter name"
                                className="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-red-500"
                            />
                            <button
                                onClick={() => {
                                    if (newPerson.trim()) {
                                        onAdd(newPerson);
                                        setNewPerson('');
                                    }
                                }}
                                className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-all touch-target"
                            >
                                Add to Roll
                            </button>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {allAboard.map((person, idx) => (
                            <div key={idx} className="bg-slate-800 border border-slate-700 rounded-xl p-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className={`px-2 py-1 rounded text-xs font-bold ${
                                        person.type === 'Cadet' ? 'bg-emerald-900 text-emerald-200' :
                                        person.type === 'Adult' ? 'bg-amber-900 text-amber-200' :
                                        'bg-purple-900 text-purple-200'
                                    }`}>
                                        {person.type}
                                    </span>
                                </div>
                                <p className="text-white font-bold">
                                    {person.displayName}
                                </p>
                                <p className="text-slate-400 text-xs">{person.pNumber || 'No P Number'}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // Secure View
        const SecureView = ({ session, onSecure }) => {
            const [signature, setSignature] = useState('');
            const [dutyNCO, setDutyNCO] = useState('');
            const [ood, setOOD] = useState('');
            
            const handleSecure = () => {
                if (!dutyNCO || !ood) {
                    alert('Please enter both Duty NCO and OOD signatures');
                    return;
                }
                onSecure(`Duty NCO: ${dutyNCO}, OOD: ${ood}`);
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white mb-2">Secure Ship</h2>
                        <p className="text-slate-400">Complete end of night procedures</p>
                    </div>
                    
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 max-w-2xl mx-auto">
                        <div className="mb-6">
                            <h3 className="text-xl font-bold text-white mb-4">Checklist</h3>
                            <div className="space-y-3 text-slate-300">
                                <label className="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" className="w-5 h-5" />
                                    <span>All buildings and containers locked</span>
                                </label>
                                <label className="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" className="w-5 h-5" />
                                    <span>All boats secured</span>
                                </label>
                                <label className="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" className="w-5 h-5" />
                                    <span>Unit cleaned to acceptable standard</span>
                                </label>
                                <label className="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" className="w-5 h-5" />
                                    <span>All personnel departed</span>
                                </label>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Duty NCO Signature</label>
                                <input
                                    type="text"
                                    value={dutyNCO}
                                    onChange={(e) => setDutyNCO(e.target.value)}
                                    className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Officer of the Day Signature</label>
                                <input
                                    type="text"
                                    value={ood}
                                    onChange={(e) => setOOD(e.target.value)}
                                    className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        </div>
                        
                        <button
                            onClick={handleSecure}
                            className="w-full mt-6 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold text-lg transition-all touch-target"
                        >
                            Secure Ship
                        </button>
                    </div>
                </div>
            );
        };
        
        // Data Utilities View
        const DataUtilitiesView = ({ sessionData, setSessionData, setView, divisions, onDivisionsUpdated }) => {
            const [showImport, setShowImport] = useState(false);
            const [showDivisionsManager, setShowDivisionsManager] = useState(false);
            
            const currentSession = sessionData.sessions[sessionData.currentDate];
            
            const exportBackup = () => {
                const backup = {
                    version: APP_VERSION,
                    exportDate: new Date().toISOString(),
                    sessions: sessionData.sessions,
                    personnel: sessionData.personnel,
                    divisions: divisions
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `deck-log-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const importBackup = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (confirm('This will restore all data from the backup. Continue?')) {
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(backup.sessions));
                            localStorage.setItem(PERSONNEL_KEY, JSON.stringify(backup.personnel));
                            if (backup.divisions) {
                                localStorage.setItem(DIVISIONS_KEY, JSON.stringify(backup.divisions));
                            }
                            window.location.reload();
                        }
                    } catch (error) {
                        alert('Error reading backup file. Please check the file format.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            
            const DivisionsManager = () => {
                const [localDivisions, setLocalDivisions] = useState([...divisions]);
                const [newDivision, setNewDivision] = useState('');
                
                const addDivision = () => {
                    if (newDivision.trim() && !localDivisions.includes(newDivision.trim())) {
                        setLocalDivisions([...localDivisions, newDivision.trim()]);
                        setNewDivision('');
                    }
                };
                
                const removeDivision = (division) => {
                    if (confirm(`Remove division "${division}"? This will not affect existing assignments.`)) {
                        setLocalDivisions(localDivisions.filter(d => d !== division));
                    }
                };
                
                const saveDivisions = () => {
                    onDivisionsUpdated(localDivisions);
                    setShowDivisionsManager(false);
                };
                
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                        <div className="bg-slate-800 rounded-xl p-6 max-w-2xl w-full border border-slate-700 shadow-2xl">
                            <h3 className="text-2xl font-bold text-white mb-4">Manage Divisions</h3>
                            
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-300 mb-2">Add New Division</label>
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={newDivision}
                                        onChange={(e) => setNewDivision(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && addDivision()}
                                        placeholder="Division name"
                                        className="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        onClick={addDivision}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all"
                                    >
                                        Add
                                    </button>
                                </div>
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-slate-300 mb-2">Current Divisions</label>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {localDivisions.map(division => (
                                        <div key={division} className="flex items-center justify-between p-3 bg-slate-700 rounded-lg">
                                            <span className="text-white font-medium">{division}</span>
                                            <button
                                                onClick={() => removeDivision(division)}
                                                className="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-semibold transition-all"
                                            >
                                                Remove
                                            </button>
                                        </div>
                                    ))}
                                    {localDivisions.length === 0 && (
                                        <p className="text-slate-400 italic text-center py-4">No divisions defined</p>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    onClick={saveDivisions}
                                    className="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-all"
                                >
                                    Save Changes
                                </button>
                                <button
                                    onClick={() => setShowDivisionsManager(false)}
                                    className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const exportSessionCSV = () => {
                const rows = [
                    ['Type', 'P Number', 'Name', 'Status', 'Time In', 'Time Out']
                ];
                
                currentSession.cadets.forEach(c => {
                    if (c.status === 'aboard' || c.timeIn) {
                        rows.push(['Cadet', c.pNumber, c.name, c.status, c.timeIn || '', c.timeOut || '']);
                    }
                });
                
                currentSession.adults.forEach(a => {
                    if (a.status === 'aboard' || a.timeIn) {
                        rows.push(['Adult', a.pNumber, a.displayName, a.status, a.timeIn || '', a.timeOut || '']);
                    }
                });
                
                currentSession.visitors.forEach(v => {
                    rows.push(['Visitor', 'N/A', v.name, v.timeOut ? 'departed' : 'aboard', v.timeIn, v.timeOut || '']);
                });
                
                const csv = rows.map(row => row.join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-${sessionData.currentDate}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const generatePDFReport = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('Deck Log Report', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Date: ${new Date(sessionData.currentDate).toLocaleDateString('en-GB', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                })}`, 20, 30);
                
                let yPos = 45;
                
                // Summary
                doc.setFontSize(14);
                doc.text('Summary', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                const cadetsAboard = currentSession.cadets.filter(c => c.status === 'aboard').length;
                const adultsAboard = currentSession.adults.filter(a => a.status === 'aboard').length;
                const visitorsAboard = currentSession.visitors.filter(v => !v.timeOut).length;
                
                doc.text(`Total Aboard: ${cadetsAboard + adultsAboard + visitorsAboard}`, 25, yPos);
                yPos += 7;
                doc.text(`Cadets: ${cadetsAboard}`, 25, yPos);
                yPos += 7;
                doc.text(`Adults: ${adultsAboard}`, 25, yPos);
                yPos += 7;
                doc.text(`Visitors: ${visitorsAboard}`, 25, yPos);
                yPos += 15;
                
                // Duties
                if (Object.keys(currentSession.duties).length > 0) {
                    doc.setFontSize(14);
                    doc.text('Duty Assignments', 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(11);
                    Object.entries(currentSession.duties).forEach(([key, value]) => {
                        const role = DUTY_ROLES.find(r => r.key === key);
                        doc.text(`${role?.label || key}: ${value}`, 25, yPos);
                        yPos += 7;
                    });
                    yPos += 8;
                }
                
                // Signal Party
                if (Object.keys(currentSession.signalParty).length > 0) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text('Signal Party', 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(11);
                    Object.entries(currentSession.signalParty).forEach(([key, value]) => {
                        const role = SIGNAL_PARTY.find(r => r.key === key);
                        doc.text(`${role?.label || key}: ${value}`, 25, yPos);
                        yPos += 7;
                    });
                    yPos += 8;
                }
                
                // Attendance Tables
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Cadets Table
                doc.setFontSize(14);
                doc.text('Cadet Attendance', 20, yPos);
                yPos += 5;
                
                const cadetData = currentSession.cadets
                    .filter(c => c.status === 'aboard' || c.timeIn)
                    .map(c => [c.name, c.pNumber, c.timeIn || '', c.timeOut || '']);
                
                if (cadetData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['Name', 'P Number', 'Time In', 'Time Out']],
                        body: cadetData,
                        theme: 'grid',
                        styles: { fontSize: 10 }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }
                
                // Adults Table
                if (yPos > 220) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.text('Adult Attendance', 20, yPos);
                yPos += 5;
                
                const adultData = currentSession.adults
                    .filter(a => a.status === 'aboard' || a.timeIn)
                    .map(a => [a.displayName, a.pNumber, a.timeIn || '', a.timeOut || '']);
                
                if (adultData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        head: [['Name', 'P Number', 'Time In', 'Time Out']],
                        body: adultData,
                        theme: 'grid',
                        styles: { fontSize: 10 }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }
                
                // Visitors Table
                if (currentSession.visitors.length > 0) {
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text('Visitors', 20, yPos);
                    yPos += 5;
                    
                    const visitorData = currentSession.visitors.map(v => [
                        v.name,
                        v.toSee,
                        v.timeIn,
                        v.timeOut || 'Still aboard',
                        v.safetyBriefingBy
                    ]);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Name', 'To See', 'Time In', 'Time Out', 'Briefed By']],
                        body: visitorData,
                        theme: 'grid',
                        styles: { fontSize: 9 }
                    });
                }
                
                // Secure info
                if (currentSession.secured) {
                    if (doc.lastAutoTable && doc.lastAutoTable.finalY > 250) {
                        doc.addPage();
                        yPos = 20;
                    } else {
                        yPos = doc.lastAutoTable ? doc.lastAutoTable.finalY + 15 : yPos + 10;
                    }
                    
                    doc.setFontSize(14);
                    doc.text('Ship Secured', 20, yPos);
                    yPos += 10;
                    doc.setFontSize(11);
                    doc.text(`Time: ${currentSession.secured.time}`, 25, yPos);
                    yPos += 7;
                    doc.text(`By: ${currentSession.secured.signature}`, 25, yPos);
                }
                
                doc.save(`deck-log-${sessionData.currentDate}.pdf`);
            };
            
            const clearAllData = () => {
                if (confirm('This will delete ALL data including personnel and all sessions. Are you sure?')) {
                    if (confirm('This action cannot be undone. Really delete everything?')) {
                        localStorage.clear();
                        window.location.reload();
                    }
                }
            };
            
            return (
                <div className="p-8">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white mb-2">Data & Reports</h2>
                        <p className="text-slate-400">Manage your data and generate reports</p>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Backup & Restore */}
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="Database" className="w-5 h-5 text-blue-400" />
                                Backup & Restore
                            </h3>
                            <div className="space-y-3">
                                <button
                                    onClick={exportBackup}
                                    className="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon name="Download" className="w-5 h-5" />
                                    Export Backup
                                </button>
                                
                                <label className="block">
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={(e) => e.target.files[0] && importBackup(e.target.files[0])}
                                        className="hidden"
                                        id="backup-restore"
                                    />
                                    <div className="w-full p-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2 cursor-pointer">
                                        <Icon name="Upload" className="w-5 h-5" />
                                        Restore Backup
                                    </div>
                                </label>
                                
                                <p className="text-xs text-slate-400">
                                    Backup includes all sessions and personnel data
                                </p>
                            </div>
                        </div>
                        
                        {/* Reports */}
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="FileText" className="w-5 h-5 text-emerald-400" />
                                Current Session Reports
                            </h3>
                            <div className="space-y-3">
                                <button
                                    onClick={generatePDFReport}
                                    className="w-full p-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon name="FileText" className="w-5 h-5" />
                                    Generate PDF Report
                                </button>
                                
                                <button
                                    onClick={exportSessionCSV}
                                    className="w-full p-3 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon name="Table" className="w-5 h-5" />
                                    Export Attendance CSV
                                </button>
                                
                                <p className="text-xs text-slate-400">
                                    Reports generated for {new Date(sessionData.currentDate).toLocaleDateString('en-GB')}
                                </p>
                            </div>
                        </div>
                        
                        {/* Personnel Management */}
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="Users" className="w-5 h-5 text-purple-400" />
                                Personnel Management
                            </h3>
                            <div className="space-y-3">
                                <button
                                    onClick={() => setShowImport(true)}
                                    className="w-full p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon name="Upload" className="w-5 h-5" />
                                    Re-import Personnel CSV
                                </button>
                                
                                <div className="bg-slate-700 rounded-lg p-3">
                                    <p className="text-sm text-slate-300 mb-1">Current Personnel:</p>
                                    <p className="text-white font-bold">{sessionData.personnel.cadets.length} Cadets</p>
                                    <p className="text-white font-bold">{sessionData.personnel.adults.length} Adults</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Divisions Management */}
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                                <Icon name="Tag" className="w-5 h-5 text-cyan-400" />
                                Divisions Management
                            </h3>
                            <div className="space-y-3">
                                <button
                                    onClick={() => setShowDivisionsManager(true)}
                                    className="w-full p-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon name="Settings" className="w-5 h-5" />
                                    Manage Divisions
                                </button>
                                
                                <div className="bg-slate-700 rounded-lg p-3">
                                    <p className="text-sm text-slate-300 mb-2">Current Divisions:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {divisions.map(div => (
                                            <span key={div} className="px-2 py-1 bg-cyan-900 text-cyan-200 text-xs rounded">
                                                {div}
                                            </span>
                                        ))}
                                        {divisions.length === 0 && (
                                            <span className="text-slate-400 italic text-xs">No divisions defined</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Danger Zone */}
                        <div className="bg-red-900 bg-opacity-20 rounded-xl p-6 border border-red-700">
                            <h3 className="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                                <Icon name="AlertTriangle" className="w-5 h-5" />
                                Danger Zone
                            </h3>
                            <div className="space-y-3">
                                <button
                                    onClick={clearAllData}
                                    className="w-full p-3 bg-red-700 hover:bg-red-600 text-white rounded-lg font-semibold transition-all flex items-center justify-center gap-2"
                                >
                                    <Icon name="Trash2" className="w-5 h-5" />
                                    Delete All Data
                                </button>
                                
                                <p className="text-xs text-red-300">
                                    Warning: This will permanently delete all sessions and personnel data
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    {showImport && (
                        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div className="max-w-2xl w-full">
                                <CSVUpload 
                                    onDataLoaded={(personnel) => {
                                        localStorage.setItem(PERSONNEL_KEY, JSON.stringify(personnel));
                                        window.location.reload();
                                    }}
                                    onCancel={() => setShowImport(false)}
                                />
                            </div>
                        </div>
                    )}
                    
                    {showDivisionsManager && <DivisionsManager />}
                </div>
            );
        };
        
        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        console.log(`Deck Log v${APP_VERSION} loaded successfully`);
    </script>
</body>
</html>
