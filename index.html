<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Cadet Training Dashboard</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { background-color: #f1f5f9; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        /* Planner Table Styles */
        .planner-table th, .planner-table td {
            white-space: nowrap;
        }
        .planner-container {
            overflow-x: auto;
            max-height: 75vh;
        }
        /* Sticky Headers */
        .planner-table thead {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .planner-table th {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* Sticky First Column (Module Titles) */
        .planner-table th:first-child,
        .planner-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 60 !important; /* Ensure module titles dominate horizontal scroll */
            background-color: #FFFFFF !important; /* Force solid white background for row cells */
            border-right: 2px solid #e2e8f0;
        }
        /* Corner Cell (Module / Cadet) fix */
        .planner-table thead tr th:first-child {
            z-index: 70 !important; /* Ensure corner is highest layer in header row, dominating top scroll AND left scroll */
            background-color: #f1f5f9 !important; /* Force background of header row color (slate-100) */
        }
        /* End Corner Cell fix */

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .bg-passed { background-color: #0DAC50 !important; }
        
        /* Spec Level Colors */
        .spec-basic { background-color: #fdba74 !important; color: #7c2d12; font-weight: 700; font-size: 12px; }
        .spec-int { background-color: #94a3b8 !important; color: #ffffff; font-weight: 700; font-size: 12px; }
        .spec-adv { background-color: #fcd34d !important; color: #78350f; font-weight: 800; font-size: 12px; }
        .spec-junior { background-color: #f1f5f9 !important; color: #94a3b8; font-style: italic; font-size: 11px; }
        .spec-none { color: #cbd5e1; }

        /* Waterborne Status Colors - UPDATED SPECIFICITY to override sticky column white background */
        .planner-table td.status-cox-pending { background-color: #add8e6 !important; color: black !important; } /* Light Blue */
        .planner-table td.status-cox-awarded { background-color: #003366 !important; color: white !important; } /* Navy Blue */
        .planner-table td.status-master-pending { background-color: #ffffe0 !important; color: black !important; } /* Light Yellow */
        .planner-table td.status-master-awarded { background-color: #ffd700 !important; color: black !important; } /* Gold */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Ensure React is available globally
        const { useState, useEffect, useMemo, Component } = React;
        
        // --- 1. GLOBAL CONSTANTS ---
        const DATA_VERSION = "1.0.3"; 

        const RANK_IMG_MAP = {
            "Petty Officer Cadet": { sleeve: "scc_cadet_sleeve_petty_officer.webp", slide: "scc_cadet_shoulder_petty_officer.webp" },
            "Leading Cadet": { sleeve: "scc_cadet_sleeve_leading_cadet.webp", slide: "scc_cadet_shoulder_leading_cadet.webp" },
            "Able Cadet": { sleeve: "scc_cadet_sleeve_able_cadet.webp", slide: "scc_cadet_shoulder_able_cadet.webp" },
            "Ordinary Cadet": { sleeve: "scc_cadet_sleeve_ordinary_cadet.webp", slide: "scc_cadet_shoulder_ordinary_cadet.webp" },
            "Cadet 1st Class": { sleeve: "scc_cadet_sleeve_1st_class.webp", slide: "scc_cadet_shoulder_1st_class.webp" },
            "Cadet": { sleeve: "scc_cadet_sleeve_cadet.webp", slide: "scc_cadet_shoulder_cadet.webp" },
            "Cadet Sergeant": { sleeve: "rmc_rank_sergeant.webp", slide: "rmc_slide_cadet_sergeant.webp" },
            "Corporal": { sleeve: "rmc_rank_corporal.webp", slide: "rmc_slide_corporal.webp" },
            "Lance Corporal": { sleeve: "rmc_rank_lance_corporal.webp", slide: "rmc_slide_lance_corporal.webp" },
            "Marine Cadet": { sleeve: "rmc_rank_marine_cadet.webp", slide: "rmc_slide_marine_cadet.webp" }, 
            "Marine": { sleeve: "rmc_rank_marine_cadet.webp", slide: "rmc_slide_marine_cadet.webp" }, 
            "Marine Recruit": null,
            "Marine Cadet 1st Class": { sleeve: "rmc_rank_marine_cadet.webp", slide: "rmc_slide_marine_cadet.webp" }, 
            "Recruit": null,
            "New Entry Cadet": null,
            "Leading Junior Cadet": { sleeve: "scc_junior_leading.webp" },
            "Able Junior Cadet": { sleeve: "scc_junior_star.webp", count: 2 },
            "Junior Cadet 1st Class": { sleeve: "scc_junior_star.webp" },
            "Junior Cadet": { sleeve: "scc_junior_cadet.webp" }
        };

        const BADGE_MAP = {
            "Drill - Advanced": "scc_prof_drill_advanced.webp",
            "Drill - Intermediate": "scc_prof_drill_intermediate.webp",
            "Drill - Basic": "scc_prof_drill_basic.webp",
            "Seamanship - Advanced": "scc_prof_seamanship_advanced.webp",
            "Seamanship - Intermediate": "scc_prof_seamanship_intermediate.webp",
            "Seamanship - Basic": "scc_prof_seamanship_basic.webp",
            "First Aid - Advanced": "scc_prof_first_aid_advanced.webp",
            "First Aid - Intermediate": "scc_prof_first_aid_intermediate.webp",
            "First Aid - Basic": "scc_prof_first_aid_basic.webp",
            "Marine Engineering - Advanced": "scc_prof_marine_eng_advanced.webp",
            "Marine Engineering Mechanical - Advanced": "scc_prof_me_mechanical_advanced.webp",
            "Marine Engineering Electrical - Advanced": "scc_prof_me_electrical_advanced.webp",
            "Marine Engineering - Intermediate": "scc_prof_marine_eng_intermediate.webp",
            "Marine Engineering - Basic": "scc_prof_marine_eng_basic.webp",
            "Navigation - Cadet Instructor": "scc_prof_navigation_instructor.webp",
            "Navigation - Advanced": "scc_prof_navigation_advanced.webp",
            "Navigation - Intermediate": "scc_prof_navigation_intermediate.webp",
            "Navigation - Basic": "scc_prof_navigation_basic.webp",
            "CIS Info Sys - Advanced": "scc_prof_cis_infosys_advanced.webp",
            "CIS Info Sys - Intermediate": "scc_prof_cis_infosys_intermediate.webp",
            "CIS Info Sys - Basic": "scc_prof_cis_infosys_basic.webp",
            "CIS Radio - Advanced": "scc_prof_cis_radio_advanced.webp",
            "CIS Radio - Intermediate": "scc_prof_cis_radio_intermediate.webp",
            "CIS Radio - Basic": "scc_prof_cis_infosys_basic.webp", 
            "CIS Principle Instructor": "scc_prof_cis_principle_instructor.webp",
            "Catering - Advanced": "scc_prof_catering_advanced.webp",
            "Catering - Intermediate": "scc_prof_catering_intermediate.webp",
            "Catering - Basic": "scc_prof_catering_basic.webp",
            "Stewarding - Advanced": "scc_prof_stewarding_advanced.webp",
            "Stewarding - Basic": "scc_prof_stewarding_basic.webp",
            "Physical Training - Instructor": "scc_prof_pt_instructor.webp",
            "Physical Training - Advanced": "scc_prof_pt_advanced.webp",
            "Physical Training - Intermediate": "scc_prof_pt_intermediate.webp",
            "Physical Training - Basic": "scc_prof_pt_basic.webp",
            "Rowing Instructor": "scc_prof_rowing_instructor.webp",
            "Rowing Coxswain": "scc_prof_rowing_coxswain.webp",
            "Rowing Supervised Coxswain": "scc_prof_rowing_supervised_cox.webp",
            "Rowing Competent Crew": "scc_prof_rowing_competent_crew.webp",
            "Powerboat Instructor": "scc_prof_powerboat_instructor.webp",
            "RYA Powerboat Intermediate": "scc_prof_powerboat_intermediate.webp",
            "RYA Safety Boat": "scc_prof_powerboat_safety.webp",
            "RYA Powerboat Level 2": "scc_prof_powerboat_level2.webp",
            "RYA Powerboat Level 1": "scc_prof_powerboat_level1.webp",
            "Paddlesport Instructor": "scc_prof_paddlesport_instructor.webp",
            "Paddle Discipline Specific": "scc_prof_paddle_specific.webp",
            "Paddle FSRT/PSRC": "scc_prof_paddle_fsrt.webp",
            "Paddle Explore Award": "scc_prof_paddle_explore.webp",
            "Paddle Discover Award": "scc_prof_paddle_discover.webp",
            "Dinghy Instructor": "scc_prof_sailing_dinghy_instructor.webp",
            "Spinnaker/Seamanship": "scc_prof_sailing_spinnaker.webp",
            "Sailing with Spinnakers": "scc_prof_sailing_spinnaker.webp",
            "Seamanship Skills": "scc_prof_sailing_spinnaker.webp",
            "Start Racing": "scc_prof_sailing_spinnaker.webp",
            "Performance Sailing": "scc_prof_sailing_spinnaker.webp",
            "Day Sailing": "scc_prof_sailing_spinnaker.webp",
            "Sailing Stage 4 / Level 3": "scc_prof_sailing_stage4.webp",
            "Sailing Stage 3 / Level 2": "scc_prof_sailing_stage3.webp",
            "Sailing Stage 2 / Level 1": "scc_prof_sailing_stage2.webp",
            "Windsurfing Instructor": "scc_prof_windsurfing_instructor.webp",
            "Windsurfing Stage 4": "scc_prof_windsurfing_stage4.webp",
            "Windsurfing Stage 3": "scc_prof_windsurfing_stage3.webp",
            "Windsurfing Stage 2": "scc_prof_windsurfing_stage2.webp",
            "Windsurfing Stage 1": "scc_prof_windsurfing_stage1.webp",
            "Master Coxswain": "scc_prof_master_coxswain.webp",
            "Cadet Coxswain": "scc_prof_cadet_coxswain.webp",
            "Offshore Power Watch Leader": "scc_prof_offshore_power_watch_leader.webp",
            "Offshore Power Seaman": "scc_prof_offshore_power_seaman.webp",
            "Offshore Power Grade 2": "scc_prof_offshore_power_grade2.webp",
            "Offshore Power Grade 1": "scc_prof_offshore_power_grade1.webp",
            "Offshore Sailing Watch Leader": "scc_prof_offshore_sailing_watch_leader.webp",
            "Offshore Sailing Seaman": "scc_prof_offshore_sailing_seaman.webp",
            "Offshore Sailing Grade 2": "scc_prof_offshore_sailing_grade2.webp",
            "Offshore Sailing Grade 1": "scc_prof_offshore_sailing_grade1.webp",
            "Campcraft (Advanced)": "scc_prof_campcraft_advanced.webp",
            "Campcraft (Intermediate)": "scc_prof_campcraft_intermediate.webp",
            "Campcraft (Basic)": "scc_prof_campcraft_basic.webp",
            "Climbing (Advanced)": "scc_prof_climbing_advanced.webp",
            "Climbing (Intermediate)": "scc_prof_climbing_intermediate.webp",
            "Climbing (Basic)": "scc_prof_climbing_basic.webp",
            "Mountain Biking (Advanced)": "scc_prof_mountain_biking_advanced.webp",
            "Mountain Biking (Intermediate)": "scc_prof_mountain_biking_intermediate.webp",
            "Mountain Biking (Basic)": "scc_prof_mountain_biking_basic.webp",
            "Semaphore": "scc_prof_semaphore.webp",
            "Radio Amateur": "scc_prof_radio_amateur.webp",
            "Morse Code": "scc_prof_morse.webp",
            "Meteorology": "scc_prof_meteorology.webp",
            "Air Rifle Marksman": "scc_prof_shooting_air_marksman.webp",
            "Air Rifle Advanced": "scc_prof_shooting_air_advanced.webp",
            "Air Rifle Basic": "scc_prof_shooting_air_basic.webp",
            "Small Bore Marksman": "scc_prof_shooting_smallbore_marksman.webp",
            "Small Bore Advanced": "scc_prof_shooting_smallbore_advanced.webp",
            "Small Bore Basic": "scc_prof_shooting_smallbore_basic.webp",
            "Full Bore Marksman": "scc_prof_shooting_fullbore_marksman.webp",
            "Full Bore Advanced": "scc_prof_shooting_fullbore_advanced.webp",
            "Full Bore Basic": "scc_prof_shooting_fullbore_basic.webp",
            "Bugler": "scc_prof_bugler.webp",
            "Musician": "scc_prof_musician.webp",
            "Drummer": "scc_prof_drummer.webp",
            "Diving (Cadet)": "scc_prof_diving.webp",
            "Piping Proficiency": "scc_prof_piping_proficiency.webp",
            "Piping Basic": "scc_prof_piping_basic.webp",
            "Wings (Standard)": "scc_award_wings_standard.png",
            "Gold Wings": "scc_award_wings_gold.png",
            "Silver Wings": "scc_award_wings_silver.png",
            "Bronze Wings": "scc_award_wings_bronze.png",
            "First Sea Lord's Cadet": "scc_award_first_sea_lords_cadet.webp",
            "Lord Lieutenant's Cadet": "scc_award_lord_lieutenants_cadet.webp",
            "Lord Mayor's Cadet": "scc_award_lord_mayors_cadet.webp",
            "Swim Test": "scc_swim.webp",
            "No Swim Test": "scc_NO_SWIM.webp",
            "Canada Trophy": "scc_award_canada_trophy.webp",
            "Commodore's Broad Pennant": "scc_award_commodores_pennant.webp",
            "DofE Gold": "scc_award_dofe_gold.webp",
            "DofE Silver": "scc_award_dofe_silver.webp",
            "DofE Bronze": "scc_award_dofe_bronze.webp",
            "BTEC Level 1": "scc_award_btec1.webp",
            "BTEC Level 2": "scc_award_btec2.webp",
            "Aviation Gold Wings": "scc_award_wings_gold.webp",
            "Aviation Silver Wings": "scc_award_wings_silver.webp",
            "Aviation Bronze Wings": "scc_award_wings_bronze.webp",
            "Aviation Wings (Standard)": "scc_award_wings_standard.webp",
            "SCC - JSC Red Unit Activities Badge": "scc_junior_section_red.webp",
            "SCC - JSC Blue Waterborne Activities Badge": "scc_junior_section_blue.webp",
            "SCC - JSC Green Outdoor & Recreation Activities Badge": "scc_junior_section_green.webp",
            "SCC - JSC Yellow Community & Citizenship Activities Badge": "scc_junior_section_yellow.webp",
            "SCC - JSC STEM Unit Activities Badge": "scc_junior_stem.webp",
            "SCC - JSC Commodores Broad Pennant": "scc_award_commodores_pennant.webp"
        };
        
        const Icons = {
            Upload: lucide.icons.Upload,
            Users: lucide.icons.Users,
            Award: lucide.icons.Award,
            BookOpen: lucide.icons.BookOpen,
            CheckCircle: lucide.icons.CheckCircle,
            FileText: lucide.icons.FileText,
            ChevronDown: lucide.icons.ChevronDown,
            ChevronUp: lucide.icons.ChevronUp,
            ChevronLeft: lucide.icons.ChevronLeft,
            ChevronRight: lucide.icons.ChevronRight,
            Calendar: lucide.icons.Calendar,
            Save: lucide.icons.Save,
            Trash2: lucide.icons.Trash2,
            X: lucide.icons.X,
            AlertCircle: lucide.icons.AlertCircle,
            Anchor: lucide.icons.Anchor,
            Shield: lucide.icons.Shield,
            Target: lucide.icons.Target,
            Lightbulb: lucide.icons.Lightbulb,
            User: lucide.icons.User,
            Star: lucide.icons.Star,
            Command: lucide.icons.Command,
            ShipWheel: lucide.icons.ShipWheel,
            ChartGantt: lucide.icons.ChartGantt,
            Home: lucide.icons.Home
        };

        // --- 2. SYLLABUS & CONFIG ---

        const SCC_SYLLABUS = {
            "New Entry Cadet": { 
                "Core": [ 
                    { code: "NE01", title: "Unit Introduction" }, 
                    { code: "NE02", title: "General Sea Cadets Terms" }, 
                    { code: "NE03", title: "Sea Cadet Promise and Values" }, 
                    { code: "NE04", title: "Ranks, Rates and Promotion" }, 
                    { code: "NE05", title: "Introduction to Cadet Wellbeing" }, 
                    { code: "NE06", title: "Introduction to Expedition Skill: Weather" }, 
                    { code: "NE07", title: "Sea Cadet Water Safety Test" }, 
                    { code: "NE08", title: "Introduction to Bends and Hitches" }, 
                    { code: "NE09", title: "Introduction to Foot Drill" }, 
                    { code: "NE10", title: "History of your Uniform" }, 
                    { code: "NE11", title: "Uniform, Boot and Shoe Care" }, 
                    { code: "NE12", title: "Basic Saluting and Compliments" }, 
                    { code: "NE13", title: "Introduction to Marching, Halting and Falling in and Out of a Squad" }, 
                    { code: "NE14", title: "SHOUT (Introduction to the Safeguarding Pocket Guide)" }, 
                    { code: "NE15", title: "Intro to Sea Cadet Portal, Opportunities, Specialisations and Proficiencies" }, 
                    { code: "NE16", title: "Cadet Action Plan" } 
                ] 
            },
            "Cadet": { 
                "Core CTP": [ 
                    { code: "CAV01", title: "Intro to Cadet Voice" }, 
                    { code: "CK01", title: "Sea Cadets and Unit History" }, 
                    { code: "CK02", title: "Royal Navy and Royal Marines Ranks and Rates" }, 
                    { code: "CK03", title: "Unit Duties and Ship's Routine" }, 
                    { code: "CK04", title: "Today's Naval Terms and Customs" }, 
                    { code: "CK05", title: "Types of Ship" }, 
                    { code: "CK06", title: "Phonetic Alphabet" }, 
                    { code: "CK07", title: "Introduction to the Duke of Edinburgh's Award" }, 
                    { code: "CK08", title: "Introduction to Specialisations and Proficiencies" }, 
                    { code: "CV01", title: "Commitment" }, 
                    { code: "CWB01", title: "Cadet Wellbeing: Stress" },
                ],
                "Drill": [ 
                    { code: "DR01", title: "Revision of Basic Drill" }, 
                    { code: "DR02", title: "Marching Theory" }, 
                    { code: "DR03", title: "Marching Practice" }, 
                    { code: "DR04", title: "Squad Theory" } 
                ], 
                "Expedition": [ 
                    { code: "ES01", title: "Environment and Countryside Code" }, 
                    { code: "ES02", title: "Suitable Clothing and Equipment" }, 
                    { code: "ES03", title: "Kit Packing and Carrying" }, 
                    { code: "ES04", title: "Conventional Signs" } 
                ], 
                "First Aid": [ 
                    { code: "FA01", title: "Introduction to Basic First Aid: Coping in an Emergency" }, 
                    { code: "FA02", title: "Communication and Casualty Care" }, 
                    { code: "FA03", title: "Primary Survey and Recovery 1" }, 
                    { code: "FA04", title: "Primary Survey and Recovery 2" }, 
                    { code: "FA05", title: "Minor Bleeding" }, 
                    { code: "FA06", title: "Bleeding Shock 1" }, 
                    { code: "FA07", "title": "Bleeding Shock 2" }, 
                    { code: "FA08", title: "Bites, Stings and Foreign Objects" }, 
                    { code: "FA09", title: "Choking" }, 
                    { code: "FA10", title: "Chest Pains" }, 
                    { code: "FA11", title: "Resuscitation 1" }, 
                    { code: "FA12", title: "Resuscitation 2" } 
                ], 
                "Health & Safety": [{ code: "HS01", title: "Health and Safety Signage" }], 
                "Meteorology": [ 
                    { code: "MT01", title: "Introduction to Meteorology: Why Weather?" }, 
                    { code: "MT02", title: "Getting the Measure of Things: Measuring Instruments" }, 
                    { code: "MT03", title: "Make your own Weather Instruments" } 
                ], 
                "Navigation": [
                    { code: "NAV01", title: "Basic Collision Regulations: Rules of the Road 1" },
                    { code: "NAV02", title: "Charts: How do you make a round thing square?" },
                    { code: "NAV03", title: "Introduction to Tides" }
                ],
                "Piping": [{ code: "PIP01", title: "Introduction to the Boatswain's Call" }], 
                "Recreational": [ 
                    { code: "RA01", title: "Recreational Activity 1" }, 
                    { code: "RA02", title: "Recreational Activity 2" }, 
                    { code: "RA03", title: "Recreational Activity 3" }, 
                    { code: "RA04", title: "Recreational Activity 4" }, 
                    { code: "RA05", title: "Recreational Activity 5" } 
                ], 
                "Seamanship": [ 
                    { code: "SM01", title: "General Sea Terms and Parts of a Ship" }, 
                    { code: "SM02", title: "Essential Bends and Hitches" }, 
                    { code: "SM03", title: "Introduction to Safe Handling of Ropes" }, 
                    { code: "SM04", title: "Bowline, Clove Hitch and Sheet Bend" } 
                ], 
                "Waterborne": [ 
                    { code: "WB01", title: "Waterborne Activity 1" }, 
                    { code: "WB02", title: "Practical Waterborne 2" }, 
                    { code: "WB03", title: "Practical Waterborne 3" }, 
                    { code: "WB04", "title": "Practical Waterborne 4" } 
                ] 
            }
            ,
            "Cadet 1st Class": { 
                "Core CTP": [
                    { code: "CA02", title: "Community Activities" },
                    { code: "CAV02", title: "Cadet Voice: Prioritisation and District Meetings" },
                    { code: "CK09", "title": "Royal Navy History" }, 
                    { code: "CK10", "title": "Times, Watches and Bells" }, 
                    { code: "CK11", "title": "Practical Piping: Unit Ceremonial" }, 
                    { code: "CK12", "title": "Ranks and Rates of RAF and Army" },
                    { code: "CV02", "title": "Self Discipline and Honesty and Integrity" }, 
                    { code: "CV03", "title": "Cadet Development Evening" },
                    { code: "CWB02", title: "Healthy Habits" }
                ], 
                "Drill": [ 
                    { code: "DR05", "title": "Squad Drill: Direction and Speed Changes" }, 
                    { code: "DR06", "title": "Squad Drill: Formation Changes" }, 
                    { code: "DR07", "title": "Introduction to Parade Drill" } 
                ], 
                "Expedition": [ 
                    { code: "ES05", "title": "Introduction to Mapwork: Grid References" }, 
                    { code: "ES06", "title": "Introduction to Mapwork: Measuring Distance" }, 
                    { code: "ES07", "title": "Contours and Reliefs" }, 
                    { code: "ES08", "title": "Compass and Bearings" } 
                ],
                "First Aid": [ 
                    { code: "FA13", title: "Introduction to Intermediate First Aid: First Aid Kits" }, 
                    { code: "FA14", title: "Asthma and Low Blood Sugar" }, 
                    { code: "FA15", title: "Electric Shock, Burns and Scalds" }, 
                    { code: "FA16", title: "Fainting and Seizures" }, 
                    { code: "FA17", title: "Poisons and Severe Allergic Reaction" }, 
                    { code: "FA18", title: "Hypothermia and Heat Exhaustion" }, 
                    { code: "FA19", title: "Bone, Muscle and Joint Injuries" }, 
                    { code: "FA20", title: "Head Injuries" }, 
                    { code: "FA21", title: "Spinal Injury" }, 
                    { code: "FA22", title: "Revision - Bleeding (Severe) and Shock" }, 
                    { code: "FA23", title: "Revision-Primary survey & Recovery position" }, 
                    { code: "FA24", title: "Revision-Resuscitation (Adult CPR)" }, 
                    { code: "FA25", title: "Formal Assessment - part 1" }, 
                    { code: "FA26", title: "Formal Assessment-part 2" } 
                ], 
                "Health & Safety": [{ code: "HS02", title: "Unit Health and Safety Check" }], 
                "Leadership": [ 
                    { code: "LT01", title: "What Does Good Teamwork Look Like?" }, 
                    { code: "LT02", title: "Practical Teamwork Tasks: Inital Attempt" }, 
                    { code: "LT03", title: "Practical Leadership Task: Lessons Learnt" } 
                ], 
                "Meteorology": [ 
                    { code: "MT04", title: "Cloud Watching - Introduction to Clouds" }, 
                    { code: "MT05", title: "Highs, Lows and Charts" }, 
                    { code: "MT06", title: "A Gentle Breeze or a Destructive Force" } 
                ], 
                "Piping": [{ code: "PIP02", title: "Unit Calls" }], 
                "Recreational": [ 
                    { code: "RA06", title: "Recreational Activity 6" }, 
                    { code: "RA07", title: "Recreational Activity 7" }, 
                    { code: "RA08", title: "Recreational Activity 8" }, 
                    { code: "RA09", title: "Recreational Activity 9" } 
                ], 
                "Seamanship": [ 
                    { code: "SM05", title: "Cadet Review and Types of Rope" }, 
                    { code: "SM06", title: "Fisherman's Bend and Timber Hitch, Double Sheet Bend and Rolling Hitches" }, 
                    { code: "SM07", title: "Introduction to Blocks and Tackles" }, 
                    { code: "SM08", title: "Heaving Lines" }, 
                    { code: "SM09", title: "Cadet First Class Consolidation Session" } 
                ], 
                "Waterborne": [ 
                    { code: "WB05", title: "Practical Waterborne 5" }, 
                    { code: "WB06", title: "Practical Waterborne 6" }, 
                    { code: "WB07", title: "Practical Waterborne 7" } 
                ] 
            }
            ,
            "Ordinary Cadet": { 
                "Core CTP": [
                    { code: "CA03", title: "Community Activity 3" },
                    { code: "CAV03", title: "Cadet Voice and Unit Management Team" },
                    { code: "CK13", title: "Maritime Careers" }, 
                    { code: "CK14", title: "Vocational Qualifications" }, 
                    { code: "CK15", title: "Naval Battles: Research Project" }, 
                    { code: "CK16", title: "Naval Battles: Show and Tell" },
                    { code: "CV04", title: "Loyalty, Respect and Courage" }, 
                    { code: "CV05", title: "Cadet Development Session" },
                    { code: "CWB03", title: "Wellbeing and Communication" }
                ],
                "Drill": [ 
                    { code: "DR08", title: "Fitting, Wearing and Cleaning White-Webbing" }, 
                    { code: "DR09", title: "Safety and Familiarisation" }, 
                    { code: "DR10", title: "Rifle Drill: Guard" }, 
                    { code: "DR11", title: "Rifle Drill: Ceremonial" }, 
                    { code: "DR12", title: "Drill Revision" } 
                ], 
                "Expedition": [ 
                    { code: "ES09", title: "Tent and Campsite Selection" }, 
                    { code: "ES10", title: "Food and Cooking" }, 
                    { code: "ES11", title: "Emergency Action Plan" }, 
                    { code: "ES12", title: "Route Planning" } 
                ], 
                "Health & Safety": [{ code: "HS03", title: "Fire Prevention" }], 
                "Leadership": [ 
                    { code: "LT04", title: "Leadership Styles" }, 
                    { code: "LT05", title: "Leadership Project Planning" }, 
                    { code: "LT06", title: "Leadership Project Delivery and Reflection" } 
                ], 
                "Meteorology": [ 
                    { code: "MT07", title: "Local Winds (Meteorology in Context)" }, 
                    { code: "MT08", title: "Warm Fronts and Cold Fronts" }, 
                    { code: "MT09", title: "The Shipping Forecast" }, 
                    { code: "MT10", title: "On the Lookout: Weather Observations" } 
                ], 
                "Recreational": [ 
                    { code: "RA10", title: "Recreational Activity 1" }, 
                    { code: "RA11", title: "Recreational Activity 2" }, 
                    { code: "RA12", title: "Recreational Activity 3" }, 
                    { code: "RA13", title: "Recreational Activity 4" } 
                ], 
                "Seamanship": [ 
                    { code: "SM10", "title": "Parts of a Tackle and Rigging" }, 
                    { code: "SM11", "title": "Handling of Ropes" }, 
                    { code: "SM12", "title": "Consolidation Session" } 
                ], 
                "Waterborne": [ 
                    { code: "WB08", title: "Waterborne Activity 8" }, 
                    { code: "WB09", title: "Waterborne Activity 9" }, 
                    { code: "WB10", title: "Waterborne Activity 10" }, 
                    { code: "WB11", title: "Waterborne Activity 11" } 
                ] 
            }
            ,
            "Able Cadet": { 
                "Peer Educator": [ 
                    { code: "BP01", title: "What is a Peer Educator?" }, 
                    { code: "BP02", title: "Roles and Responsibilities of a Peer Educator" }, 
                    { code: "BP03", title: "Learning Styles" }, 
                    { code: "BP04", title: "Skills of an Instructor" }, 
                    { code: "BP05", title: "Session Planning" }, 
                    { code: "BP06", title: "Giving and Receiving Feedback" }, 
                    { code: "BP07", title: "Keeping Peers Engaged by Making Learning Fun" }, 
                    { code: "BP08", title: "Using Feedback to Aid Reflection" }, 
                ], 
                "Community": [ 
                    { code: "CA04", title: "Community Activity 4" }, 
                    { code: "CA05", title: "Community Activity 5" } 
                ], 
                "Corps Knowledge": [ 
                    { code: "CK17", title: "My Senior Cadet Pathway" }, 
                    { code: "CK18", "title": "Organisation of the SCC at Area level" }, 
                    { code: "CK19", "title": "Safeguarding as a Senior Cadet" }, 
                    { code: "CK20", "title": "Volunteer for the Day" } 
                ], 
                "Drill": [ 
                    { code: "DR13", "title": "Basic Instruction Theory: CLAP" }, 
                    { code: "DR14", "title": "Basic Instruction Theory: DEIP" }, 
                    { code: "DR15", "title": "Basic Instruction: Delivery" }, 
                    { code: "DR16", "title": "Promotion Board Drill Practice" } 
                ], 
                "Leadership": [ 
                    { code: "LT07", title: "What Makes a Great Leader?" }, 
                    { code: "LT08", title: "Leadership Styles" }, 
                    { code: "LT09", title: "Being a Positive Role Model" }, 
                    { code: "LT10", title: "Facilitating Cadet Discussions" }, 
                    { code: "LT11", title: "Reflection and Self-Development" }, 
                    { code: "LT12", "title": "The Difference between a Leader and a Manager" } 
                ], 
                "Personal Development": [ 
                    { code: "PD01", title: "Demonstrating my Skills: Mock Promotion Board Interview" }, 
                    { code: "PD02", title: "Communication Skills: Written, Email, Phone" }, 
                    { code: "PD03", title: "Presentation and Group Discussion Skills" }
                ], 
                "Waterborne": [ 
                    { code: "WB12", title: "Waterborne Activity 12" }, 
                    { code: "WB13", title: "Waterborne Activity 13" }, 
                    { code: "WB14", title: "Waterborne Activity 14" }, 
                    { code: "WB15", "title": "Waterborne Activity 15" } 
                ] 
            }
            ,
            "Leading Cadet": { 
                "Advanced Peer Educator": [ 
                    { code: "AP01", title: "Roles of the Advanced Peer Educator" }, 
                    { code: "AP02", title: "Communication Skills" }, 
                    { code: "AP03", title: "Team Working and 1-2-1 Skills" }, 
                    { code: "AP04", title: "Motivating and Encouraging Peers" }, 
                    { code: "AP05", title: "Health and Safety in the Classroom" }, 
                    { code: "AP06", title: "Making Learning Inclusive" }, 
                    { code: "AP07", title: "Leadership" }, 
                    { code: "AP08", title: "Using Subject Knowledge" }, 
                    { code: "AP09", title: "What Next and Evaluation" }, 
                    { code: "AP10", title: "Advanced Peer Educator (Development)" }, 
                    { code: "AP11", title: "Advanced Peer Educator (Delivery)" }
                ], 
                "Community": [ 
                    { code: "CA06", title: "Community Activity 1" }, 
                    { code: "CA07", title: "Community Activity 2" }
                ], 
                "Corps Knowledge": [ 
                    { code: "CK21", title: "Supporting a Unit Fundraising Activity" }, 
                    { code: "CK22", title: "Growing My Unit" }, 
                    { code: "CK23", title: "Roles and Responsibilities of a Petty Officer Cadet and Cadet Instructor" }, 
                    { code: "CK24", title: "Organisation of the Sea Cadet Corps at National level" }
                ], 
                "Drill": [ 
                    { code: "DR17", title: "Drill: Instruction Theory" }, 
                    { code: "DR18", title: "Drill: Instruction Delivery" }, 
                    { code: "DR19", title: "Drill: Fault Finding" }, 
                    { code: "DR20", title: "Drill: Final Consolidation" }
                ], 
                "Leadership": [ 
                    { code: "LT13", title: "Active Listening" }, 
                    { code: "LT14", title: "Emotional Intelligence" }, 
                    { code: "LT15", title: "Conflict Resolution" }, 
                    { code: "LT16", title: "Motivating Self and Others" }, 
                    { code: "LT17", title: "How to Plan Effectively" }
                ], 
                "Personal Development": [ 
                    { code: "PD04", title: "CVs and Cover Letters" }, 
                    { code: "PD05", title: "Presenting my Sea Cadet Experience" }, 
                    { code: "PD06", title: "Interview Skills" }
                ], 
                "Waterborne": [ 
                    { code: "WB16", title: "Practical waterborne activity" }, 
                    { code: "WB17", title: "Practical waterborne activity" }, 
                    { code: "WB18", title: "Practical waterborne activity" }, 
                    { code: "WB19", title: "Practical waterborne activity" }
                ] 
            },
            "Petty Officer Cadet": { 
                "Cadet Leadership & Transition": [
                    { code: "POC01", title: "Personal Development Plan" },
                    { code: "POC02", title: "Shadow in unit Volunteer roles" },
                    { code: "POC03", title: "Meeting with your CO" },
                    { code: "POC04", title: "Meet a cadet turned volunteer" },
                    { code: "POC05", title: "What will change session" },
                    { code: "POC06", title: "Act as a Volunteer" },
                    { code: "POC07", title: "Write a Risk Assessment" },
                    { code: "POC08", title: "Organise an event" },
                    { code: "POC09", title: "Lead the units cadet voice meeting" },
                    { code: "POC10", title: "Attend a UMT Meeting" },
                    { code: "POC11", title: "Use Programmes Online" },
                    { code: "POC12", title: "Session Creation" },
                    { code: "POC13", title: "Plan Leadership Tasks" },
                    { code: "POC14", title: "Shadow roles on beyond unit training" },
                    { code: "POC15", title: "Specialisation/Proficiency Instructor Qualification" }
                ]
            }
        };

        const RMC_SYLLABUS = {
            "Marine Recruit": {
                "Recruit Section 1": [
                    { code: "R1-1", title: "Unit Tour, Health and Safety and Who's Who" },
                    { code: "R1-2", title: "Colours Routine and History" },
                    { code: "R1-3", title: "Ranks and Rates of the SCC and RMC" },
                    { code: "R1-4", title: "Duty Personnel, Watches and Bells" },
                    { code: "R2-1", title: "'SHOUT' Introduction to the Sea Cadets Pocket Safeguarding Guide" },
                    { code: "R3-1", title: "Basic Parts of a Ship and Jackspeak" },
                    { code: "R3-2", title: "Introduction to Bends and Hitches" },
                    { code: "R3-3", title: "Safety By the Water & Cadet Forces Water Safety Test" },
                    { code: "R4-1", title: "Cadet Wellbeing" },
                    { code: "R5-1", title: "Values of the Sea Cadet Corps and RMC Ethos" },
                    { code: "R5-2", title: "Cadet portal and Wider Sea-Cadet Opportunities" },
                    { code: "R5-3", title: "Your Royal Marines Cadet Experience" },
                    { code: "R5-4", title: "The Cadet Action Plan" }
                ],
                "Recruit Section 2": [
                    { code: "R6-1", title: "Wearing and Maintaining PCS, Introduction to Dress Regulations" },
                    { code: "R7-1", title: "Introduction to Basic Foot Drill" },
                    { code: "R7-2", title: "Introduction to Marching" },
                    { code: "R7-3", title: "Inclining, Saluting and Falling In" },
                    { code: "R8-1", title: "The Royal Marines 1664 - the Present Day" },
                    { code: "R8-2", title: "Royal Marines Family and Terminology" },
                    { code: "R9-1", title: "Introduction to Physical Activity and Health" },
                    { code: "R9-2", title: "Effective Warm-Up, Cool Down and Safe Lifting" },
                    { code: "R9-3", title: "Components of Fitness" },
                    { code: "R10-1", title: "Introduction to Skill at Arms and Shooting in the RMC" }
                ]
            },
            "Marine Cadet": {
                "L1: Personal Development": [
                    { code: "L1-1", title: "Royal Marines Cadets' Company ORBAT" },
                    { code: "L1-2", title: "The Cadet Action Plan" },
                    { code: "L1-3", title: "Cadet Personal Development Evening" }
                ],
                "L2: Drill": [
                    { code: "L2-1", title: "Sizing, Changing Step in Quick Time and Saluting on the March" },
                    { code: "L2-2", title: "Right and Left Turn in Quick Time and About Turn in Quick Time" },
                    { code: "L2-3", title: "Mark Time, Halt and Change Step, Mark Time and Forward From Quick Time" }
                ],
                "L3: Casualty Info": [
                    { code: "L3-1", title: "Introduction to Basic First Aid: Coping in an Emergency" },
                    { code: "L3-2", title: "Introduction to Basic First Aid: Coping in an Emergency" }
                ],
                "L4: Map Reading": [
                    { code: "L4-1", title: "What is a Map and Care of a Map" },
                    { code: "L4-2", title: "Conventional Signs" },
                    { code: "L4-3", title: "Grid References" },
                    { code: "L4-4", title: "Scale and Navigation" },
                    { code: "L4-5", title: "Contours and Relief" },
                    { code: "L4-6", title: "Direction and Bearings" },
                    { code: "L4-7", title: "Lightweight Compass" },
                    { code: "L4-8", title: "Relating Map to Ground" },
                    { code: "L4-A", title: "Day March Practical" }
                ],
                "L5: Fieldcraft": [
                    { code: "L5-1", title: "Introduction to Fieldcraft and the Rifle Section" },
                    { code: "L5-2", title: "Preparation, Packing and Maintaining Personal Equipment" },
                    { code: "L5-3", title: "Feeding in the Field" },
                    { code: "L5-4", title: "The Two Man Shelter" },
                    { code: "L5-5", title: "Why Things are Seen" },
                    { code: "L5-6", title: "Personal Camouflage and Concealment" },
                    { code: "L5-7", title: "Observation" },
                    { code: "L5-8", title: "Judging Distance" },
                    { code: "L5-9", title: "Indication of Targets" },
                    { code: "L5-10", title: "Range Cards" },
                    { code: "L5-11", title: "Duties of a Sentry" },
                    { code: "L5-12", title: "Moving With or Without Personal Weapons" },
                    { code: "L5-13", title: "Field Signals" },
                    { code: "L5-14", title: "Elementary Obstacle Crossing" },
                    { code: "L5-15", title: "Selecting a route across country" },
                    { code: "L5-16", title: "Introduction to Night Training and Movement" },
                    { code: "L5-17", title: "Stalking" },
                    { code: "L5-18", title: "Reaction to Fire Control Orders" },
                    { code: "L5-19", title: "Keeping Direction at Night" },
                    { code: "L5-20", title: "Individual Fire and Movement (F&M)" },
                    { code: "L5-21", title: "Operating as a Member of a Fire Team and Section" },
                    { code: "L5-22", title: "Issuing Fire Control Orders (FCOs)" },
                    { code: "L5-A", title: "Overnight Practical" }
                ],
                "L6: Uniform": [
                    { code: "L6-1", title: "Care and Issue of Blues" },
                    { code: "L6-2", title: "Fitting of PLCE Webbing" }
                ],
                "L7: Leadership": [
                    { code: "L7-1", title: "Roles and Responsibilities of a Cadet Lance Corporal" },
                    { code: "L7-2", title: "Community Activity - Support an RMC Fundraising event" }
                ],
                "L8: PT": [
                    { code: "L8-1", title: "Effects of Exercise" },
                    { code: "L8-2", title: "Principles of Training" },
                    { code: "L8-3", title: "Personal Fitness Development - Aerobic Fitness" }
                ],
                "L9: The RM": [
                    { code: "L9-1", title: "RM Badge, Colours and Marches" },
                    { code: "L9-2", title: "RM Victoria Cross" }
                ],
                "L10: Waterborne": [
                    { code: "L10-1", title: "Waterborne Activity" },
                    { code: "L10-2", title: "Bowline, Clove Hitch and Sheet bend" }
                ],
                "L11: Expedition": [
                    { code: "L11-1", title: "Duke of Edinburgh's Award Requirements" },
                    { code: "L11-2", title: "Countryside Code" },
                    { code: "L11-3", title: "Equipment/Clothing Selection and Use" },
                    { code: "L11-4", title: "Packing and Lifting a Rucksack" },
                    { code: "L11-5", title: "Campsite Selection" },
                    { code: "L11-6", title: "Food and Cooking" },
                    { code: "L11-7", title: "Health and Safety" },
                    { code: "L11-8", title: "Weather" },
                    { code: "L11-9", title: "Simple Route Card" },
                    { code: "L11-10", title: "Expedition Planning" },
                    { code: "L11-A", title: "Expedition Practical" }
                ],
                "L12: Skill at Arms": [
                    { code: "L12-1", title: "General Description, Safety and Sights (L98)" },
                    { code: "L12-2", title: "Stripping and Assembling (L98)" },
                    { code: "L12-3", title: "Basic Handling Drills (L98)" },
                    { code: "L12-4", title: "Cleaning and Maintenance" },
                    { code: "L12-5", title: "Holding and Aiming in the Prone (L98)" },
                    { code: "L12-6", title: "Firing in the Prone (L98)" },
                    { code: "L12-7", title: "Firing Drills (L98)" },
                    { code: "L12-8", title: "Firing from other Positions and use of Cover (L98)" },
                    { code: "L12-9", title: "Mechanism, Immediate Action and Stoppage Drills (L98)" },
                    { code: "L12-10", title: "Aiming off and Miss Drill (L98)" },
                    { code: "L12-11", title: "Carriage and Reaction to Effective Enemy Fire" },
                    { code: "L12-12", title: "Cadet General Purpose Weapons Handling Test" },
                    { code: "L12-A", title: "Practical Demonstration of Skill at Arms: Close Quarter Battle whilst Blank Firing" },
                    { code: "L12-B", title: "Recognised Shoot (Live Range Shoot or Dismounted Close Combat Trainer Shoot)" }
                ],
                "L13: Ranks": [
                    { code: "L13-1", title: "Ranks and Rates of the Royal Marines and the Royal Navy" }
                ],
                "L14: Signals": [
                    { code: "L14-1", title: "Phonetic Alphabet and 24 Hour Clock" },
                    { code: "L14-2", title: "Radio Nets - Call Signs, Procedures, Security and Discipline" },
                    { code: "L14-3", title: "Calling and Answering, Corrections and Repetitions" },
                    { code: "L14-4", title: "Practical Radio Use" }
                ],
                "L15: Arms Drill": [
                    { code: "L15-1", title: "Positions of Attention, Stand at Ease and Stand Easy" },
                    { code: "L15-2", title: "Changing and Sloping Arms" },
                    { code: "L15-3", title: "Present and Ground Arms" },
                    { code: "L15-4", title: "Saluting at the Halt with a Rifle" },
                    { code: "L15-5", title: "Saluting on the March with a Rifle at the Slope" }
                ],
                "L16: Wellbeing": [
                    { code: "L16-1", title: "Stress" }
                ],
                "L17: Cadet Voice": [
                    { code: "L17-1", title: "Introduction to Cadet Voice" }
                ]
            },
            "Lance Corporal": {
                "C1: Personal Development": [
                    { code: "C1-1", title: "Sea Cadet Values as a Lifestyle" },
                    { code: "C1-2", title: "Royal Marines Careers and Specialist Qualifications" },
                    { code: "C1-3", title: "BTEC and other Vocational Qualifications" },
                    { code: "C1-4", title: "Cadet Action Plan - Cadet Lance Corporal" }
                ],
                "C2: Drill": [
                    { code: "C2-1", title: "Drill Orders and Sequence of Orders" },
                    { code: "C2-2", title: "Fault Finding and Correction" },
                    { code: "C2-3", title: "Drill Manual Awareness" },
                    { code: "C2-4", title: "Practice Taking Command of a Squad" }
                ],
                "C3: Casualty": [
                    { code: "C3-1", title: "Introduction to Intermediate First Aid: First Aid Kits" }
                ],
                "C4: Map Reading": [
                    { code: "C4-1", title: "Resection" },
                    { code: "C4-2", title: "Boxing, Handrailing and Aiming Off" },
                    { code: "C4-3", title: "Alternate Ways of Finding North" },
                    { code: "C4-A", title: "Practical Day and Night Navigation" }
                ],
                "C5: Fieldcraft": [
                    { code: "C5-1", title: "Model Making for Orders" },
                    { code: "C5-2", title: "Tactical Principles" },
                    { code: "C5-3", title: "Feeding in the Field" },
                    { code: "C5-4", title: "Organisation and Grouping" },
                    { code: "C5-5", title: "Patrolling - Planning and Preparation" },
                    { code: "C5-6", title: "Patrolling - Conduct" },
                    { code: "C5-7", title: "Patrol Harbours" },
                    { code: "C5-8", title: "Defence and Delay Operations" },
                    { code: "C5-9", title: "Observation Posts" },
                    { code: "C5-10", title: "The Attack - Principles" },
                    { code: "C5-11", title: "The Attack - Fire and Movement (F&M)" },
                    { code: "C5-12", title: "The Attack - Hasty Attack (Section Battle Drills)" },
                    { code: "C5-13", title: "The Attack - Hasty Attack (Troop Battle Drills)" },
                    { code: "C5-14", title: "The Attack - The Deliberate Attack" },
                    { code: "C5-15", title: "The Attack - Advance to Contact" },
                    { code: "C5-16", title: "Battle Procedure - Functional Grouping and Orders" },
                    { code: "C5-A", title: "Practical - Operate a formal harbour or observation post overnight" }
                ],
                "C6: Leadership": [
                    { code: "C6-1", title: "Roles and Responsibilities of a Cadet Corporal" },
                    { code: "C6-2", title: "Community Activity" }
                ],
                "C7: PT": [
                    { code: "C7-1", title: "Eating for Health" },
                    { code: "C7-2", title: "Climatic Injuries (Heat Illness & Hypothermia)" },
                    { code: "C7-3", title: "Exercise, Stress and Relaxation" },
                    { code: "C7-4", title: "Personal Fitness Development - Basic Personal Fitness" }
                ],
                "C8: RM": [
                    { code: "C8-1", title: "Current Royal Marines Activity" }
                ],
                "C9: Waterborne": [
                    { code: "C9-1", title: "Waterborne Activity" }
                ],
                "C10: Expedition": [
                    { code: "C10-1", title: "Expedition Planning" },
                    { code: "C10-2", title: "Planning Session 1: Location, Accommodation and logistics" },
                    { code: "C10-3", title: "Planning Session 2 - Route" },
                    { code: "C10-4", title: "Planning Session 3 - Equipment" },
                    { code: "C10-5", title: "Planning Session 4 - Final Considerations and Briefing" },
                    { code: "C10-6", title: "Survival and Bushcraft" },
                    { code: "C10-A", title: "Expedition Practical" }
                ],
                "C11: Skill at Arms": [
                    { code: "C11-A", title: "Blank Firing Serial" },
                    { code: "C11-B", title: "Range Serial" }
                ],
                "C12: Ranks": [
                    { code: "C12-1", title: "Ranks of the Army and RAF" }
                ],
                "C13: Signals": [
                    { code: "C13-1", title: "Contact Reports and Situation Reports" },
                    { code: "C13-2", title: "Voice Procedures and Sending Reports" },
                    { code: "C13-3", title: "Practical Field Signals" }
                ],
                "C14: Wellbeing": [
                    { code: "C14-1", title: "Healthy Habits" }
                ],
                "C15: Cadet Voice": [
                    { code: "C15-1", title: "Prioritisation and District Meetings" }
                ]
            },
            "Corporal": {
                "S1: Personal Development": [
                    { code: "S1-1", title: "Safeguarding as a Senior Cadet" },
                    { code: "S1-2", title: "Career Planning" },
                    { code: "S1-3", title: "Cadet Action Plan - Cadet Corporal" }
                ],
                "S2: Drill": [
                    { code: "S2-1", title: "Practise Taking Command of a Squad" },
                    { code: "S2-2", title: "Method of Instruction" },
                    { code: "S2-3", title: "Instruction Practise - Interval Drill at the Halt" },
                    { code: "S2-4", title: "Instruction Practise - Interval Drill on the March" }
                ],
                "S3: Casualty": [
                    { code: "S3-1", title: "Casualty Evacuation" },
                    { code: "S3-2", title: "Casualty Triage" },
                    { code: "S3-3", title: "Health and Safety" }
                ],
                "S4: Map Reading": [
                    { code: "S4-1", title: "Route Planning" }
                ],
                "S5: Fieldcraft": [
                    { code: "S5-1", title: "Orders Development" },
                    { code: "S5-2", title: "Ambushes - Organisation" },
                    { code: "S5-3", title: "Ambushes - Planning and Preparation" },
                    { code: "S5-4", title: "Ambushes - Conduct" },
                    { code: "S5-5", title: "Training in Woods and Forest (TIWAF) - Offensive Operations" },
                    { code: "S5-6", title: "Training in Woods and Forest (TIWAF) - Defence and Delay Operations" },
                    { code: "S5-7", title: "Training in Built Up Areas (TIBUA) - Offensive Operations" },
                    { code: "S5-8", title: "Training in Built Up Areas (TIBUA) - Defensive Operations" },
                    { code: "S5-9", title: "Patrol Reports" }
                ],
                "S6: Leadership": [
                    { code: "S6-1", title: "What Makes a Great Leader?" },
                    { code: "S6-2", title: "Difference Between a Leader and a Manager" },
                    { code: "S6-3", title: "Active Listening" },
                    { code: "S6-4", title: "Emotional Intelligence" },
                    { code: "S6-5", title: "Conflict Resolution" },
                    { code: "S6-6", title: "Motivating Self and Others" },
                    { code: "S6-7", title: "How to Plan Effectively" },
                    { code: "S6-8", title: "Facilitating Cadet Discussion" },
                    { code: "S6-9", title: "Reflection and Self-Development" }
                ],
                "S7: PT": [
                    { code: "S7-1", title: "Injury Prevention and Goal Setting" },
                    { code: "S7-2", title: "Aerobic and Anaerobic Fitness and Skill Related Fitness" },
                    { code: "S7-3", title: "Training for Overall Fitness" },
                    { code: "S7-4", title: "Personal Fitness Development - Goal Setting for Sergeant and Beyond" }
                ],
                "S8: RM": [
                    { code: "S8-1", title: "Research - Individual Honours, Battles and Operations" },
                    { code: "S8-2", title: "Presentation - Individual Honours, Battles and Operations" },
                    { code: "S8-3", title: "Current Royal Marines Activity - Commando Case Study" }
                ],
                "S9: Waterborne": [
                    { code: "S9-1", title: "Waterborne Activity" }
                ],
                "S10: Expedition": [
                    { code: "S10-1", title: "Planning Session 1: Location" },
                    { code: "S10-2", title: "Planning Session 2: Accommodation and logistics" },
                    { code: "S10-3", title: "Planning Session 3 - Route" },
                    { code: "S10-4", title: "Planning Session 4 - Equipment" },
                    { code: "S10-5", title: "Planning Session 5 - Final Considerations and Briefing Prep" },
                    { code: "S10-6", title: "Planning Session 6 - Briefing Delivery" },
                    { code: "S10-A", title: "Expedition Practical" }
                ],
                "S11: Skill at Arms": [
                    { code: "S11-1", title: "Cadet Target Rifle - General Description, Safety, Bipod, Slings and Sights" },
                    { code: "S11-2", title: "Fitting the Sling and Rifle Cleaning" },
                    { code: "S11-3", title: "Sight Setting, Load, Unload, Misfires and Safe-Handling" },
                    { code: "S11-4", title: "Adjusting the Rifle, Handling" },
                    { code: "S11-5", title: "Mechanism of the Rifle" },
                    { code: "S11-6", title: "Practice Period - Rifle Practice Covering Lessons 1,2,3 and 4" }
                ],
                "S12: Wellbeing": [
                    { code: "S12-1", title: "Wellbeing and Communication" }
                ],
                "S13: Cadet Voice": [
                    { code: "S13-1", title: "Working with your UMT" }
                ]
            },
            "Cadet Sergeant": {
                "SGT Modules": [
                    { code: "SGT01", title: "Personal Development Plan" },
                    { code: "SGT02", title: "Shadow In-Unit Volunteer Roles" },
                    { code: "SGT03", title: "Meeting with your CO/OiC" },
                    { code: "SGT04", title: "Meet a Cadet-Turned-Volunteer" },
                    { code: "SGT05", title: "What will Change?" },
                    { code: "SGT06", title: "Act as a Volunteer" },
                    { code: "SGT07", title: "Write a Risk Assessment" },
                    { code: "SGT08", title: "Organise an Event" },
                    { code: "SGT09", title: "Lead the Unit's Cadet Voice Meeting" },
                    { code: "SGT10", title: "Attend a UMT Meeting" },
                    { code: "SGT11", title: "Use Programmes Online" },
                    { code: "SGT12", title: "Session Creation" },
                    { code: "SGT13", title: "Plan Leadership Tasks" },
                    { code: "SGT14", title: "Shadow Roles during Beyond-Unit Training" },
                    { code: "SGT15", title: "Specialisation/Proficiency/Activity Instructor Qualification" }
                ]
            }
        };

        const WATER_SYLLABUS = {
            "Swim": [ { code: "Swim Test", title: "CF Swim Test", alts: ["CF Swimming Test"] }, { code: "Water Safety", title: "CF Water Safety Test", alts: [] } ],
            "Paddle": [ { code: "Start", title: "BC Paddle Start Award", alts: [] }, { code: "Discover", title: "BC Paddle Discover Award", alts: [] }, { code: "Explore", title: "BC Paddle Explore Award", alts: [] }, { code: "PSRC", title: "BC Paddle Safety & Rescue Course (PSRC)", alts: ["BC Foundation Safety & Rescue Training (FSRT)"] }, { code: "SUP Sheltered", title: "BC Stand Up Paddle Sheltered Water Award", alts: [] }, { code: "Instructor", title: "BC Paddlesport Instructor", alts: [] } ],
            "Row": [ { code: "Taster", title: "Taster Certificate", alts: ["SCC Taster Certificate", "SCC Row 1-Rowing Taster"] }, { code: "Go Row 1 (Fixed)", title: "BR Explore Rowing - Go Row 1 (Fixed)", alts: ["SCC Competent Crew"] }, { code: "Go Row 1 (Sliding)", title: "BR Explore Rowing - Go Row 1 (Sliding)", alts: [] }, { code: "Go Row 2 (Fixed)", title: "BR Explore Rowing - Go Row 2 (Fixed)", alts: ["SCC Supervised Cox", "SCC Row 2"] }, { code: "Go Row 2 (Sliding)", title: "BR Explore Rowing - Go Row 2 (Sliding)", alts: [] }, { code: "Go Row 3 (Fixed)", title: "BR Explore Rowing - Go Row 3 (Fixed)", alts: ["SCC Coxswain", "SCC Row 3"] }, { code: "Asst Instructor", title: "SCC Assistant Rowing Instructor", alts: [] }, { code: "Instructor", title: "SCC Rowing Instructor", alts: [] }, { code: "Sliding Endorsement", title: "SCC Sliding Seat Instructor Endorsement", alts: [] }, { code: "Coastal Endorsement", title: "SCC Instructor Coastal Endorsement", alts: [] } ],
            "Sail": [ { code: "Taster", title: "Dinghy Sailing Taster", alts: ["Dinghy Sailing Taster Certificate"] }, { code: "Stage 1", title: "RYA YSS Stage 1", alts: [] }, { code: "Stage 2", title: "RYA YSS Stage 2", alts: [] }, { code: "Stage 3", title: "RYA YSS Stage 3", alts: [] }, { code: "Stage 4", title: "RYA YSS Stage 4", alts: [] }, { code: "Spinnakers", title: "RYA Sailing with Spinnakers", alts: [] }, { code: "Seamanship", title: "RYA Seamanship Skills", alts: [] }, { code: "Day Sailing", title: "RYA Day Sailing", alts: [] }, { code: "Performance", title: "RYA Performance Sailing", alts: [] }, { code: "Start Racing", title: "RYA Start Racing", alts: [] }, { code: "Asst Instructor", title: "RYA Assistant Instructor", alts: [] }, { code: "DI Pre-Entry", title: "RYA Dinghy Instructor Pre-Entry Assessment", alts: [] }, { code: "DI Training", title: "RYA Dinghy Instructor Training", alts: [] }, { code: "DI Moderation", title: "RYA Dinghy Instructor Moderation", alts: [] } ],
            "Power": [ { code: "Level 1", title: "RYA Powerboat Level 1", alts: [] }, { code: "L2 Disp", title: "RYA Powerboat Level 2 Displacement", alts: [] }, { code: "L2 Planing", title: "RYA Powerboat Level 2 Planing", alts: [] }, { code: "Safety Boat", title: "RYA Safety Boat", alts: [] }, { code: "Instructor", title: "RYA Powerboat Instructor", alts: [] }, { code: "Advanced", title: "RYA Powerboat Advanced", alts: [] } ],
            "Windsurf": [ { code: "Intro", title: "RYA YouthWS Introductory", alts: ["RYA YouthWS Introductory Certificate"] }, { code: "Stage 1", title: "RYA YouthWS - Stage 1", alts: ["RYA NWS Start Windsurfing"] }, { code: "Stage 2", title: "RYA YouthWS - Stage 2", alts: [] }, { code: "Stage 3", title: "RYA YouthWS - Stage 3", alts: [] }, { code: "Instructor Training", title: "RYA Start Windsurfing Instructor Training", alts: [] }, { code: "Instructor Mod", title: "RYA Start Windsurfing Instructor Moderation", alts: [] }, { code: "Instructor", title: "RYA Start Windsurfing Instructor", alts: [] } ],
            "Shorebased": [ { code: "First Aid", title: "RYA First Aid", alts: ["RyA First Aid"] }, { code: "Nav & Seamanship", title: "RYA Essential Navigation and Seamanship", alts: [] } ],
            "Offshore": [ { code: "Sail G1", title: "Sail Grade 1", alts: ["Offshore Hand Level 1 (OH1)", "RYA Start Yachting", "OH1 Equivalent"] }, { code: "Sail G2", title: "Sail Grade 2", alts: ["Offshore Hand Level 2 (OH2)", "RYA Competent Crew"] }, { code: "Power G1", title: "Power Grade 1", alts: [] }, { code: "Power G2", title: "Power Grade 2", alts: ["Offshore Power Level 2 (OPH2)"] }, { code: "Power Seaman", title: "Power Seaman", alts: ["Offshore Power Seaman (OPS)"] }, { code: "Power WL", title: "Power Watch Leader", alts: ["OPWL"] }, { code: "Watch Leader", title: "Watch Leader", alts: ["Offshore Watch Leader (OWL)", "RYA Day Skipper"] }, { code: "Motor Cruising", title: "Motor Cruising - RYA Start Motor Cruising", alts: [] }, { code: "Sail Cruising", title: "Sail Cruising - RYA Start Yachting", alts: [] } ],
            "Awards": [ { code: "Coxswain", title: "Coxswain Award", alts: ["SCC Proficiency"] }, { code: "Master Coxswain", title: "Master Coxswain Award", alts: ["SCC Proficiency"] } ]
        };

        const SCC_RANK_ORDER = ["New Entry Cadet", "Cadet", "Cadet 1st Class", "Ordinary Cadet", "Able Cadet", "Leading Cadet", "Petty Officer Cadet"];
        const RMC_RANK_ORDER = ["Marine Recruit", "Marine Cadet", "Lance Corporal", "Corporal", "Cadet Sergeant"];

        // --- 3. HELPER FUNCTIONS ---
        const splitCSVLine = (str) => {
            const arr = [];
            let quote = false;
            let col = "";
            for (let c of str) {
                if (c === '"') { quote = !quote; continue; }
                if (c === ',' && !quote) { arr.push(col); col = ""; continue; }
                col += c;
            }
            arr.push(col);
            return arr;
        };

        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;
            
            const parts = dateStr.split(/[\/\-\s]/);
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const year = parseInt(parts[2]);
                let month = parseInt(parts[1]) - 1; 

                if (isNaN(month)) {
                    const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
                    month = months.findIndex(m => parts[1].toLowerCase().startsWith(m));
                }
                
                if (!isNaN(day) && !isNaN(month) && !isNaN(year) && month >= 0) {
                    d = new Date(year, month, day);
                    if (!isNaN(d.getTime())) return d;
                }
            }
            return null;
        };

        // Global Date Formatter
        const formatDate = (date) => {
            if (!date) return '-';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '-';
            return d.toLocaleDateString('en-GB');
        };

        const normalizeRank = (rawRank) => {
            if (!rawRank) return "Unknown";
            const r = rawRank.toLowerCase().trim();

            // Junior Ranks
            if (r === "ljc" || (r.includes("leading") && (r.includes("junior") || r.includes("jnr")))) return "Leading Junior Cadet";
            if (r === "ajc" || (r.includes("able") && (r.includes("junior") || r.includes("jnr")))) return "Able Junior Cadet";
            if (r === "jcfc" || r === "jc1" || ((r.includes("junior") || r.includes("jnr") || r.includes("jc")) && (r.includes("1st") || r.includes("first")))) return "Junior Cadet 1st Class";
            if (r === "jc" || r === "junior cadet" || r.includes("junior") || r.includes("jnr")) return "Junior Cadet";

            // Senior Ranks
            if (r.includes("new entry") || r === "nec") return "New Entry Cadet";
            if (r === "cdt" || r === "cadet") return "Cadet";
            if (r === "cdt 1st" || r.includes("1st class")) return "Cadet 1st Class";
            if (r === "oc" || r === "ordinary cadet" || r.includes("ordinary")) return "Ordinary Cadet";
            if (r === "ac" || r === "able cadet" || r.includes("able")) return "Able Cadet";
            if (r === "lc" || r === "leading cadet" || r.includes("leading")) return "Leading Cadet";
            if (r === "poc" || r === "petty officer cadet") return "Petty Officer Cadet";
            
            // RMC Ranks Normalization
            if (r === "mc" || r === "marine cadet") return "Marine Cadet"; 
            if (r === "mc1" || r === "marine cadet 1st class" || r === "marine cadet 1") return "Marine Cadet"; 
            if (r.includes("recruit")) return "Marine Recruit";
            if (r === "marine") return "Marine Cadet";
            
            // Explicitly match RMC Cadet Ranks
            if (r === "cdt sergeant" || r.includes("cadet sergeant")) return "Cadet Sergeant";
            if (r === "cdt cpl" || r.includes("cadet corporal")) return "Corporal";
            if (r === "cdt lcpl" || r.includes("cadet lance corporal")) return "Lance Corporal";

            // Fallback checks (to catch variations if not exact match above)
            if (r.includes("lance")) return "Lance Corporal";
            if (r.includes("corporal")) return "Corporal"; 
            
            return rawRank;
        };

        const calculateAge = (dob) => {
            if (!dob) return "Unknown";
            const birthDate = parseDate(dob);
            if (!birthDate) return "Unknown";
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        };
        
        // Age-based styling function
        const getCadetAgeColor = (dob) => {
            if (!dob) return '';
            const birthDate = parseDate(dob);
            if (!birthDate) return '';
            
            const today = new Date();
            const ageInMilliseconds = today.getTime() - birthDate.getTime();
            const ageInYears = ageInMilliseconds / (1000 * 60 * 60 * 24 * 365.25);
            
            if (ageInYears >= 18.0) {
                return 'bg-red-500/30 text-red-800 font-bold'; // 18+ (Red)
            }
            if (ageInYears >= 17.5) {
                return 'bg-orange-500/30 text-orange-800 font-bold'; // 17.5+ (Orange)
            }
            if (ageInYears >= 17.0) {
                return 'bg-yellow-500/30 text-yellow-800 font-bold'; // 17+ (Yellow/Amber)
            }
            
            return ''; // No highlighting
        };


        // --- 4. GENERIC COMPONENTS ---

        const Icon = ({ name, className }) => {
            return <i data-lucide={name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase()} className={className}></i>;
        };
        
        const BadgeImage = ({ name, fallbackIcon, className }) => {
            const [error, setError] = useState(false);
            let filename = BADGE_MAP[name];
            if (!filename) {
                const cleanName = name.replace(/\(.*\)/, "").trim(); 
                const matchingKey = Object.keys(BADGE_MAP).find(k => k.includes(cleanName) || cleanName.includes(k));
                if(matchingKey) filename = BADGE_MAP[matchingKey];
            }
            if (!filename) filename = name.toLowerCase().replace(/[^a-z0-9]+/g, '-') + ".png";
            const src = `media/${filename}`;
            
            if (error) {
                // Return a placeholder box with "Missing Image" text
                return (
                    <div className={`${className} bg-slate-100 border border-slate-300 rounded flex items-center justify-center text-center p-1`}>
                        <span className="text-[9px] text-slate-400 font-mono leading-tight">Missing Image<br/><span className="text-[7px] opacity-50">{name}</span></span>
                    </div>
                );
            }
            
            return <img src={src} alt={name} className={`object-contain ${className}`} onError={() => setError(true)} title={name} />;
        };

        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Dashboard Error:", error, errorInfo); }
            handleReset = () => { localStorage.clear(); window.location.reload(); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-red-50 p-8">
                            <div className="bg-white p-8 rounded-lg shadow-xl max-w-md w-full text-center">
                                <h2 className="text-2xl font-bold text-red-600 mb-4">Something went wrong</h2>
                                <p className="text-slate-600 mb-6">The dashboard encountered an error processing the data.</p>
                                <div className="bg-slate-100 p-4 rounded text-left text-xs font-mono text-red-800 mb-6 overflow-auto max-h-32">{this.state.error && this.state.error.toString()}</div>
                                <button onClick={this.handleReset} className="w-full py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">Clear Data & Reset</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const FileUploader = ({ onDataLoaded, hasData, clearData }) => {
            const [personnelFile, setPersonnelFile] = useState(null);
            const [qualsFile, setQualsFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleFile = (file, type) => {
                if(type === 'personnel') setPersonnelFile(file);
                if(type === 'quals') setQualsFile(file);
                if (error) setError(null); // Clear error on new file selection
            };

            const processFiles = async () => {
                setLoading(true);
                setError(null);
                const personnelData = [];
                const qualsData = [];

                const readFile = (file) => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsText(file);
                });

                try {
                    if (personnelFile) {
                        const text = await readFile(personnelFile);
                        const lines = text.split('\n');
                        const headers = splitCSVLine(lines[0].trim());
                        
                        const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
                        
                        const idx = {
                            pnum: findCol("PNumber") > -1 ? findCol("PNumber") : findCol("PNo"),
                            rank: findCol("Rank"),
                            surname: findCol("Surname"),
                            first: findCol("First Name"),
                            tos: findCol("TOS"),
                            dob: findCol("DOB"),
                            rankDate: findCol("Date Current Rank"),
                            unit: findCol("Unit")
                        };

                        const requiredFields = ['pnum', 'rank', 'surname', 'first'];
                        const missing = requiredFields.filter(key => idx[key] === -1);
                        if (missing.length > 0) {
                             throw new Error(`Personnel file missing columns: ${missing.join(', ')}`);
                        }

                        for (let i = 1; i < lines.length; i++) {
                            const row = splitCSVLine(lines[i].trim());
                            if (row.length < 3) continue;
                            personnelData.push({
                                pNumber: (row[idx.pnum] || "").trim(),
                                rank: normalizeRank(row[idx.rank]), 
                                name: `${row[idx.surname]}, ${row[idx.first]}`,
                                tos: row[idx.tos],
                                dob: row[idx.dob],
                                rankDate: row[idx.rankDate],
                                unit: row[idx.unit]
                            });
                        }
                    }

                    if (qualsFile) {
                        const text = await readFile(qualsFile);
                        const lines = text.split('\n');
                        const headers = splitCSVLine(lines[0].trim());
                        
                        const findCol = (name) => headers.findIndex(h => h.toLowerCase().includes(name.toLowerCase()));
                        
                        const idx = {
                            pnum: findCol("PNumber") > -1 ? findCol("PNumber") : findCol("PNo"),
                            module: findCol("Module"),
                            date: findCol("Date Achieved"),
                            result: findCol("Result"),
                            syllabus: findCol("Syllabus")
                        };

                        const requiredFields = ['pnum', 'module', 'date'];
                        const missing = requiredFields.filter(key => idx[key] === -1);
                        if (missing.length > 0) {
                             throw new Error(`Qualifications file missing columns: ${missing.join(', ')}. Check CSV headers.`);
                        }

                        for (let i = 1; i < lines.length; i++) {
                            const row = splitCSVLine(lines[i].trim());
                            if (row.length < 3) continue;
                            qualsData.push({
                                pNumber: (row[idx.pnum] || "").trim(),
                                module: (row[idx.module] || "").trim(),
                                date: parseDate(row[idx.date]),
                                result: row[idx.result],
                                syllabus: row[idx.syllabus]
                            });
                        }
                    }
                    
                    onDataLoaded(personnelData, qualsData);
                } catch (err) {
                    console.error(err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto mt-2 border border-slate-200">
                    <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <Icon name="Upload" className="w-5 h-5" /> Import Data Sources
                    </h2>
                    
                    {error && (
                        <div className="mb-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 flex justify-between items-start">
                            <div>
                                <p className="font-bold">Error Processing Files</p>
                                <p className="text-sm">{error}</p>
                            </div>
                            <button onClick={() => setError(null)} className="text-red-500 hover:text-red-700">
                                <Icon name="X" className="w-4 h-4" />
                            </button>
                        </div>
                    )}

                    <div className="space-y-4">
                        <div className="border-2 border-dashed border-slate-300 p-6 rounded-lg text-center hover:bg-slate-50 transition-colors">
                            <p className="font-semibold text-slate-600 mb-2">1. Unit Personnel Report</p>
                            <input type="file" accept=".csv" onChange={(e) => handleFile(e.target.files[0], 'personnel')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                        <div className="border-2 border-dashed border-slate-300 p-6 rounded-lg text-center hover:bg-slate-50 transition-colors">
                            <p className="font-semibold text-slate-600 mb-2">2. Cadet Qualifications Report</p>
                            <input type="file" accept=".csv" onChange={(e) => handleFile(e.target.files[0], 'quals')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        </div>
                        <button onClick={processFiles} disabled={!personnelFile || !qualsFile || loading} className={`w-full py-3 rounded-lg font-bold text-white transition-all ${(!personnelFile || !qualsFile) ? 'bg-slate-300 cursor-not-allowed' : 'bg-blue-700 hover:bg-blue-800 shadow-lg'}`}>
                            {loading ? "Processing..." : "Load Dashboards"}
                        </button>
                    </div>

                    {hasData && (
                        <div className="mt-8 border-t pt-6 text-center">
                             <p className="text-sm text-slate-500 mb-3">You have saved data from a previous session.</p>
                             <button onClick={clearData} className="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-2 justify-center">
                                 <Icon name="Trash2" className="w-4 h-4" /> Clear Saved Data
                             </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW COMPONENT: ModuleDrillDown ---
        const ModuleDrillDown = ({ info, onClose }) => {
            if (!info) return null;

            return (
                <div className="fixed inset-0 bg-slate-900 bg-opacity-75 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
                            <h3 className="text-xl font-bold text-blue-800">
                                Cadets Needing: {info.module.code}
                            </h3>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-blue-100 text-slate-600">
                                <Icon name="X" className="w-5 h-5" />
                            </button>
                        </div>
                        <div className="p-4 space-y-3 flex-1 overflow-y-auto">
                            <p className="text-sm font-semibold text-slate-700">Module: {info.module.title}</p>
                            <p className="text-sm text-slate-500 border-b pb-2">Target Rank: <span className="font-bold text-blue-700">{info.targetRank}</span> (Total Needing: {info.cadetsNeeding.length})</p>
                            
                            {info.cadetsNeeding.length === 0 ? (
                                <p className="text-center italic text-slate-400 py-4">All cadets at this rank have completed this module.</p>
                            ) : (
                                <ul className="space-y-1 text-sm">
                                    {info.cadetsNeeding.map((cadet) => (
                                        <li key={cadet.pNumber} className="flex justify-between items-center p-2 bg-slate-50 rounded-lg hover:bg-slate-100">
                                            <span className="font-medium text-slate-800">{cadet.name}</span>
                                            <span className="text-xs text-slate-500">{cadet.pNumber}</span>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const HomeView = ({ personnel }) => {
            const unitName = personnel.length > 0 ? (personnel[0].unit || "Your Unit") : "Sea Cadets";

            return (
                <div className="space-y-8">
                    {/* Welcome Section */}
                    <div className="bg-white p-8 rounded-lg shadow-xl border border-blue-200">
                        <div className="flex items-center gap-6 mb-6">
                            <div className="p-4 bg-blue-100 rounded-full text-blue-800">
                                <Icon name="ShipWheel" className="w-8 h-8" />
                            </div>
                            <h2 className="text-3xl font-extrabold text-blue-900">
                                Welcome to the {unitName} Training Dashboard!
                            </h2>
                        </div>
                        
                        <p className="text-lg text-slate-700 mb-4">
                            This dashboard provides a comprehensive overview of your cadets' training progression, qualifications, and awards. It isn't a replacement for <a href="https://www.defencegateway.mod.uk/home/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 font-bold underline">Westminster</a>, but it's designed to help your team visualise where cadets stand in relation to the Cadet Training Programme (CTP), Cadet Training Syllabus (CTS), and waterborne proficiencies.
                        </p>
                        <ul className="list-disc list-inside space-y-2 text-slate-600 ml-4">
                            <li>Use <strong>Cadet Focus</strong> to see all achievements and progression for an individual.</li>
                            <li>Use <strong>SCC CTP / RMC CTS Progress</strong> to plan training nights for specific rank groups.</li>
                            <li>Use <strong>Awards</strong> to review recent accomplishments and generate certificates for presentations.</li>
                            <li>Use <strong>Waterborne</strong> to track proficiency levels in all boating activities.</li>
                        </ul>
                        <div className="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-sm text-yellow-800 rounded">
                            <p className="font-semibold flex items-center gap-2"><Icon name="AlertCircle" className="w-4 h-4"/> Data Note</p>
                            <p>All data shown here is derived from the CSV reports you uploaded and may not reflect real-time changes if new reports have not been synced.</p>
                        </div>
                    </div>

                    {/* Disclaimer Section */}
                    <div className="mt-10 max-w-4xl mx-auto text-center text-xs text-slate-400 p-4 border-t border-slate-300">
                        <p className="font-semibold mb-1">Disclaimer</p>
                        <p className="mb-2">
                            This app was built independently by volunteers and is not an an official MSSC product. Its provided as is, with no warranty or guarantees offered or implied, and you use it at your own risk. The code is open source, and parts of the solution, documentation, or content may be AI-generated. Always review outputs for accuracy.
                        </p>
                        <p>
                            If you spot a bug, have a feature idea, or make an improvement, please share it so others can benefit. 
                            You can contact James Harbidge at <a href="mailto:jharbidge@mhseacadets.org?subject=TS Dashboard" className="text-blue-500 hover:text-blue-600 underline">jharbidge@mhseacadets.org</a>.
                        </p>
                    </div>
                </div>
            );
        };

        // --- UPDATED AWARDS VIEW WITH PDF GENERATION ---
        const AwardsView = ({ personnel, quals }) => {
            const [monthOffset, setMonthOffset] = useState(0); 
            // New State for PDF Selection
            const [selectedAwardKeys, setSelectedAwardKeys] = useState(new Set());

            // Icon Render Fix
            useEffect(() => { lucide.createIcons(); }, [monthOffset]);

            const getTargetDate = () => {
                const d = new Date();
                d.setMonth(d.getMonth() + monthOffset);
                return d;
            };

            const targetDate = useMemo(() => getTargetDate(), [monthOffset]);
            const monthName = targetDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const isSpecOrProf = (syllabus) => {
                if (!syllabus) return false;
                return syllabus.includes("Specialisations") || syllabus.includes("Proficiencies");
            };

            const isDofEAward = (qualName) => {
                 return qualName.includes("DofE") && (qualName.includes("Bronze") || qualName.includes("Silver") || qualName.includes("Gold"));
            };

            const isCTPModule = (qualName) => {
                 const inSCC = Object.values(SCC_SYLLABUS).some(rank => 
                     Object.values(rank).some(category => 
                         category.some(mod => qualName.includes(mod.code) || qualName === mod.title)
                     )
                 );
                 const inRMC = Object.values(RMC_SYLLABUS).some(rank => 
                     Object.values(rank).some(category => 
                         category.some(mod => qualName.includes(mod.code) || qualName === mod.title)
                     )
                 );
                 return inSCC || inRMC;
            };

            const { pastAwards, upcomingAwards } = useMemo(() => {
                let endDate, startDate, nextStart, nextEnd;

                if (monthOffset === 0) {
                    endDate = new Date(); 
                    startDate = new Date();
                    startDate.setDate(endDate.getDate() - 30);
                    
                    nextStart = new Date();
                    nextEnd = new Date();
                    nextEnd.setDate(nextStart.getDate() + 30);
                } else {
                    startDate = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
                    endDate = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0);
                    
                    nextStart = new Date(endDate);
                    nextEnd = new Date(endDate);
                    nextEnd.setDate(nextStart.getDate() + 30);
                }

                let past = quals.filter(q => {
                    if (!q.date) return false;
                    // Ensure q.date is handled correctly even if it's a string from legacy state
                    const d = new Date(q.date);
                    if(isNaN(d.getTime())) return false;

                    const inDate = d >= startDate && d <= endDate;
                    const isSpec = isSpecOrProf(q.syllabus);
                    const isDofE = isDofEAward(q.module);
                    const isCTP = isCTPModule(q.module);
                    
                    return inDate && (isSpec || isDofE || !isCTP);
                }).map(q => {
                    const cadet = personnel.find(p => p.pNumber === q.pNumber);
                    let type = "Qualification";
                    if (isSpecOrProf(q.syllabus)) type = q.syllabus.includes("Specialisations") ? "Specialisation" : "Proficiency";
                    if (isDofEAward(q.module)) type = "DofE";
                    
                    // Generate a unique ID for selection tracking
                    const d = new Date(q.date);
                    const uniqueId = `${q.pNumber}-${q.module.replace(/\s+/g, '')}-${d.getTime()}`;

                    return { ...q, uniqueId, cadetName: cadet ? cadet.name : "Unknown", type: type, date: d };
                });

                personnel.forEach(p => {
                    if (p.rankDate) {
                        const rDate = parseDate(p.rankDate);
                        if (rDate && rDate >= startDate && rDate <= endDate) {
                            const uniqueId = `${p.pNumber}-PROMO-${rDate.getTime()}`;
                            past.push({
                                uniqueId,
                                cadetName: p.name,
                                module: `Promoted to ${p.rank}`,
                                type: "Promotion",
                                date: rDate,
                                pNumber: p.pNumber
                            });
                        }
                    }
                });

                const upcoming = [];
                personnel.forEach(p => {
                    // --- GCB Logic ---
                    if (p.tos && p.dob) {
                        const tos = parseDate(p.tos);
                        const dob = parseDate(p.dob);
                        
                        if (tos && dob) {
                            const twelfthBirthday = new Date(dob);
                            twelfthBirthday.setFullYear(dob.getFullYear() + 12);
                            const baseDate = tos > twelfthBirthday ? tos : twelfthBirthday;
                            
                            for (let year = 1; year <= 3; year++) {
                                const gcbDate = new Date(baseDate);
                                gcbDate.setFullYear(baseDate.getFullYear() + year);
                                
                                if (gcbDate >= nextStart && gcbDate <= nextEnd) {
                                    const uniqueId = `${p.pNumber}-GCB${year}-${gcbDate.getTime()}`;
                                    upcoming.push({
                                        cadetName: p.name,
                                        module: `${year === 1 ? '1st' : year === 2 ? '2nd' : '3rd'} Good Conduct Badge`,
                                        date: gcbDate,
                                        type: "GCB Due",
                                        pNumber: p.pNumber,
                                        uniqueId
                                    });
                                }
                            }
                        }
                    }

                    // --- Waterborne Award Logic (Due/Pending) ---
                    const cadetQuals = quals.filter(q => q.pNumber === p.pNumber);
                    const hasQual = (str) => cadetQuals.some(q => q.module && q.module.toLowerCase().includes(str.toLowerCase()));
                    
                    const hasMasterAward = hasQual("Master Coxswain Award");
                    if (hasMasterAward) return; // Skip logic if highest award achieved
                    const hasCoxswainAward = hasQual("Coxswain Award");

                    let proficienciesMet = 0;
                    if (hasQual("Rowing Coxswain") || hasQual("SCC Coxswain") || hasQual("Row 3")) proficienciesMet++;
                    if (hasQual("Paddle Explore")) proficienciesMet++;
                    if (hasQual("Stage 4")) proficienciesMet++;
                    if (hasQual("Windsurfing") && (hasQual("Stage 2") || hasQual("Stage 3") || hasQual("Stage 4"))) proficienciesMet++;

                    const meetsCoxswainCriteria = proficienciesMet >= 2;
                    let meetsMasterCriteria = false;

                    if (meetsCoxswainCriteria) {
                        const hasPB2 = hasQual("Powerboat Level 2") || hasQual("Powerboat L2") || hasQual("Level 2 Planing") || hasQual("Level 2 Disp");
                        const hasENS = hasQual("Essential Navigation");
                        const hasDaySkipper = hasQual("Day Skipper") || hasQual("Watch Leader");

                        if (hasPB2) {
                            const hasNavP1 = hasENS || hasDaySkipper;
                            if (hasNavP1) {
                                const hasP1Option = hasQual("Assistant Rowing Instructor") || hasQual("CST") || hasQual("FSRT") || hasQual("Foundation Safety") || hasQual("PSRC") || hasQual("Paddle Safety") || hasQual("Assistant Instructor") || (hasQual("Assistant") && hasQual("Windsurf"));
                                if (hasP1Option) meetsMasterCriteria = true;
                            }
                            if (!meetsMasterCriteria && hasENS) {
                                const hasP2Option = hasQual("Paddlesport Instructor") || (hasQual("Dinghy Instructor") && !hasQual("Assistant")) || (hasQual("Windsurfing Instructor") && !hasQual("Assistant")) || (hasQual("Powerboat Instructor") && !hasQual("Assistant"));
                                if (hasP2Option) meetsMasterCriteria = true;
                            }
                        }
                    }

                    if (meetsMasterCriteria && !hasMasterAward) {
                           const d = new Date();
                           const uniqueId = `${p.pNumber}-MASTERCOX-${d.getTime()}`;
                           upcoming.push({
                               cadetName: p.name,
                               module: "Master Coxswain Award",
                               date: d, // Action required now
                               type: "Award Due",
                               pNumber: p.pNumber,
                               uniqueId
                           });
                    } else if (meetsCoxswainCriteria && !hasCoxswainAward && !hasMasterAward) {
                           const d = new Date();
                           const uniqueId = `${p.pNumber}-COX-${d.getTime()}`;
                           upcoming.push({
                               cadetName: p.name,
                               module: "Coxswain Award",
                               date: d, // Action required now
                               type: "Award Due",
                               pNumber: p.pNumber,
                               uniqueId
                           });
                    }
                });

                return { 
                    pastAwards: past.sort((a,b) => b.date - a.date), 
                    upcomingAwards: upcoming.sort((a,b) => a.date - b.date) 
                };
            }, [personnel, quals, monthOffset, targetDate]);

            // --- PDF GENERATION LOGIC ---
            const toggleAwardSelection = (id) => {
                const newSet = new Set(selectedAwardKeys);
                if (newSet.has(id)) newSet.delete(id);
                else newSet.add(id);
                setSelectedAwardKeys(newSet);
            };

            const selectAllAwards = () => {
                if (selectedAwardKeys.size === pastAwards.length) {
                    setSelectedAwardKeys(new Set());
                } else {
                    setSelectedAwardKeys(new Set(pastAwards.map(a => a.uniqueId)));
                }
            };

            const generateCertificates = () => {
                if (selectedAwardKeys.size === 0) {
                    // Use a custom message box instead of alert()
                    const message = "Please select at least one award to print.";
                    console.log(message); // Console log fallback
                    // A custom modal/message box implementation is normally needed here. 
                    // For brevity and compliance with single file constraint, using console.log/simple approach.
                    return; 
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
                
                const unitName = personnel.length > 0 ? personnel[0].unit : "Sea Cadets";
                const itemsToPrint = pastAwards.filter(a => selectedAwardKeys.has(a.uniqueId));

                itemsToPrint.forEach((item, index) => {
                    if (index > 0) doc.addPage();

                    // --- Certificate Design ---
                    
                    // Border
                    doc.setLineWidth(1.5);
                    doc.setDrawColor(0, 51, 102); // SCC Navy
                    doc.rect(10, 10, 277, 190);
                    doc.setLineWidth(0.5);
                    doc.rect(12, 12, 273, 186);

                    // Header
                    doc.setTextColor(0, 51, 102);
                    doc.setFont("times", "bold");
                    doc.setFontSize(32);
                    doc.text("CERTIFICATE OF ACHIEVEMENT", 148.5, 60, { align: "center" });

                    // Subheader
                    doc.setFont("times", "normal");
                    doc.setFontSize(16);
                    doc.text("This is to certify that", 148.5, 80, { align: "center" });

                    // Name
                    doc.setFont("times", "bolditalic");
                    doc.setFontSize(28);
                    doc.text(item.cadetName, 148.5, 95, { align: "center" });

                    // Middle text
                    doc.setFont("times", "normal");
                    doc.setFontSize(16);
                    doc.text("has successfully qualified in", 148.5, 110, { align: "center" });

                    // Award Title
                    doc.setFont("times", "bold");
                    doc.setFontSize(24);
                    // Handle long titles
                    if (item.module.length > 30) doc.setFontSize(18);
                    doc.text(item.module, 148.5, 125, { align: "center" });

                    // Date
                    doc.setFont("times", "normal");
                    doc.setFontSize(14);
                    doc.text(`Awarded on: ${formatDate(item.date)}`, 148.5, 140, { align: "center" });

                    // Footer
                    doc.setFontSize(12);
                    doc.text(`Unit: ${unitName}`, 20, 180);
                    doc.text(`Signed: __________________________`, 200, 180);
                    doc.text(`Commanding Officer`, 200, 186);
                    
                    // ID
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`System Generated ID: ${item.uniqueId}`, 20, 195);
                });

                doc.save(`SCC_Certificates_${monthName}.pdf`);
            };

            // --- UPCOMING AWARDS REPORT GENERATION ---
            const generateUpcomingReport = () => {
                if (upcomingAwards.length === 0) {
                    console.log("No upcoming awards to report.");
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
                const unitName = personnel.length > 0 ? personnel[0].unit : "Sea Cadets";
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.text(`Upcoming Awards Report - ${unitName}`, 105, 20, { align: "center" });
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text(`Generated on: ${new Date().toLocaleDateString('en-GB')}`, 105, 30, { align: "center" });
                
                let y = 45;
                const itemsToPrint = upcomingAwards; // Print all upcoming awards
                
                // Headers
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.text("Cadet Name", 15, y);
                doc.text("Award / Module", 60, y);
                doc.text("Type", 140, y);
                doc.text("Due Date", 175, y);
                
                doc.line(15, y+2, 195, y+2);
                y += 10;
                
                doc.setFont("helvetica", "normal");
                
                itemsToPrint.forEach(item => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        // Optional: Repeat headers
                        doc.setFont("helvetica", "bold");
                        doc.text("Cadet Name", 15, y);
                        doc.text("Award / Module", 60, y);
                        doc.text("Type", 140, y);
                        doc.text("Due Date", 175, y);
                        doc.line(15, y+2, 195, y+2);
                        y += 10;
                        doc.setFont("helvetica", "normal");
                    }
                    
                    doc.text(item.cadetName, 15, y);
                    
                    // Handle long module names
                    const splitTitle = doc.splitTextToSize(item.module, 75);
                    doc.text(splitTitle, 60, y);
                    
                    doc.text(item.type, 140, y);
                    const dateStr = item.type === 'Award Due' ? 'Action Required' : formatDate(item.date);
                    doc.text(dateStr, 175, y);
                    
                    // Adjust y based on lines (approx 5mm per line of text)
                    y += (5 * splitTitle.length) + 4; 
                });
                
                doc.save(`SCC_Upcoming_Report_${monthName}.pdf`);
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-lg shadow border border-slate-200">
                             <div className="flex justify-between items-center mb-6">
                                 <h2 className="text-lg font-bold text-slate-800">Awards & Recognition</h2>
                                 <div className="flex items-center gap-2 bg-slate-100 rounded-lg p-1">
                                     <button onClick={() => setMonthOffset(m => m - 1)} className="p-2 hover:bg-white rounded-md text-slate-600 transition-colors" title="Previous Month">
                                         <Icon name="ChevronLeft" className="w-4 h-4" />
                                     </button>
                                     <span className="text-sm font-semibold text-slate-700 min-w-[140px] text-center">
                                         {monthOffset === 0 ? "Current (Last 30 Days)" : monthName}
                                     </span>
                                     <button onClick={() => setMonthOffset(m => m + 1)} className="p-2 hover:bg-white rounded-md text-slate-600 transition-colors" title="Next Month">
                                         <Icon name="ChevronRight" className="w-4 h-4" />
                                     </button>
                                 </div>
                             </div>
                             
                             <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                 {/* Achieved Column with Printing Logic */}
                                 <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                     <div className="flex justify-between items-end mb-4">
                                         <div className="flex items-center gap-2">
                                             <div className="p-2 bg-green-100 rounded-full text-green-700"><Icon name="CheckCircle" className="w-5 h-5" /></div>
                                             <div>
                                                 <h3 className="font-bold text-slate-700">Achieved</h3>
                                                 <p className="text-[10px] text-slate-500">Awards & Promotions in selected period</p>
                                             </div>
                                         </div>
                                         {pastAwards.length > 0 && (
                                             <button 
                                                 onClick={generateCertificates}
                                                 disabled={selectedAwardKeys.size === 0}
                                                 className={`text-xs px-3 py-1.5 rounded flex items-center gap-1 font-bold transition-all ${selectedAwardKeys.size > 0 ? 'bg-blue-800 text-white shadow' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                             >
                                                 <Icon name="Upload" className="w-3 h-3" /> Print PDF ({selectedAwardKeys.size})
                                             </button>
                                         )}
                                     </div>

                                     {pastAwards.length > 0 && (
                                         <div className="mb-2 flex justify-end">
                                             <button onClick={selectAllAwards} className="text-[10px] text-blue-600 hover:underline">
                                                 {selectedAwardKeys.size === pastAwards.length ? "Deselect All" : "Select All"}
                                             </button>
                                         </div>
                                     )}

                                     <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                         {pastAwards.length === 0 ? (
                                             <p className="text-sm text-slate-400 italic text-center py-4">No recent awards found.</p>
                                         ) : (
                                             pastAwards.map((award, idx) => (
                                                 <div key={award.uniqueId} className={`bg-white p-3 rounded shadow-sm border transition-colors flex items-start gap-3 ${selectedAwardKeys.has(award.uniqueId) ? 'border-blue-400 ring-1 ring-blue-100' : 'border-slate-100'}`}>
                                                     
                                                     <div className="pt-1">
                                                         <input 
                                                             type="checkbox" 
                                                             checked={selectedAwardKeys.has(award.uniqueId)}
                                                             onChange={() => toggleAwardSelection(award.uniqueId)}
                                                             className="w-4 h-4 rounded border-slate-300 text-blue-800 focus:ring-blue-800"
                                                         />
                                                     </div>

                                                     <div className="flex-1">
                                                         <div className="flex justify-between items-start">
                                                             <div>
                                                                 <p className="font-bold text-sm text-slate-800">{award.cadetName}</p>
                                                                 <p className="text-xs text-slate-600">{award.module}</p>
                                                             </div>
                                                             <span className={`px-2 py-1 rounded-full text-[10px] font-semibold whitespace-nowrap ${
                                                                 award.type === 'Specialisation' ? 'bg-orange-100 text-orange-800' : 
                                                                 award.type === 'Proficiency' ? 'bg-emerald-100 text-emerald-800' : 
                                                                 award.type === 'DofE' ? 'bg-yellow-100 text-yellow-800' :
                                                                 award.type === 'Promotion' ? 'bg-purple-100 text-purple-800' :
                                                                 'bg-blue-100 text-blue-800'
                                                             }`}>
                                                                 {award.type}
                                                             </span>
                                                         </div>
                                                         <p className="text-[10px] text-slate-400 mt-1 text-right">{formatDate(award.date)}</p>
                                                     </div>
                                                 </div>
                                             ))
                                         )}
                                     </div>
                                 </div>
                                 
                                 {/* Upcoming Awards (Modified) */}
                                 <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                     <div className="flex justify-between items-end mb-4">
                                         <div className="flex items-center gap-2">
                                             <div className="p-2 bg-amber-100 rounded-full text-amber-700"><Icon name="Calendar" className="w-5 h-5" /></div>
                                             <div>
                                                 <h3 className="font-bold text-slate-700">Due / Upcoming</h3>
                                                 <p className="text-[10px] text-slate-500">Awards due or upcoming in 30 days</p>
                                             </div>
                                         </div>
                                         {upcomingAwards.length > 0 && (
                                             <button 
                                                 onClick={generateUpcomingReport}
                                                 className={`text-xs px-3 py-1.5 rounded flex items-center gap-1 font-bold transition-all bg-amber-700 hover:bg-amber-800 text-white shadow`}
                                             >
                                                 <Icon name="FileText" className="w-3 h-3" /> Print Report
                                             </button>
                                         )}
                                     </div>

                                     <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                         {upcomingAwards.length === 0 ? (
                                             <p className="text-sm text-slate-400 italic text-center py-4">No upcoming awards found.</p>
                                         ) : (
                                             upcomingAwards.map((award, idx) => (
                                                 <div key={idx} className="bg-white p-3 rounded shadow-sm border border-slate-100 transition-colors flex items-start gap-3">
                                                     <div className="flex-1">
                                                         <div className="flex justify-between items-start">
                                                             <div>
                                                                 <p className="font-bold text-sm text-slate-800">{award.cadetName}</p>
                                                                 <p className="text-xs text-slate-600">{award.module}</p>
                                                             </div>
                                                             <span className={`px-2 py-1 rounded-full text-[10px] font-semibold whitespace-nowrap ${
                                                                 award.type === 'Award Due' ? 'bg-red-100 text-red-800' : 'bg-amber-100 text-amber-800'
                                                             }`}>
                                                                 {award.type}
                                                             </span>
                                                         </div>
                                                         <p className="text-[10px] text-slate-400 mt-1 text-right">
                                                             {award.type === 'Award Due' ? 'Action Required' : `Due: ${formatDate(award.date)}`}
                                                         </p>
                                                     </div>
                                                 </div>
                                             ))
                                         )}
                                     </div>
                                 </div>
                             </div>
                    </div>
                </div>
            );
        };

        const WaterborneView = ({ personnel, qualsData }) => {
            const [filterActivity, setFilterActivity] = useState("Swim");
            const activityOptions = ["Swim", "Paddle", "Row", "Sail", "Power", "Windsurf", "Shorebased", "Offshore"];
            const sortedCadets = useMemo(() => [...personnel].sort((a, b) => a.name.localeCompare(b.name)), [personnel]);
            
            // Modified to retrieve the full record, not just check existence
            const getWaterborneRecord = (cadet, mod) => {
                return qualsData.find(q => q.pNumber === cadet.pNumber && ((q.module.includes(mod.title)) || (mod.alts && mod.alts.some(alt => q.module.includes(alt)))));
            };
            
            // Define helper locally so it has access to the qualsData prop scope
            const hasQualContaining = (cadet, str) => qualsData.some(q => q.pNumber === cadet.pNumber && q.module && q.module.toLowerCase().includes(str.toLowerCase()));

            const getCadetStatusColor = (cadet) => {
                // Check if they already have the award
                // Relaxed string matching: "Master Coxswain" instead of "Master Coxswain Award" to catch variations
                const hasMasterAward = hasQualContaining(cadet, "Master Coxswain");
                if (hasMasterAward) return "status-master-awarded";
                // Relaxed string matching: "Coxswain Award" or "SCC Coxswain"
                const hasCoxswainAward = hasQualContaining(cadet, "Coxswain Award") || hasQualContaining(cadet, "SCC Coxswain");
                if (hasCoxswainAward) return "status-cox-awarded";

                let proficienciesMet = 0;
                if (hasQualContaining(cadet, "Rowing Coxswain") || hasQualContaining(cadet, "SCC Coxswain") || hasQualContaining(cadet, "Row 3")) proficienciesMet++;
                if (hasQualContaining(cadet, "Paddle Explore")) proficienciesMet++;
                if (hasQualContaining(cadet, "Stage 4")) proficienciesMet++;
                if (hasQualContaining(cadet, "Windsurfing") && (hasQualContaining(cadet, "Stage 2") || hasQualContaining(cadet, "Stage 3") || hasQualContaining(cadet, "Stage 4"))) proficienciesMet++;

                const meetsCoxswainCriteria = proficienciesMet >= 2;
                let meetsMasterCriteria = false;

                if (meetsCoxswainCriteria) {
                    const hasPB2 = hasQualContaining(cadet, "Powerboat Level 2") || hasQualContaining(cadet, "Powerboat L2") || hasQualContaining(cadet, "Level 2 Planing") || hasQualContaining(cadet, "Level 2 Disp");
                    const hasENS = hasQualContaining(cadet, "Essential Navigation");
                    const hasDaySkipper = hasQualContaining(cadet, "Day Skipper") || hasQualContaining(cadet, "Watch Leader");

                    if (hasPB2) {
                        const hasNavP1 = hasENS || hasDaySkipper;
                        if (hasNavP1) {
                            const hasP1Option = hasQualContaining(cadet, "Assistant Rowing Instructor") || hasQualContaining(cadet, "CST") || hasQualContaining(cadet, "FSRT") || hasQualContaining(cadet, "Foundation Safety") || hasQualContaining(cadet, "PSRC") || hasQualContaining(cadet, "Paddle Safety") || hasQualContaining(cadet, "Assistant Instructor") || (hasQualContaining(cadet, "Assistant") && hasQualContaining(cadet, "Windsurf"));
                            if (hasP1Option) meetsMasterCriteria = true;
                        }
                        if (!meetsMasterCriteria && hasENS) {
                            const hasP2Option = hasQualContaining(cadet, "Paddlesport Instructor") || (hasQualContaining(cadet, "Dinghy Instructor") && !hasQualContaining(cadet, "Assistant")) || (hasQualContaining(cadet, "Windsurfing Instructor") && !hasQualContaining(cadet, "Assistant")) || (hasQualContaining(cadet, "Powerboat Instructor") && !hasQualContaining(cadet, "Assistant"));
                            if (hasP2Option) meetsMasterCriteria = true;
                        }
                    }
                }

                if (meetsMasterCriteria) return "status-master-pending";
                if (meetsCoxswainCriteria) return "status-cox-pending";
                return "";
            };

            return (
                <div className="space-y-6">
                    <div className="bg-sky-50 p-6 rounded-lg border border-sky-100">
                        <h2 className="text-xl font-bold text-sky-900 mb-2">Waterborne Qualifications</h2>
                           <div className="flex items-center gap-4">
                                <label className="text-sm font-semibold text-sky-800">Filter Activity:</label>
                                <select value={filterActivity} onChange={(e) => setFilterActivity(e.target.value)} className="p-2 border border-sky-200 rounded shadow-sm text-sm">
                                    {activityOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                            <div className="mt-4 flex flex-wrap gap-3 text-xs">
                                <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-[#add8e6] border border-black"></span> Coxswain (Pending)</div>
                                <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-[#003366]"></span> Coxswain (Awarded)</div>
                                <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-[#ffffe0] border border-black"></span> Master (Pending)</div>
                                <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-[#ffd700] border border-black"></span> Master (Awarded)</div>
                            </div>
                    </div>
                    <div className="bg-white rounded-lg shadow overflow-hidden border border-slate-200">
                        <div className="planner-container">
                            <table className="planner-table w-full text-xs text-left border-collapse">
                                <thead>
                                    <tr>
                                        <th className="px-2 py-2 bg-slate-100 border-b border-r border-slate-200 sticky left-0 z-10 w-48 min-w-[150px] font-bold text-slate-700">Cadet Name</th>
                                        {Object.entries(WATER_SYLLABUS).filter(([c]) => c === filterActivity).map(([c, m]) => <React.Fragment key={c}>{m.map((mod, i) => <th key={mod.code} className="px-2 py-2 bg-slate-50 border-b border-slate-200 text-center font-semibold text-slate-600 min-w-[80px]" title={mod.title}><div className="flex flex-col items-center"><span className="text-[10px] text-slate-500 uppercase mb-1">{c}</span><span className="truncate max-w-[90px]">{mod.code}</span></div></th>)}</React.Fragment>)}
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedCadets.map(cadet => (
                                        <tr key={cadet.pNumber} className="hover:bg-slate-50 border-b border-slate-100 last:border-0 h-8">
                                            <td className={`px-2 py-1 border-r border-slate-200 font-medium text-slate-700 sticky left-0 z-10 ${getCadetStatusColor(cadet)}`}>{cadet.name} <span className="text-[9px] opacity-75 ml-1">({cadet.rank})</span></td>
                                            {Object.entries(WATER_SYLLABUS).filter(([c]) => c === filterActivity).map(([c, m]) => (
                                                <React.Fragment key={c}>
                                                    {m.map(mod => {
                                                        const record = getWaterborneRecord(cadet, mod);
                                                        const passed = !!record;
                                                        return (
                                                            <td key={mod.code} className={`px-1 py-1 text-center border-r border-slate-50 last:border-0 ${passed ? 'bg-passed' : ''}`}>
                                                                {passed && (
                                                                    <span className="text-xs text-white font-bold block leading-tight">
                                                                        {record.date ? formatDate(record.date) : 'Done'}
                                                                    </span>
                                                                )}
                                                            </td>
                                                        );
                                                    })}
                                                </React.Fragment>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        
        const CadetFocus = ({ personnel, qualsData }) => {
            const [selectedCadetPNum, setSelectedCadetPNum] = useState(personnel.length > 0 ? personnel[0].pNumber : "");
            
            // Force reset if selected cadet is not in list (e.g. new file load)
            useEffect(() => {
                if (personnel.length > 0 && (!selectedCadetPNum || !personnel.find(p => p.pNumber === selectedCadetPNum))) {
                    setSelectedCadetPNum(personnel[0].pNumber);
                }
            }, [personnel, selectedCadetPNum]);
            
            // Icon Render Fix
            useEffect(() => { lucide.createIcons(); }, [selectedCadetPNum]);

            const sortedPersonnel = useMemo(() => [...personnel].sort((a, b) => a.name.localeCompare(b.name)), [personnel]);
            const selectedCadet = useMemo(() => personnel.find(p => p.pNumber === selectedCadetPNum), [personnel, selectedCadetPNum]);
            
            const cadetAge = useMemo(() => selectedCadet?.dob ? calculateAge(selectedCadet.dob) : "Unknown", [selectedCadet]);
            const cadetAgeClass = useMemo(() => selectedCadet?.dob ? getCadetAgeColor(selectedCadet.dob) : "", [selectedCadet]);

            // Get Rank Images
            const rankImages = useMemo(() => {
                if(!selectedCadet) return null;
                return RANK_IMG_MAP[selectedCadet.rank] || null;
            }, [selectedCadet]);

            const gcbInfo = useMemo(() => {
                if (!selectedCadet) return null;

                // Search qualsData for GCB awards
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber);
                
                let level = 0;
                if (cadetQuals.some(q => q.module && q.module.includes("3rd Good Conduct Badge"))) {
                    level = 3;
                } else if (cadetQuals.some(q => q.module && q.module.includes("2nd Good Conduct Badge"))) {
                    level = 2;
                } else if (cadetQuals.some(q => q.module && q.module.includes("1st Good Conduct Badge"))) {
                    level = 1;
                }

                if (level === 0) return { text: "None", img: null };

                const isRMC = RMC_RANK_ORDER.includes(selectedCadet.rank) || 
                              selectedCadet.rank.includes("Marine") || 
                              selectedCadet.rank.includes("Corporal") || 
                              selectedCadet.rank.includes("Sergeant") ||
                              selectedCadet.rank.includes("Recruit");
                              
                const isPOC = selectedCadet.rank === "Petty Officer Cadet";

                let imgName = "";
                if (isRMC) {
                    imgName = `rmc_good_conduct_${level}yr.webp`;
                } else if (isPOC) {
                    imgName = `scc_cadet_poc_good_conduct_${level}yr.webp`;
                } else {
                    imgName = `scc_cadet_good_conduct_${level}yr.webp`;
                }

                const ordinal = level === 1 ? "1st" : level === 2 ? "2nd" : "3rd";
                return { text: `${ordinal} Good Conduct Badge`, img: imgName };
            }, [selectedCadet, qualsData]);

            // Logic for Appointments
            const appointmentInfo = useMemo(() => {
                if (!selectedCadet) return null;
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber);
                
                // Priority Check: First Sea Lord > Lord Lieutenant > Lord Mayor
                if (cadetQuals.some(q => q.module.includes("First Sea Lord"))) return { text: "First Sea Lord's Cadet", img: "scc_award_first_sea_lords_cadet.webp" };
                if (cadetQuals.some(q => q.module.includes("Lord Lieutenant"))) return { text: "Lord Lieutenant's Cadet", img: "scc_award_lord_lieutenants_cadet.webp" };
                if (cadetQuals.some(q => q.module.includes("Lord Mayor"))) return { text: "Lord Mayor's Cadet", img: "scc_award_lord_mayors_cadet.webp" };
                
                return null;
            }, [selectedCadet, qualsData]);

            // UPDATED HIERARCHY for Specialisations: Ensures correct hierarchy and names including Intermediate First Aid
            const CADET_FOCUS_HIERARCHY = {
                "Seamanship": ["Seamanship - Advanced (Class 1)", "Seamanship - Intermediate (Class 2)", "Seamanship - Basic (Class 3)"],
                "First Aid": ["First Aid - FAA Level 3 Award in Outdoor First Aid", "First Aid - Cadet First Aid Advanced", "First Aid - Cadet First Aid Intermediate", "First Aid - Cadet First Aid Basic"], 
                "Marine Engineering": [
                    "Marine Engineering (Mechanical) - Advanced", // NEW specific names
                    "Marine Engineering (Electrical) - Advanced", // NEW specific names
                    "Marine Engineering Mechanical - Advanced", 
                    "Marine Engineering Electrical - Advanced", 
                    "Marine Engineering - Advanced", 
                    "Marine Engineering - Intermediate", 
                    "Marine Engineering - Basic"
                ], // Re-ordered to prioritise specific advanced levels
                "Navigation": ["Navigation - Cadet Instructor", "Navigation - Advanced", "Navigation - Intermediate", "Navigation - Basic"],
                "CIS": ["CIS Principle Instructor", "Communication Information Systems - Radio Advanced", "Communication Information Systems - Radio Intermediate", "Communication Information Systems - Radio Basic", "CIS Info Sys - Advanced", "CIS Info Sys - Intermediate", "CIS Info Sys - Basic"],
                "Catering": ["Catering - Advanced", "Stewarding - Advanced", "Catering & Stewarding - Intermediate Catering", "Catering & Stewarding - Basic Catering", "Stewarding - Basic"],
                "PT": ["Physical Training - Instructor", "Physical Training - Advanced", "Physical Training - Intermediate", "Physical Training - Basic"]
            };

            const cadetSpecs = useMemo(() => {
                if (!selectedCadet) return [];
                
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber && q.module);
                const awardedSpecs = [];

                // Iterate through categories, searching for the highest achievement first (due to array order)
                Object.entries(CADET_FOCUS_HIERARCHY).forEach(([category, levels]) => {
                    let foundQual = null;
                    const highestAward = levels.find(specName => {
                        // Search levels in defined order (highest rank first)
                        // Use strict equality for common manual input strings to avoid false matches
                        foundQual = cadetQuals.find(q => q.module === specName || q.module.includes(specName));
                        return !!foundQual;
                    });

                    if (highestAward && foundQual) {
                        let mapKey = highestAward;
                        
                        // --- 1. Standardize mapping to BADGE_MAP keys ---
                        
                        const mapKeyLower = mapKey.toLowerCase();
                        
                        // First Aid Fix 
                        if (mapKeyLower.includes("faa level 3")) mapKey = "First Aid - Advanced";
                        else if (mapKeyLower.includes("cadet first aid advanced")) mapKey = "First Aid - Advanced";
                        else if (mapKeyLower.includes("cadet first aid intermediate")) mapKey = "First Aid - Intermediate";
                        else if (mapKeyLower.includes("cadet first aid basic")) mapKey = "First Aid - Basic";

                        // Marine Engineering Fix 
                        if (mapKeyLower.includes("marine engineering (mechanical) - advanced") || mapKeyLower.includes("marine engineering mechanical - advanced")) {
                             mapKey = "Marine Engineering Mechanical - Advanced"; 
                        }
                        else if (mapKeyLower.includes("marine engineering (electrical) - advanced") || mapKeyLower.includes("marine engineering electrical - advanced")) {
                            mapKey = "Marine Engineering Electrical - Advanced";
                        }
                        else if (mapKeyLower.includes("marine engineering - advanced")) {
                             // Fallback: If generic Advanced is used, assume Mechanical for the badge image
                             mapKey = "Marine Engineering Mechanical - Advanced"; 
                        }
                        else if (mapKeyLower.includes("marine engineering - intermediate")) mapKey = "Marine Engineering - Intermediate";
                        else if (mapKeyLower.includes("marine engineering - basic")) mapKey = "Marine Engineering - Basic";
                        
                        // Seamanship Cleanup (Maps classes)
                        else if (mapKeyLower.includes("seamanship - advanced")) mapKey = "Seamanship - Advanced";
                        else if (mapKeyLower.includes("seamanship - intermediate")) mapKey = "Seamanship - Intermediate";
                        else if (mapKeyLower.includes("seamanship - basic")) mapKey = "Seamanship - Basic";

                        // CIS / Radio Cleanup (Maps long names)
                        else if (mapKeyLower.includes("communication information systems - radio advanced")) mapKey = "CIS Radio - Advanced";
                        else if (mapKeyLower.includes("communication information systems - radio intermediate")) mapKey = "CIS Radio - Intermediate";
                        else if (mapKeyLower.includes("communication information systems - radio basic")) mapKey = "CIS Radio - Basic";
                        
                        // Catering/Stewarding Cleanup
                        else if (mapKeyLower.includes("intermediate catering")) mapKey = "Catering - Intermediate";
                        else if (mapKeyLower.includes("basic catering")) mapKey = "Catering - Basic";
                        else if (mapKeyLower.includes("catering - advanced")) mapKey = "Catering - Advanced";
                        else if (mapKeyLower.includes("stewarding - advanced")) mapKey = "Stewarding - Advanced";
                        else if (mapKeyLower.includes("stewarding - basic")) mapKey = "Stewarding - Basic";
                        
                        // Instructor/Info Sys Cleanup 
                        else if (mapKeyLower.includes("physical training (instructor)")) mapKey = "Physical Training - Instructor";
                        else if (mapKeyLower.includes("navigation (cadet instructor)")) mapKey = "Navigation - Cadet Instructor";
                        else if (mapKeyLower.includes("cis info sys - advanced")) mapKey = "CIS Info Sys - Advanced";
                        else if (mapKeyLower.includes("cis info sys - intermediate")) mapKey = "CIS Info Sys - Intermediate";
                        else if (mapKeyLower.includes("cis info sys - basic")) mapKey = "CIS Info Sys - Basic";
                        
                        // Drill 
                        else if (mapKeyLower.includes("drill - advanced")) mapKey = "Drill - Advanced";
                        else if (mapKeyLower.includes("drill - intermediate")) mapKey = "Drill - Intermediate";
                        else if (mapKeyLower.includes("drill - basic")) mapKey = "Drill - Basic";


                        // Final fallback for direct matches (e.g. Navigation - Advanced)
                        if (!BADGE_MAP[mapKey] && BADGE_MAP[highestAward]) {
                             mapKey = highestAward;
                        }
                        
                        awardedSpecs.push({ name: highestAward, key: mapKey, date: foundQual.date });
                    }
                });

                return awardedSpecs;
            }, [qualsData, selectedCadetPNum]);

            const CADET_FOCUS_PROFS_HIERARCHY = {
                "Campcraft": ["Campcraft (Advanced)", "Campcraft (Intermediate)", "Adv Trg - Basic Campcraft", "Campcraft (Basic)"], 
                "Climbing": ["Climbing (Advanced)", "Climbing (Intermediate)", "Climbing (Basic)"],
                "Mountain Biking": ["Mountain Biking (Advanced)", "Mountain Biking Advanced", "Mountain Biking (Intermediate)", "Mountain Biking Intermediate", "Mountain Biking (Basic)", "Mountain Biking Basic"],
                "Shooting": ["WT - GSB Full Bore Marksman", "WT - GSB Full Bore Advanced", "WT - GSB Full Bore Basic", "WT - GSB Small Bore Marksman", "WT - GSB Small Bore Advanced", "WT - GSB Small Bore Basic", "WT - GSB Air Rifle Marksman", "WT - GSB Air Rifle Advanced", "WT - GSB Air Rifle Basic"],
                "Piping": ["Piping Proficiency", "Piping Basic", "Piping - Basic"],
                "Music": ["Band - Bugling Proficiency", "Band - Band Proficiency", "Band - Drumming Proficiency", "Bugler", "Musician", "Drummer"], 
                "Comms": ["Radio Amateur", "Morse Code", "Semaphore"],
                "Met": ["Meteorology", "Met - Proficiency"],
                "Diving": ["Diving (Cadet)"]
            };

            const cadetProfs = useMemo(() => {
                if (!selectedCadet) return [];
                
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber && q.module);
                const awardedProfs = [];

                // Helper for hierarchical awards (Campcraft, Shooting, etc.)
                const checkAndAdd = (category, levels) => {
                      let foundQual = null;
                      const highestAward = levels.find(specName => {
                          foundQual = cadetQuals.find(q => q.module.includes(specName));
                          return !!foundQual;
                      });

                      if (highestAward && foundQual) {
                          let mapKey = highestAward; 
                          
                          // Clean up key for image map
                          const mapKeyLower = mapKey.toLowerCase();

                          // Shooting Cleanup
                          if(mapKeyLower.includes("air rifle marksman")) mapKey = "Air Rifle Marksman";
                          else if(mapKeyLower.includes("air rifle advanced")) mapKey = "Air Rifle Advanced";
                          else if(mapKeyLower.includes("air rifle basic")) mapKey = "Air Rifle Basic";
                          else if(mapKeyLower.includes("small bore marksman")) mapKey = "Small Bore Marksman";
                          else if(mapKeyLower.includes("small bore advanced")) mapKey = "Small Bore Advanced";
                          else if(mapKeyLower.includes("small bore basic")) mapKey = "Small Bore Basic";
                          else if(mapKeyLower.includes("full bore marksman")) mapKey = "Full Bore Marksman";
                          else if(mapKeyLower.includes("full bore advanced")) mapKey = "Full Bore Advanced";
                          else if(mapKeyLower.includes("full bore basic")) mapKey = "Full Bore Basic";

                          // Campcraft / Climbing / MTB Cleanup
                          else if(mapKeyLower.includes("campcraft")) mapKey = highestAward.includes("Advanced") ? "Campcraft (Advanced)" : highestAward.includes("Intermediate") ? "Campcraft (Intermediate)" : "Campcraft (Basic)";
                          else if(mapKeyLower.includes("climbing")) mapKey = highestAward.includes("Advanced") ? "Climbing (Advanced)" : highestAward.includes("Intermediate") ? "Climbing (Intermediate)" : "Climbing (Basic)";
                          else if(mapKeyLower.includes("mountain biking")) mapKey = highestAward.includes("Advanced") ? "Mountain Biking (Advanced)" : highestAward.includes("Intermediate") ? "Mountain Biking (Intermediate)" : "Mountain Biking (Basic)";
                          
                          // Met & Piping Cleanup
                          else if(mapKeyLower.includes("met - proficiency")) mapKey = "Meteorology";
                          else if(mapKeyLower.includes("piping - basic")) mapKey = "Piping Basic";
                          
                          // Final fallback
                          if (!BADGE_MAP[mapKey] && BADGE_MAP[highestAward]) {
                              mapKey = highestAward;
                          }

                          awardedProfs.push({ name: highestAward, key: mapKey, date: foundQual.date });
                      }
                  };

                // Music and Comms are parallel/non-hierarchical, so we iterate through all to display them all.
                Object.entries(CADET_FOCUS_PROFS_HIERARCHY).forEach(([category, levels]) => {
                    if (category === "Music" || category === "Comms" || category === "Diving") {
                        levels.forEach(lvl => {
                            const found = cadetQuals.find(q => q.module.includes(lvl));
                            if(found) {
                                let mapKey = lvl;
                                // Clean up key for image map
                                if(lvl.includes("Bugling")) mapKey = "Bugler";
                                else if(lvl.includes("Drumming")) mapKey = "Drummer";
                                else if(lvl.includes("Band Proficiency")) mapKey = "Musician";
                                else if(lvl.includes("Radio Amateur")) mapKey = "Radio Amateur";
                                else if(lvl.includes("Morse Code")) mapKey = "Morse Code";
                                else if(lvl.includes("Semaphore")) mapKey = "Semaphore";
                                else if(lvl.includes("Diving (Cadet)")) mapKey = "Diving (Cadet)";
                                
                                awardedProfs.push({ name: lvl, key: mapKey, date: found.date });
                            }
                        });
                    } else {
                        // For hierarchical awards, find and add the highest level.
                        checkAndAdd(category, levels);
                    }
                });

                return awardedProfs;
            }, [qualsData, selectedCadetPNum]);

            const CADET_FOCUS_WATERBORNE_HIERARCHY = {
                "General": ["Master Coxswain Award", "Coxswain Award"],
                "Rowing": ["SCC Rowing Instructor", "Rowing Instructor", "Rowing Coxswswain", "Rowing Supervised Coxswain", "Rowing Competent Crew", "SCC Row Coxswain Module"], 
                "Paddlesport": ["BC Paddlesport Instructor", "BC Paddle Discipline Specific", "BC Paddle Safety & Rescue Course (PSRC)", "BC Paddle Explore Award", "BC Paddle Discover Award"],
                "Sailing": ["Dinghy Instructor", "RYA Dinghy Instructor", "Dinghy - RYA Instructor", "Sail - RYA Sailing with Spinnakers", "Sail - RYA Seamanship Skills", "Sail - RYA Start Racing", "Sail - RYA Performance Sailing", "Sail - RYA Day Sailing", "Sailing Stage 4", "Sailing Stage 3", "Sailing Stage 2", "Sail - RYA YSS Stage 4", "Sail - RYA YSS Stage 3", "Sail - RYA YSS Stage 2"],
                "Windsurfing": ["RYA Start Windsurfing Instructor", "Windsurfing - RYA Start Windsurfing Instructor", "Wind - RYA YouthWS - Stage 4", "Wind - RYA YouthWS - Stage 3", "Wind - RYA YouthWS - Stage 2", "Wind - RYA YouthWS - Stage 1"],
                "Powerboat": ["RYA Powerboat Instructor", "Powerboat - RYA Powerboat Instructor", "Powerboat - RYA Powerboat Intermediate", "RYA Powerboat Level 2", "RYA Powerboat Level 1"],
                "Offshore Power": ["Offshore - Power Watch Leader", "Offshore - Power Seaman", "Offshore - Power Grade 2", "Offshore - Power Grade 1"],
                "Offshore Sail": ["Offshore - Sail Watch Leader", "Offshore - Sail Seaman", "Offshore - Sail Grade 2", "Offshore - Sail Grade 1"]
            };

            const cadetWaterborne = useMemo(() => {
                if (!selectedCadet) return [];
                
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber && q.module);
                const awardedWaterborne = [];
                const safetyBoatHeld = cadetQuals.some(q => q.module.includes("Safety Boat"));

                const swimQual = cadetQuals.find(q => {
                    const m = q.module.toLowerCase();
                    return m.includes("swim test") || m.includes("swimming test") || m.includes("water safety");
                });

                if (swimQual) {
                    awardedWaterborne.push({ name: "Swim Test / Water Safety", key: "Swim Test", date: swimQual.date });
                } else {
                    awardedWaterborne.push({ name: "Swim Test Required", key: "No Swim Test", date: null });
                }

                Object.entries(CADET_FOCUS_WATERBORNE_HIERARCHY).forEach(([category, levels]) => {
                    const highestAward = levels.find(specName => {
                        if (specName.includes("Powerboat Instructor")) {
                            return cadetQuals.some(q => q.module.includes("Powerboat Instructor") && !q.module.includes("Pre-Entry"));
                        }
                        return cadetQuals.some(q => q.module.includes(specName)); 
                    });

                    if (highestAward) {
                         let key = highestAward;
                         // Map to Badge Keys
                         if (highestAward.includes("Rowing Coxswain")) key = "Rowing Coxswain";
                         else if (highestAward.includes("Rowing Supervised Coxswain")) key = "Rowing Supervised Coxswain";
                         else if (highestAward.includes("Rowing Competent Crew")) key = "Rowing Competent Crew";
                         else if (highestAward.includes("Rowing Instructor")) key = "Rowing Instructor";
                         else if (highestAward.includes("Explore Award")) key = "Paddle Explore Award";
                         else if (highestAward.includes("Discover Award")) key = "Paddle Discover Award";
                         else if (highestAward.includes("Paddlesport Instructor")) key = "Paddlesport Instructor";
                         else if (highestAward.includes("Dinghy Instructor")) key = "Dinghy Instructor";
                         else if (highestAward.includes("Stage 4") && category === "Sailing") key = "Sailing Stage 4 / Level 3";
                         else if (highestAward.includes("Stage 3") && category === "Sailing") key = "Sailing Stage 3 / Level 2";
                         else if (highestAward.includes("Stage 2") && category === "Sailing") key = "Sailing Stage 2 / Level 1";
                         else if (highestAward.includes("Spinnakers")) key = "Sailing with Spinnakers";
                         else if (highestAward.includes("Seamanship Skills")) key = "Seamanship Skills";
                         else if (highestAward.includes("Start Racing")) key = "Start Racing";
                         else if (highestAward.includes("Performance Sailing")) key = "Performance Sailing";
                         else if (highestAward.includes("Day Sailing")) key = "Day Sailing";
                         else if (highestAward.includes("Start Windsurfing Instructor")) key = "Windsurfing Instructor";
                         else if (highestAward.includes("Stage 4") && category === "Windsurfing") key = "Windsurfing Stage 4";
                         else if (highestAward.includes("Stage 3") && category === "Windsurfing") key = "Windsurfing Stage 3";
                         else if (highestAward.includes("Stage 2") && category === "Windsurfing") key = "Windsurfing Stage 2";
                         else if (highestAward.includes("Stage 1") && category === "Windsurfing") key = "Windsurfing Stage 1";
                         else if (highestAward.includes("Powerboat Instructor")) key = "Powerboat Instructor";
                         else if (highestAward.includes("Powerboat Level 2")) key = "RYA Powerboat Level 2";
                         else if (highestAward.includes("Powerboat Level 1")) key = "RYA Powerboat Level 1";
                         else if (highestAward.includes("Power Watch Leader")) key = "Offshore Power Watch Leader";
                         else if (highestAward.includes("Power Seaman")) key = "Offshore Power Seaman";
                         else if (highestAward.includes("Power Grade 2")) key = "Offshore Power Grade 2";
                         else if (highestAward.includes("Power Grade 1")) key = "Offshore Power Grade 1";
                         else if (highestAward.includes("Sail Watch Leader")) key = "Offshore Sailing Watch Leader";
                         else if (highestAward.includes("Sail Seaman")) key = "Offshore Sailing Seaman";
                         else if (highestAward.includes("Sail Grade 2")) key = "Offshore Sailing Grade 2";
                         else if (highestAward.includes("Sail Grade 1")) key = "Offshore Sailing Grade 1";
                         else if (highestAward.includes("Master Coxswain")) key = "Master Coxswain";
                         else if (highestAward === "Coxswain Award" || highestAward === "SCC Row Coxswain Module") key = "Cadet Coxswain";

                        const qualRecord = cadetQuals.find(q => q.module.includes(highestAward));

                        awardedWaterborne.push({ name: highestAward, key: key, date: qualRecord ? qualRecord.date : null });
                    }
                    
                    if (category === "Powerboat" && safetyBoatHeld) {
                         if (!awardedWaterborne.some(wb => wb.name.includes("Safety Boat"))) {
                             const sbQual = cadetQuals.find(q => q.module.includes("Safety Boat"));
                             awardedWaterborne.push({ name: "RYA Safety Boat", key: "RYA Safety Boat", date: sbQual ? sbQual.date : null });
                         }
                    }
                });

                return awardedWaterborne;
            }, [qualsData, selectedCadetPNum]);

            const cadetSpecificAwards = useMemo(() => {
                if (!selectedCadet) return [];
                const awards = [];
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber && q.module);
                
                const getQual = (str) => {
                    return cadetQuals.find(q => q.module.toLowerCase().includes(str.toLowerCase()));
                };
                
                const getQualMulti = (str1, str2) => {
                    return cadetQuals.find(q => {
                        const m = q.module.toLowerCase();
                        return m.includes(str1.toLowerCase()) && m.includes(str2.toLowerCase());
                    });
                };

                let q = getQual("Canada Trophy");
                if (q) awards.push({ name: "Canada Trophy", key: "Canada Trophy", date: q.date });

                q = getQual("Commodore's Broad Pennant") || getQual("Broad Pennant");
                // Exclude JSC Broad Pennant from main awards if present
                if (q && !q.module.includes("JSC")) awards.push({ name: "Commodore's Broad Pennant", key: "Commodore's Broad Pennant", date: q.date });

                q = getQualMulti("Gold", "DofE");
                if (q) awards.push({ name: "DofE Gold", key: "DofE Gold", date: q.date });
                else {
                    q = getQualMulti("Silver", "DofE");
                    if (q) awards.push({ name: "DofE Silver", key: "DofE Silver", date: q.date });
                    else {
                        q = getQualMulti("Bronze", "DofE");
                        if (q) awards.push({ name: "DofE Bronze", key: "DofE Bronze", date: q.date });
                    }
                }

                q = getQual("BTEC Level 1") || getQualMulti("BTEC", "Level 1");
                if (q) awards.push({ name: "BTEC Level 1", key: "BTEC Level 1", date: q.date });
                
                q = getQual("BTEC Level 2") || getQualMulti("BTEC", "Level 2");
                if (q) awards.push({ name: "BTEC Level 2", key: "BTEC Level 2", date: q.date });

                q = getQual("Gold Wings");
                if (q) awards.push({ name: "Aviation Gold Wings", key: "Aviation Gold Wings", date: q.date });
                else {
                    q = getQual("Silver Wings");
                    if (q) awards.push({ name: "Aviation Silver Wings", key: "Aviation Silver Wings", date: q.date });
                    else {
                        q = getQual("Bronze Wings");
                        if (q) awards.push({ name: "Aviation Bronze Wings", key: "Aviation Bronze Wings", date: q.date });
                        else {
                            q = getQual("Aviation Wings") || getQual("Wings (Standard)");
                            if (q) awards.push({ name: "Aviation Wings (Standard)", key: "Aviation Wings (Standard)", date: q.date });
                        }
                    }
                }

                return awards;
            }, [qualsData, selectedCadetPNum, selectedCadet]);

            const cadetJuniorAwards = useMemo(() => {
                if (!selectedCadet) return [];
                const awards = [];
                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber && q.module);
                
                const juniorBadgeList = [
                    { search: "Red Unit Activities", name: "JSC Red - Unit", key: "SCC - JSC Red Unit Activities Badge" },
                    { search: "Blue Waterborne", name: "JSC Blue - Waterborne", key: "SCC - JSC Blue Waterborne Activities Badge" },
                    { search: "Green Outdoor", name: "JSC Green - Outdoor", key: "SCC - JSC Green Outdoor & Recreation Activities Badge" },
                    { search: "Yellow Community", name: "JSC Yellow - Community", key: "SCC - JSC Yellow Community & Citizenship Activities Badge" },
                    { search: "STEM", name: "JSC STEM", key: "SCC - JSC STEM Unit Activities Badge" },
                    { search: "JSC Commodores Broad Pennant", name: "JSC Broad Pennant", key: "SCC - JSC Commodores Broad Pennant" } 
                ];

                juniorBadgeList.forEach(item => {
                      const found = cadetQuals.find(q => q.module.includes(item.search));
                      if (found) {
                          awards.push({ name: item.name, key: item.key, date: found.date });
                      }
                });

                return awards;
            }, [qualsData, selectedCadetPNum, selectedCadet]);

            const cadetRecordGroups = useMemo(() => {
                if (!selectedCadet) return { ctp: {}, cts: {}, waterborne: {}, other: [], ctpKeys: [], ctsKeys: [], wbKeys: [] };
                
                const ctpGrouped = {};
                const ctsGrouped = {};
                const waterborneGrouped = {};
                const otherList = [];

                // Initialize groups based on order
                SCC_RANK_ORDER.forEach(r => ctpGrouped[r] = []);
                RMC_RANK_ORDER.forEach(r => ctsGrouped[r] = []);
                const WB_ORDER = ["Rowing", "Paddling", "Sailing", "Windsurfing", "Powerboat"];
                WB_ORDER.forEach(d => waterborneGrouped[d] = []);

                const getSccRank = (modName) => {
                    for (const rank of SCC_RANK_ORDER) {
                        if (SCC_SYLLABUS[rank]) {
                            for (const cat of Object.values(SCC_SYLLABUS[rank])) {
                                if (cat.some(m => modName.includes(m.code) || modName === m.title)) return rank;
                            }
                        }
                    }
                    return null;
                };

                const getRmcRank = (modName) => {
                    for (const rank of RMC_RANK_ORDER) {
                        if (RMC_SYLLABUS[rank]) {
                            for (const cat of Object.values(RMC_SYLLABUS[rank])) {
                                if (cat.some(m => modName.includes(m.code) || modName === m.title)) return rank;
                            }
                        }
                    }
                    return null;
                };

                const getWaterborneDisc = (modName) => {
                    const m = modName.toLowerCase();
                    if(m.includes('rowing') || m.includes('row ')) return "Rowing";
                    if(m.includes('paddle') || m.includes('canoe') || m.includes('kayak') || m.includes('sup ')) return "Paddling";
                    if(m.includes('sail') || m.includes('dinghy') || m.includes('spinnaker') || m.includes('seamanship')) return "Sailing";
                    if(m.includes('windsurf') || m.includes('wind -') || m.includes('youthws')) return "Windsurfing"; 
                    if(m.includes('powerboat') || m.includes('power ') || m.includes('safety boat')) return "Powerboat";
                    return null;
                };

                const isUsedInBadges = (modName) => {
                    // Check Specialisations
                    const inSpec = Object.values(CADET_FOCUS_HIERARCHY).flat().some(spec => {
                        const clean = spec.replace(/\(.*\)/, "").trim();
                        return modName.includes(clean);
                    });
                    if (inSpec) return true;

                    // Check Proficiencies
                    const inProf = Object.values(CADET_FOCUS_PROFS_HIERARCHY).flat().some(prof => {
                          const clean = prof.replace(/\(.*\)/, "").trim();
                          return modName.includes(clean);
                    });
                    if (inProf) return true;

                    // Check Awards (DofE etc)
                    if (modName.includes("Canada Trophy") || (modName.includes("Broad Pennant") && !modName.includes("JSC")) || modName.includes("DofE") || modName.includes("BTEC") || modName.includes("Wings")) return true;
                    if (modName.includes("First Sea Lord") || modName.includes("Lord Lieutenant") || modName.includes("Lord Mayor")) return true;
                    
                    // Check Junior Awards
                    if (modName.includes("JSC") || modName.includes("Junior Section")) return true;

                    return false;
                };

                const cadetQuals = qualsData.filter(q => q.pNumber === selectedCadet.pNumber);
                
                cadetQuals.forEach(q => {
                    const modName = q.module;
                    if (!modName) return;

                    const sccRank = getSccRank(modName);
                    if (sccRank) {
                        ctpGrouped[sccRank].push(q);
                        return;
                    }

                    const rmcRank = getRmcRank(modName);
                    if (rmcRank) {
                        ctsGrouped[rmcRank].push(q);
                        return;
                    }

                    const wbDisc = getWaterborneDisc(modName);
                    if (wbDisc) {
                        waterborneGrouped[wbDisc].push(q);
                        return;
                    }

                    if (!isUsedInBadges(modName)) {
                        otherList.push(q);
                    }
                });

                // Sort lists
                const sortByDate = (list) => list.sort((a, b) => (b.date || 0) - (a.date || 0));
                const sortByModule = (list) => list.sort((a, b) => a.module.localeCompare(b.module, undefined, { numeric: true, sensitivity: 'base' }));
                
                Object.values(ctpGrouped).forEach(sortByModule);
                Object.values(ctsGrouped).forEach(sortByModule);
                Object.values(waterborneGrouped).forEach(sortByDate);
                sortByDate(otherList);

                return { 
                    ctp: ctpGrouped, 
                    cts: ctsGrouped, 
                    waterborne: waterborneGrouped, 
                    other: otherList, 
                    ctpKeys: SCC_RANK_ORDER.filter(r => ctpGrouped[r] && ctpGrouped[r].length > 0), 
                    ctsKeys: RMC_RANK_ORDER.filter(r => ctsGrouped[r] && ctsGrouped[r].length > 0), 
                    wbKeys: WB_ORDER.filter(k => waterborneGrouped[k] && waterborneGrouped[k].length > 0) 
                };
            }, [qualsData, selectedCadetPNum, selectedCadet]);


            if (!selectedCadet) return <div className="p-8 text-center text-slate-500">Please load data and select a cadet.</div>;

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-lg shadow border border-slate-200">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Icon name="User" className="w-6 h-6 text-blue-600"/> Cadet Focus</h2>
                                <p className="text-sm text-slate-500">Detailed view of achievements and awards.</p>
                            </div>
                            <div className="w-full md:w-64">
                                <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Select Cadet</label>
                                <select className="w-full p-2 border border-slate-300 rounded-md text-sm" value={selectedCadetPNum || ""} onChange={(e) => setSelectedCadetPNum(e.target.value)}>
                                    {sortedPersonnel.map(p => <option key={p.pNumber} value={p.pNumber}>{p.name}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div className={`p-4 rounded border ${cadetAgeClass ? cadetAgeClass : 'bg-slate-50'}`}>
                                <p className="text-xs text-slate-400 font-bold">Name & Age</p>
                                <p className="font-bold text-slate-700">{selectedCadet.name}</p>
                                <p className="text-sm text-slate-500">{cadetAge} years old</p>
                                <p className="text-xs text-slate-400 mt-2 font-mono bg-slate-100 inline-block px-1 rounded">{selectedCadet.pNumber}</p>
                            </div>
                            
                            <div className="bg-slate-50 p-4 rounded border">
                                <p className="text-xs text-slate-400 font-bold mb-2">Rank</p>
                                <div className="flex items-center gap-3">
                                    {rankImages || selectedCadet.rank === "Able Junior Cadet" ? (
                                        <>
                                            {selectedCadet.rank === "Able Junior Cadet" || rankImages?.count === 2 ? (
                                                <div className="flex gap-1">
                                                    <img src="media/scc_junior_star.webp" className="h-12 w-auto object-contain shadow-sm" alt="Rank Star 1" onError={(e) => e.target.style.display = 'none'} />
                                                    <img src="media/scc_junior_star.webp" className="h-12 w-auto object-contain shadow-sm" alt="Rank Star 2" onError={(e) => e.target.style.display = 'none'} />
                                                </div>
                                            ) : (
                                                <>
                                                    {rankImages?.sleeve && <img src={`media/${rankImages.sleeve}`} className="h-12 w-auto object-contain shadow-sm" alt="Sleeve Rank" title="Sleeve Badge" onError={(e) => e.target.style.display = 'none'} />}
                                                    {rankImages?.slide && <img src={`media/${rankImages.slide}`} className="h-12 w-auto object-contain shadow-sm" alt="Shoulder Slide" title="Shoulder Slide" onError={(e) => e.target.style.display = 'none'} />}
                                                </>
                                            )}
                                        </>
                                    ) : (
                                        <div className="h-12 w-12 bg-slate-200 rounded-full flex items-center justify-center text-slate-400">
                                            <Icon name="Shield" className="w-6 h-6"/>
                                        </div>
                                    )}
                                    <p className="font-bold text-slate-700 text-lg ml-2 leading-tight">{selectedCadet.rank}</p>
                                </div>
                            </div>
                            
                            <div className="bg-slate-50 p-4 rounded border">
                                <p className="text-xs text-slate-400 font-bold mb-2">Good Conduct Badge</p>
                                <div className="flex items-center gap-3">
                                    {gcbInfo && gcbInfo.img ? (
                                        <img src={`media/${gcbInfo.img}`} className="h-12 w-auto object-contain shadow-sm" alt={gcbInfo.text} title={gcbInfo.text} />
                                    ) : (
                                        <div className="h-12 w-12 bg-slate-200 rounded-full flex items-center justify-center text-slate-400">
                                            <Icon name="Star" className="w-6 h-6"/>
                                        </div>
                                    )}
                                    <p className="font-bold text-slate-700">{gcbInfo?.text || "None"}</p>
                                </div>
                            </div>

                            <div className="bg-slate-50 p-4 rounded border">
                                <p className="text-xs text-slate-400 font-bold mb-2">Appointment</p>
                                <div className="flex items-center gap-3">
                                    {appointmentInfo ? (
                                        <>
                                            <img src={`media/${appointmentInfo.img}`} className="h-12 w-auto object-contain shadow-sm" alt={appointmentInfo.text} title={appointmentInfo.text} />
                                            <p className="font-bold text-slate-700 text-sm leading-tight">{appointmentInfo.text}</p>
                                        </>
                                    ) : (
                                        <>
                                            <div className="h-12 w-12 bg-slate-200 rounded-full flex items-center justify-center text-slate-400">
                                                <Icon name="Award" className="w-6 h-6"/>
                                            </div>
                                            <p className="text-sm text-slate-400 italic">None held</p>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex flex-wrap gap-6 mb-6">
                            <div className="flex-auto max-w-full">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="Shield" className="w-5 h-5 text-indigo-500"/> Specialisations</h3>
                                
                                <div className="flex gap-4 overflow-x-auto pb-4">
                                    {cadetSpecs.map((spec, idx) => (
                                        <div key={idx} className="flex-shrink-0 flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-lg p-3 min-w-[120px] text-center">
                                            <div className="h-24 flex items-center justify-center mb-2">
                                                     <BadgeImage name={spec.key} className="h-24 w-auto object-contain" fallbackIcon="Award"/>
                                            </div>
                                            <p className="text-xs font-bold text-slate-700 leading-tight">{spec.name}</p>
                                            <p className="text-[10px] text-slate-500 mt-1">{formatDate(spec.date)}</p>
                                        </div>
                                    ))}
                                    {cadetSpecs.length === 0 && <div className="w-full text-center py-4 text-slate-400 italic bg-slate-50 rounded border border-dashed">No specialisations found for this cadet.</div>}
                                </div>
                            </div>

                            <div className="flex-auto max-w-full">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="Target" className="w-5 h-5 text-green-600"/> Proficiencies</h3>
                                
                                <div className="flex gap-4 overflow-x-auto pb-4">
                                    {cadetProfs.map((prof, idx) => (
                                        <div key={idx} className="flex-shrink-0 flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-lg p-3 min-w-[120px] text-center">
                                            <div className="h-24 flex items-center justify-center mb-2">
                                                     <BadgeImage name={prof.key} className="h-24 w-auto object-contain" fallbackIcon="Award"/>
                                            </div>
                                            <p className="text-xs font-bold text-slate-700 leading-tight">{prof.name}</p>
                                            <p className="text-[10px] text-slate-500 mt-1">{formatDate(prof.date)}</p>
                                        </div>
                                    ))}
                                    {cadetProfs.length === 0 && <div className="w-full text-center py-4 text-slate-400 italic bg-slate-50 rounded border border-dashed">No proficiencies found for this cadet.</div>}
                                </div>
                            </div>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="Anchor" className="w-5 h-5 text-blue-600"/> Waterborne Proficiencies</h3>
                            
                            <div className="flex gap-4 overflow-x-auto pb-4">
                                {cadetWaterborne.map((wb, idx) => (
                                    <div key={idx} className="flex-shrink-0 flex flex-col items-center justify-center bg-slate-50 border border-slate-200 rounded-lg p-3 min-w-[120px] text-center">
                                                <div className="h-24 flex items-center justify-center mb-2">
                                                    <BadgeImage name={wb.key} className="h-24 w-auto object-contain" fallbackIcon="Award"/>
                                                </div>
                                                <p className="text-xs font-bold text-slate-700 leading-tight">{wb.name}</p>
                                                <p className="text-[10px] text-slate-500 mt-1">{formatDate(wb.date)}</p>
                                    </div>
                                ))}
                                {cadetWaterborne.length === 0 && <div className="w-full text-center py-4 text-slate-400 italic bg-slate-50 rounded border border-dashed">No waterborne proficiencies found for this cadet.</div>}
                            </div>
                        </div>

                        <div>
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="BookOpen" className="w-5 h-5 text-slate-500"/> Other Qualifications / Record</h3>
                            
                            <div className="space-y-6">
                                {cadetRecordGroups.ctpKeys.length > 0 && (
                                    <div className="border rounded-lg overflow-hidden shadow-sm">
                                        <div className="bg-indigo-50 px-4 py-2 border-b border-indigo-100"><h4 className="font-bold text-indigo-800 text-sm">SCC CTP Modules</h4></div>
                                        {cadetRecordGroups.ctpKeys.map(rank => (
                                            <div key={rank}>
                                                <div className="px-4 py-1.5 bg-indigo-50/30 text-xs font-bold text-indigo-900 border-b border-indigo-50/50 uppercase tracking-wide">{rank}</div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 p-3 bg-white border-b border-slate-100 last:border-0">
                                                    {cadetRecordGroups.ctp[rank].map((q, i) => (
                                                        <div key={i} className="flex items-center gap-2 text-xs p-1 hover:bg-slate-50 rounded">
                                                            <span className="w-1.5 h-1.5 rounded-full bg-indigo-400 flex-shrink-0"></span>
                                                            <span className="truncate flex-1 font-medium text-slate-700" title={q.module}>{q.module}</span>
                                                            <span className="text-slate-400 text-[10px]">{formatDate(q.date)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {cadetRecordGroups.ctsKeys.length > 0 && (
                                    <div className="border rounded-lg overflow-hidden shadow-sm">
                                        <div className="bg-emerald-50 px-4 py-2 border-b border-emerald-100"><h4 className="font-bold text-emerald-800 text-sm">RMC CTS Modules</h4></div>
                                        {cadetRecordGroups.ctsKeys.map(rank => (
                                            <div key={rank}>
                                                <div className="px-4 py-1.5 bg-emerald-50/30 text-xs font-bold text-emerald-900 border-b border-emerald-50/50 uppercase tracking-wide">{rank}</div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 p-3 bg-white border-b border-slate-100 last:border-0">
                                                    {cadetRecordGroups.cts[rank].map((q, i) => (
                                                        <div key={i} className="flex items-center gap-2 text-xs p-1 hover:bg-slate-50 rounded">
                                                            <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 flex-shrink-0"></span>
                                                            <span className="truncate flex-1 font-medium text-slate-700" title={q.module}>{q.module}</span>
                                                            <span className="text-slate-400 text-[10px]">{formatDate(q.date)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {cadetRecordGroups.wbKeys.length > 0 && (
                                    <div className="border rounded-lg overflow-hidden shadow-sm">
                                        <div className="bg-sky-50 px-4 py-2 border-b border-sky-100"><h4 className="font-bold text-sky-800 text-sm">Waterborne Qualifications</h4></div>
                                        {cadetRecordGroups.wbKeys.map(disc => (
                                            <div key={disc}>
                                                <div className="px-4 py-1.5 bg-sky-50/30 text-xs font-bold text-sky-900 border-b border-sky-50/50 uppercase tracking-wide">{disc}</div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 p-3 bg-white border-b border-slate-100 last:border-0">
                                                    {cadetRecordGroups.waterborne[disc].map((q, i) => (
                                                        <div key={i} className="flex items-center gap-2 text-xs p-1 hover:bg-slate-50 rounded">
                                                            <span className="w-1.5 h-1.5 rounded-full bg-sky-400 flex-shrink-0"></span>
                                                            <span className="truncate flex-1 font-medium text-slate-700" title={q.module}>{q.module}</span>
                                                            <span className="text-slate-400 text-[10px]">{formatDate(q.date)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {cadetRecordGroups.other.length > 0 && (
                                    <div className="border rounded-lg overflow-hidden shadow-sm">
                                        <div className="bg-slate-50 px-4 py-2 border-b border-slate-100 flex justify-between items-center">
                                            <h4 className="font-bold text-slate-700 text-sm">Other Awards</h4>
                                            <span className="text-xs text-slate-500 bg-slate-200 px-2 py-0.5 rounded-full">{cadetRecordGroups.other.length} records</span>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 p-3 bg-white">
                                            {cadetRecordGroups.other.map((q, i) => (
                                                <div key={i} className="flex items-center gap-2 text-xs p-1 hover:bg-slate-50 rounded">
                                                    <span className="w-1.5 h-1.5 rounded-full bg-slate-300 flex-shrink-0"></span>
                                                    <span className="truncate flex-1 font-medium text-slate-700" title={q.module}>{q.module}</span>
                                                    <span className="text-slate-400 text-[10px]">{formatDate(q.date)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- UPDATED TrainingPlanner with Drill-Down Logic and Empty Cadet Fix ---
        const TrainingPlanner = ({ personnel, getCadetProgress, qualsData, title, rankOrder, syllabus, colorTheme = "indigo", iconName, onModuleClick }) => {
            const [selectedRank, setSelectedRank] = useState(rankOrder[0]);
            const cadetsAtRank = useMemo(() => personnel.filter(p => p.rank === selectedRank), [personnel, selectedRank]);
            const currentSyllabus = syllabus[selectedRank];
            
            // Fix for displaying modules even if no cadets are at this rank
            const hasCadets = cadetsAtRank.length > 0;
            // Define the list for table columns (either real cadets or a single placeholder)
            const cadetsForColumns = hasCadets ? cadetsAtRank : [{ pNumber: 'PLACEHOLDER', name: 'No Cadets at Rank', rank: selectedRank }];

            // Force icons update when rank changes to ensure new content has icons
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [selectedRank]);

            const getModuleRecord = (cadet, mod) => {
                if (!cadet || !mod) return null;
                const cleanModCode = mod.code.toLowerCase();
                const cleanModTitle = mod.title.toLowerCase();
                const found = qualsData.find(q => {
                    if (q.pNumber !== cadet.pNumber || !q.module) return false;
                    const qMod = q.module.toLowerCase();
                    return qMod.includes(cleanModCode) || qMod === cleanModTitle || qMod.includes(cleanModTitle);
                });
                return found || null;
            };

            const handleModuleClick = (mod, category) => {
                // Only allow click if there are actual cadets to drill down into
                if (!hasCadets) return;

                const cadetsNeeding = cadetsAtRank
                    .filter(c => !getModuleRecord(c, mod))
                    .map(c => ({ name: c.name, pNumber: c.pNumber }));

                onModuleClick({ ...mod, category }, selectedRank, cadetsNeeding);
            };

            if (!currentSyllabus) {
                return (
                    <div className="space-y-6">
                        <div className={`p-6 rounded-lg border ${colorTheme === "green" ? "bg-green-50 border-green-100" : "bg-indigo-50 border-indigo-100"}`}>
                            <h2 className="text-xl font-bold text-slate-800">{title}</h2>
                            <p className="text-sm">Select target rank: 
                                <select value={selectedRank} onChange={(e) => setSelectedRank(e.target.value)} className="p-2 border rounded shadow-sm ml-2">
                                    {rankOrder.map(r => <option key={r} value={r}>{r}</option>)}
                                </select>
                            </p>
                        </div>
                        <div className="text-center py-12 bg-white rounded border border-dashed border-slate-300 text-slate-400">
                             No syllabus defined for {selectedRank}.
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className={`p-6 rounded-lg border ${colorTheme === "green" ? "bg-green-50 border-green-100" : "bg-indigo-50 border-indigo-100"}`}>
                        <div className="flex items-center gap-3 mb-4">
                            <div className={`p-3 rounded-full ${colorTheme === "green" ? "bg-green-200 text-green-800" : "bg-indigo-200 text-indigo-800"}`}>
                                <Icon name={iconName || "FileText"} className="w-6 h-6" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800">{title}</h2>
                        </div>
                       <div className="flex items-center gap-4">
                            <label className="text-sm font-semibold">Plan training for cadets currently ranked:</label>
                            <select value={selectedRank} onChange={(e) => setSelectedRank(e.target.value)} className="p-2 border rounded shadow-sm">
                                {rankOrder.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                        </div>
                    </div>
                        <div className="bg-white rounded-lg shadow overflow-hidden border border-slate-200">
                            <div className="planner-container">
                                <table className="planner-table w-full text-xs text-left border-collapse">
                                    <thead>
                                            <tr>
                                                <th className="px-2 py-2 bg-slate-100 border-b border-r border-slate-200 sticky left-0 z-10 w-48 min-w-[150px] font-bold text-slate-700">Module / Cadet</th>
                                                {cadetsForColumns.map(c => {
                                                    const ageClass = getCadetAgeColor(c.dob); // Apply age color to header cell
                                                    if (c.pNumber === 'PLACEHOLDER') {
                                                        return <th key={c.pNumber} className="px-1 py-2 bg-slate-50 border-b border-slate-200 text-center font-semibold text-slate-600 min-w-[100px]"><div className="flex flex-col items-center"><span className="text-xs text-slate-400">No Cadets at Rank</span></div></th>;
                                                    }
                                                    // Existing logic for real cadets
                                                    const progress = getCadetProgress(c);
                                                    return <th key={c.pNumber} className={`px-1 py-2 bg-slate-50 border-b border-slate-200 text-center font-semibold text-slate-600 min-w-[100px] ${ageClass}`}><div className="flex flex-col items-center"><span className="truncate max-w-[90px]">{c.name.split(',')[0]}</span><span className="text-[9px] text-slate-400 font-normal mb-1">{c.name.split(',')[1]}</span><div className="w-full px-2"><div className="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden mb-0.5"><div className={`h-full ${progress.percentage === 100 ? 'bg-green-500' : progress.percentage > 50 ? 'bg-amber-500' : 'bg-red-500'}`} style={{width: `${progress.percentage}%`}}></div></div><span className="text-[9px] font-bold text-slate-500">{progress.percentage}%</span></div></div></th>
                                                })}
                                            </tr>
                                    </thead>
                                    <tbody>
                                            {currentSyllabus && Object.entries(currentSyllabus).map(([category, modules]) => <React.Fragment key={category}><tr className="bg-slate-100"><td colSpan={cadetsForColumns.length + 1} className="px-2 py-1 font-bold text-[10px] text-slate-500 uppercase border-y border-slate-200 tracking-wider">{category}</td></tr>{modules.map(mod => <tr key={mod.code} className="hover:bg-slate-50 border-b border-slate-100 last:border-0 h-8">
                                            <td 
                                                className={`cursor-pointer px-2 py-1 border-r border-slate-200 font-medium text-slate-700 sticky left-0 z-10 bg-white !important ${hasCadets ? 'hover:bg-blue-50 transition-colors' : ''}`}
                                                title={hasCadets ? `Click to see cadets needing ${mod.title}` : mod.title}
                                                onClick={() => handleModuleClick(mod, category)}
                                            >
                                                <span className="font-bold text-blue-600 mr-1">{mod.code}</span><span className="text-[10px] text-slate-500 truncate max-w-[120px] inline-block align-middle">{mod.title}</span>
                                            </td>
                                            {cadetsForColumns.map(c => {
                                                if (c.pNumber === 'PLACEHOLDER') {
                                                     return <td key={`${c.pNumber}-${mod.code}`} className={`px-1 py-1 text-center border-r border-slate-50 last:border-0`}>-</td>;
                                                }
                                                // Existing logic for real cadets
                                                const record = getModuleRecord(c, mod);
                                                const passed = !!record;
                                                return (
                                                    <td key={`${c.pNumber}-${mod.code}`} className={`px-1 py-1 text-center border-r border-slate-50 last:border-0 ${passed ? 'bg-passed' : ''}`}>
                                                        {passed ? (
                                                            <span className="text-[10px] text-white font-bold block leading-tight">{record.date ? formatDate(record.date) : 'Done'}</span>
                                                        ) : (
                                                            <div className="flex justify-center opacity-10"><div className="w-1 h-1 rounded-full bg-slate-400"></div></div>
                                                        )}
                                                    </td>
                                                );
                                            })}</tr>)}</React.Fragment>)}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                </div>
            );
        };

        const TrainingSuggestions = ({ personnel, getCadetProgress, qualsData }) => {
            const [selectedRank, setSelectedRank] = useState(SCC_RANK_ORDER[0]);
            const ALL_RANKS = [...SCC_RANK_ORDER, ...RMC_RANK_ORDER];
            const cadetsAtRank = useMemo(() => personnel.filter(p => p.rank === selectedRank), [personnel, selectedRank]);
            
            const suggestions = useMemo(() => {
                if (!cadetsAtRank.length) return [];
                const isRMC = RMC_RANK_ORDER.includes(selectedRank);
                const syllabus = isRMC ? RMC_SYLLABUS : SCC_SYLLABUS;
                const currentSyllabus = syllabus[selectedRank];
                if (!currentSyllabus) return [];
                
                const demandMap = new Map();
                const hasPassed = (c, code) => qualsData.some(q => q.pNumber === c.pNumber && q.module.includes(code));
                
                cadetsAtRank.forEach(c => {
                    Object.values(currentSyllabus).forEach(cat => {
                        cat.forEach((mod, idx) => {
                            if (!hasPassed(c, mod.code)) {
                                // Simple prereq check: needs previous module in category
                                if (idx === 0 || hasPassed(c, cat[idx-1].code)) {
                                    const entry = demandMap.get(mod.code) || { ...mod, count: 0, students: [] };
                                    entry.count++;
                                    entry.students.push(c.name);
                                    demandMap.set(mod.code, entry);
                                }
                            }
                        });
                    });
                });
                return Array.from(demandMap.values()).sort((a,b) => b.count - a.count).slice(0, 10);
            }, [cadetsAtRank, qualsData, selectedRank]);

            return (
                <div className="space-y-6">
                    <div className="bg-purple-50 p-6 rounded-lg border border-purple-100">
                        <h2 className="text-xl font-bold text-purple-900 mb-2">Training Suggestions</h2>
                        <div className="flex items-center gap-4">
                            <label className="text-sm font-semibold text-purple-800">Target Rank:</label>
                            <select value={selectedRank} onChange={(e) => setSelectedRank(e.target.value)} className="p-2 border border-purple-200 rounded shadow-sm text-sm">{ALL_RANKS.map(r => <option key={r} value={r}>{r}</option>)}</select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {suggestions.length === 0 ? <div className="col-span-full text-center py-12 bg-white rounded border border-dashed text-slate-400">No suggestions.</div> : suggestions.map(mod => (
                            <div key={mod.code} className="bg-white p-4 rounded shadow border-l-4 border-purple-500">
                                <div className="flex justify-between mb-2"><h3 className="font-bold">{mod.code}</h3><span className="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded-full">{mod.count} Cadets</span></div>
                                <p className="text-sm text-slate-600 truncate mb-2">{mod.title}</p>
                                <div className="text-[10px] text-slate-400">Ready: {mod.students.slice(0,3).map(s=>s.split(',')[0]).join(', ')}{mod.students.length>3 && '...'}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('upload'); 
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [personnelData, setPersonnelData] = useState([]);
            const [qualsData, setQualsData] = useState([]);
            // NEW STATE for Drill Down Feature
            const [drillDownInfo, setDrillDownInfo] = useState(null); 

            useEffect(() => { lucide.createIcons(); }, [view, sidebarCollapsed, drillDownInfo]);

            useEffect(() => {
                const savedVersion = localStorage.getItem('scc_version');
                if (savedVersion !== DATA_VERSION) {
                    localStorage.clear();
                    localStorage.setItem('scc_version', DATA_VERSION);
                } else {
                    const savedP = localStorage.getItem('scc_personnel');
                    const savedQ = localStorage.getItem('scc_quals');
                    if (savedP && savedQ) {
                        try {
                            const parsedP = JSON.parse(savedP);
                            const parsedQ = JSON.parse(savedQ);
                            
                            // Rehydrate Date objects
                            const hydratedQ = parsedQ.map(q => ({
                                ...q,
                                date: q.date ? new Date(q.date) : null
                            }));
                            
                            setPersonnelData(parsedP);
                            setQualsData(hydratedQ);
                            // Set to 'home' view when data is loaded from storage
                            setView('home'); 
                        } catch (e) {
                            console.error("Error rehydrating data", e);
                            localStorage.clear();
                        }
                    }
                }
            }, []);

            const handleDataLoaded = (pData, qData) => {
                setPersonnelData(pData);
                setQualsData(qData);
                localStorage.setItem('scc_personnel', JSON.stringify(pData));
                localStorage.setItem('scc_quals', JSON.stringify(qData));
                // Set to 'home' view when data is freshly loaded
                setView('home'); 
            };

            const clearData = () => {
                localStorage.clear();
                window.location.reload();
            };

            // NEW: Handler for Module Drill-Down
            const handleModuleDrillDown = (module, targetRank, cadetsNeeding) => {
                setDrillDownInfo({ module, targetRank, cadetsNeeding });
            };

            // This func ensures planner works
            const getCadetProgress = (cadet) => {
                 const isRMC = RMC_RANK_ORDER.includes(cadet.rank);
                 const syllabus = isRMC ? RMC_SYLLABUS : SCC_SYLLABUS;
                 const currentRankSyllabus = syllabus[cadet.rank];
                 if (!currentRankSyllabus) return { percentage: 0 };
                 let total = 0, passed = 0;
                 Object.values(currentRankSyllabus).forEach(cat => cat.forEach(m => {
                     total++;
                     if(qualsData.some(q => q.pNumber === cadet.pNumber && q.module.includes(m.code))) passed++;
                 }));
                 return { percentage: total === 0 ? 100 : Math.round((passed/total)*100) };
            };

            const NavItem = ({ id, icon, label }) => (
                <button onClick={() => setView(id)} className={`flex items-center gap-3 w-full p-3 rounded-lg transition-all ${view === id ? 'bg-blue-800 text-white' : 'text-blue-100 hover:bg-blue-800/50'}`}>
                    <Icon name={icon} className="w-5 h-5" />
                    {!sidebarCollapsed && <span>{label}</span>}
                </button>
            );

            if (view === 'upload' && personnelData.length === 0) {
                return (
                    <div className="min-h-screen flex flex-col items-center pt-5 pb-10">
                        <img src="media/ts_dashboard.webp" alt="TS Dashboard" className="w-[300px] h-auto mb-2 object-contain" />
                        <h1 className="text-4xl font-extrabold text-blue-900 mb-1">Sea Cadet Training Dashboard</h1>
                        <FileUploader onDataLoaded={handleDataLoaded} hasData={false} clearData={clearData} />
                        
                        {/* Disclaimer Section when no data loaded */}
                        <div className="mt-8 max-w-2xl text-center text-xs text-slate-400 p-4 border-t border-slate-200">
                            <p className="font-semibold mb-1">Disclaimer</p>
                            <p>This has been created independently of the MSSC and no warranty of offered or implied etc. Feature requests and bug fixes should be addressed to James Harbidge - jharbidge@mhseacadets.org</p>
                        </div>
                    </div>
                );
            }

            return (
                <ErrorBoundary>
                    <div className="min-h-screen bg-slate-100 flex font-sans text-slate-900">
                        <aside className={`${sidebarCollapsed ? 'w-20' : 'w-80'} bg-blue-900 text-white flex flex-col shadow-2xl fixed h-full z-10 transition-all duration-300`}>
                            <div className="p-6 border-b border-blue-800 flex flex-col items-center relative">
                                {!sidebarCollapsed && (
                                    <div className="flex flex-col items-center mb-2 w-full">
                                        <img src="media/ts_dashboard.webp" alt="TS Dashboard" className="object-contain w-[300px] h-auto mb-2" />
                                        <p className="text-xs text-blue-300 truncate font-semibold text-center w-full">{personnelData.length > 0 ? personnelData[0].unit : 'Unit Dashboard'}</p>
                                    </div>
                                )}
                                <button onClick={() => setSidebarCollapsed(!sidebarCollapsed)} title="Toggle Sidebar" className={`p-1 hover:bg-blue-800 rounded absolute top-4 right-4 ${sidebarCollapsed ? 'static mt-2' : ''}`}>
                                    <Icon name={sidebarCollapsed ? "ChevronRight" : "ChevronLeft"} className="w-5 h-5"/>
                                </button>
                            </div>
                            <nav className="flex-1 p-4 space-y-2 overflow-hidden">
                                <NavItem id="home" icon="Home" label="Home" /> {/* UPDATED ICON: Command -> Home */}
                                <NavItem id="cadet_focus" icon="User" label="Cadet Focus" />
                                <NavItem id="planner" icon="ShipWheel" label="SCC CTP Progress" />
                                <NavItem id="rmc_planner" icon="Target" label="RMC CTS Progress" />
                                <NavItem id="waterborne" icon="Anchor" label="Waterborne" />
                                <NavItem id="awards" icon="Award" label="Awards" />
                                <NavItem id="suggestions" icon="ChartGantt" label="Training Plan" />
                            </nav>
                            <div className="p-4 border-t border-blue-800">
                                <button onClick={clearData} className="flex items-center gap-2 text-xs text-blue-300 hover:text-white w-full">
                                    <Icon name="Trash2" className="w-4 h-4 flex-shrink-0"/> 
                                    {!sidebarCollapsed && <span>Reset Data</span>}
                                </button>
                            </div>
                        </aside>
                        <main className={`flex-1 ${sidebarCollapsed ? 'ml-20' : 'ml-80'} p-8 overflow-y-auto transition-all duration-300`}>
                            {view === 'home' && <HomeView personnel={personnelData} />} 
                            {view === 'cadet_focus' && <CadetFocus personnel={personnelData} qualsData={qualsData} />}
                            {view === 'awards' && <AwardsView personnel={personnelData} quals={qualsData} />}
                            {(view === 'waterborne') && <WaterborneView personnel={personnelData} qualsData={qualsData} />}
                            {(view === 'planner') && <TrainingPlanner personnel={personnelData} getCadetProgress={getCadetProgress} qualsData={qualsData} title="SCC CTP Progress" rankOrder={SCC_RANK_ORDER} syllabus={SCC_SYLLABUS} iconName="ShipWheel" onModuleClick={handleModuleDrillDown} />}
                            {(view === 'rmc_planner') && <TrainingPlanner personnel={personnelData} getCadetProgress={getCadetProgress} qualsData={qualsData} title="RMC CTS Progress" rankOrder={RMC_RANK_ORDER} syllabus={RMC_SYLLABUS} colorTheme="green" iconName="Target" onModuleClick={handleModuleDrillDown} />}
                            {(view === 'suggestions') && <TrainingSuggestions personnel={personnelData} getCadetProgress={getCadetProgress} qualsData={qualsData} />}
                        </main>
                    </div>
                    {/* Render the Drill Down Modal */}
                    <ModuleDrillDown info={drillDownInfo} onClose={() => setDrillDownInfo(null)} />
                </ErrorBoundary>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>